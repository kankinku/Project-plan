# MoltBot 아키텍처 및 코드 분석 보고서

이 보고서는 MoltBot의 폴더 구조를 전수 조사하여 각 컴포넌트의 역할을 정의하고, 단순히 "컴퓨터를 제어하는 코드" 외에 방대한 양의 보조 코드가 왜 필요한지를 분석합니다.

---

## 1. MoltBot 폴더 구조 전수 조사 (Comprehensive Survey)

MoltBot은 단순한 스크립트가 아니라, **게이트웨이(Gateway)**를 중심으로 한 분산 시스템 아키텍처를 가지고 있습니다.

### 1.1 최상위 디렉토리
*   **`apps/`**: 사용자가 MoltBot과 상호작용하는 클라이언트 애플리케이션들입니다.
    *   `android/`, `ios/`: 모바일 앱 (음성 인식, 캔버스 등).
    *   `macos/`: 맥 메뉴바 앱.
    *   `web/`: 웹 인터페이스.
*   **`src/`**: MoltBot의 핵심 로직이 담긴 소스 코드입니다. (상세 분석 참조)
*   **`skills/`**: MoltBot의 기능을 확장하는 스킬(플러그인)들입니다. (예: `1password`, `notion`, `linear` 등 외부 서비스 연동).
*   **`docs/`**: 문서화 파일들.
*   **`vendor/`**: 외부 의존성 라이브러리 (직접 관리하는 패키지들).

### 1.2 `src/` 내부 상세 구조
MoltBot의 코어(Core)는 다음과 같이 구성되어 있습니다.

| 폴더명 | 설명 및 역할 |
| :--- | :--- |
| **`gateway/`** | **중추 신경계 (Control Plane)**. 웹소켓 서버를 통해 클라이언트(앱), 에이전트, 툴 간의 메시지를 라우팅하고 세션을 관리합니다. |
| **`agents/`** | **두뇌 (Brain)**. LLM 에이전트 런타임이 이곳에 있습니다. <br> - `pi-embedded-runner`: 에이전트의 사고(Thinking) 및 실행 루프. <br> - `bash-tools.ts`: 터미널 제어 도구 구현 및 Docker 샌드박싱 로직. <br> - `pi-tools.ts`: 도구 정의 및 권한 정책 관리. |
| **`browser/`** | **브라우저 제어 시스템**. <br> - `server.ts`: CDP/Playwright를 관리하는 로컬 서버. <br> - `client-actions-core.ts`: 에이전트가 호출하는 브라우저 조작 클라이언트. |
| **`channels/`** | **입출력 인터페이스**. 다양한 메신저(WhatsApp, Slack, Telegram 등)의 API를 MoltBot의 내부 메시지 포맷으로 변환합니다. |
| **`infra/`** | **기반 시설**. <br> - `exec-approvals`: 위험한 명령어 실행 전 사용자 승인 로직. <br> - `node-shell`: Node.js 실행 환경 관리. |
| **`media/`** | 멀티모달 처리. 이미지, 오디오 파일 처리 파이프라인. |
| **`config/`** | 설정 로딩 및 유효성 검사 (`moltbot.json` 등). |
| **`sessions/`** | 대화 기록(Session Transcript) 저장 및 로딩. |

---

## 2. "터미널/브라우저 제어" 외에 다른 코드가 많이 필요한 이유

MoltBot이 단순히 "명령어를 실행해주는 스크립트"를 넘어 **"신뢰할 수 있는 개인 비서"**가 되기 위해 필요한 **4가지 핵심 요소**가 방대한 보조 코드의 존재 이유입니다.

### 2.1 안전성 (Safety & Security) - "폭주 방지"
AI가 터미널과 브라우저를 제어하는 것은 매우 강력하지만 위험합니다 (예: `rm -rf /` 실행). 이를 통제하기 위한 코드가 상당 부분을 차지합니다.
*   **샌드박싱 (Sandboxing)**: `src/agents/bash-tools.shared.ts` 등에서 **Docker 컨테이너**를 생성하고 관리하여, AI가 시스템 본체를 망가트리지 않고 격리된 환경에서 명령어를 실행하도록 합니다.
*   **승인 시스템 (Approvals)**: `src/infra/exec-approvals.ts`는 위험도가 높은 명령어 실행 시 사용자에게 "승인하시겠습니까?"라고 묻는 프로세스를 강제합니다.
*   **권한 정책 (Policies)**: `src/agents/pi-tools.policy.ts`는 어떤 툴을 사용할 수 있는지(Allowlist/Denylist)를 엄격하게 제어합니다.

### 2.2 신뢰성 (Reliability) - "항상 작동 보장"
LLM API는 불안정하고(Rate Limit), 연결은 끊길 수 있습니다. 비서는 24시간 안정적으로 동작해야 합니다.
*   **인증 프로필 로테이션 (Auth Rotation)**: `src/agents/auth-profiles.ts`는 하나의 API 키가 만료되거나 제한에 걸리면, 자동으로 백업 키나 다른 공급자(Provider)로 전환하여 서비스 중단을 막습니다.
*   **장애 복구 (Failover)**: 에러 발생 시 재시도 로직, 프로세스 재시작, 타임아웃 관리 등이 촘촘하게 짜여 있습니다.
*   **PTY 에뮬레이션**: 단순 `exec`이 아니라 `node-pty`를 사용하여, `vim`이나 `top` 같은 인터랙티브한 명령어까지도 깨지지 않고 처리하도록 터미널 환경을 모사합니다.

### 2.3 연결성 (Connectivity) - "어디서든 접근"
사용자는 PC 앞에서만 비서를 부르지 않습니다. 침대 위에서 폰으로, 이동 중에 워치로 명령을 내립니다.
*   **게이트웨이 아키텍처 (`src/gateway`)**: 모든 요청을 중앙에서 처리하여, 사용자가 Telegram으로 보낸 명령이 내 PC의 터미널을 제어하고, 그 결과가 다시 Telegram으로 전송되도록 합니다.
*   **채널 어댑터 (`src/channels`)**: Slack, Discord, WhatsApp 등 수십 가지의 서로 다른 API를 하나의 통일된 인터페이스로 추상화합니다.

### 2.4 확장성 (Extensibility) - "기능 확장"
*   **스킬 시스템 (`skills/`)**: 사용자가 새로운 기능을 추가하고 싶을 때 코어 코드를 수정하지 않고도 `skills` 폴더에 정의만 추가하면 AI가 새로운 도구를 배울 수 있게 합니다 (예: 집안 전등 끄기 등).
*   **브라우저 서버 분리**: 브라우저 제어를 별도의 서버(`src/browser/server.ts`)로 분리함으로써, 브라우저가 충돌해도 에이전트는 죽지 않고 재접속할 수 있습니다.

### 요약
MoltBot의 "방대한 코드"는 **단순한 실행(Execution)**을 **서비스(Service)**로 만들기 위한 비용입니다.
> **Core (제어)**: 10% (명령어 실행, 클릭)
> **Product (제품화)**: 90% (안전장치, 연결, 에러처리, 사용자 경험, 확장성)
