## Data & Feature System

- **문서 ID**: SYS-110
    
- **제목**: Data & Feature System
    
- **버전**: 1.0
    
- **목표**: 백테스트/라이브의 신뢰도를 좌우하는 데이터·피처·유니버스·스냅샷을 표준화하고, **재현성(OBS-530)** 과 **데이터 품질(DQ, OBS-540)** 을 시스템 레벨에서 보장한다.
    

---

## 1) 데이터 레이어(Stages)

1. **Raw Data**
    
    - OHLCV, (옵션) quote/spread proxy, corporate actions(분할/배당), 거래정지/상폐 이벤트
        
2. **Curated Data**
    
    - 캘린더 정렬, 타임존 정규화, 중복/결측 처리, corporate action 적용 정책 확정
        
3. **Feature Store**
    
    - RSI/Stoch/ADX/EMA/ATR 등 파생 지표 + 레짐/RS 같은 고수준 피처
        
4. **Snapshot/Manifest**
    
    - run 재현을 위한 데이터/피처/유니버스 버전 및 해시 기록(OBS-530)
        

---

## 2) 버전/스냅샷 정책(필수)

### 2.1 필수 버전 키

- `data_version`: 데이터 릴리즈 식별자(예: `data_v2026_02_01`)
    
- `integrity_hash`: 원천/정제 데이터 manifest 해시(파일 목록+크기+해시)
    
- `universe_version`: 유니버스 정의 버전(생존편향 방지 규칙 포함)
    
- `feature_version`: 피처 계산 코드/파라미터 버전(권장)
    

### 2.2 Snapshot 규칙(권장)

- run 시작 시점에 **Manifest**를 고정 저장:
    
    - 포함: 데이터 파일 목록, 스키마, feature key 목록, 캘린더/타임존
        
- Backtest는 가능한 한 “스냅샷 고정” 모드로 실행(나중에 데이터가 바뀌어도 결과 재현 가능)
    

---

## 3) 타임존/캘린더 규칙(Time Handling)

### 3.1 run 단위 고정

- `timezone`, `calendar`, `bar_interval`은 run 단위로 고정하고 **OBS-530**에 기록
    
- 모든 데이터는 내부 표준(UTC 권장)로 저장하되, 표시/슬라이스는 timezone 기준으로 수행 가능
    

### 3.2 바 정의(필수)

- bar의 timestamp 의미를 고정:
    
    - 권장: `bar_end_time`
        
- execution_timing이 `next_bar`인 경우:
    
    - “신호는 bar_end 기준, 체결은 next bar(open 등)”이 일관되게 적용되어야 함(OBS-540에서 체크)
        

---

## 4) 유니버스(Universe) 규칙(생존편향 방지)

### 4.1 as-of 유니버스(권장)

- 각 시점 t에서 거래 가능한 종목 집합은 “그 시점에 존재하던 종목”만 포함
    
- 상폐/합병/거래정지는 해당 기간에 반영
    

### 4.2 유니버스 버전 관리

- `universe_version`은
    
    - 생성 규칙(필터), 데이터 출처, as-of 정책을 포함한 문서/코드 버전으로 정의
        
- 변경 시 과거 결과 비교를 위해 버전을 올리고, 재계산 필요 여부를 명시
    

---

## 5) Corporate Actions 정책(필수 결정)

분할/배당 등은 수익률/지표에 큰 영향을 주므로 정책을 고정한다.

### 5.1 가격/수량 조정

- (권장) **adjusted price 기준**으로 시계열을 통일
    
- 다만 체결/슬리피지 모델은 “실제 호가 수준”이 필요할 수 있어:
    
    - adjusted vs raw를 분리 보관하는 옵션 권장
        
- 어떤 기준을 쓰는지는 calc_contract/OBS-530에 기록
    

### 5.2 이벤트 캘린더(옵션)

- 실적발표/중요 이벤트는 v2에서 반영 가능(현재는 확장 포인트로만)
    

---

## 6) Feature 계산 계약(Feature Contract)

### 6.1 Feature key 규칙

- SCHEMA-320/310과 정합되는 표준 key 사용(예: `rsi_14`, `ema_21`, `adx_14`)
    
- 파라미터가 다른 피처는 key로 명확히 구분(기간/스무딩 포함)
    

### 6.2 룩어헤드 없는 계산만 허용

- rolling/ema 계산은 과거 데이터만 사용
    
- 미래 바를 참조하는 계산은 금지(OBS-540 Lookahead 체크로 검출)
    

### 6.3 required_features 제공

- Backtester(MOD-420)는 strategy_spec에서 `required_features`를 산출
    
- Data 시스템은 그 feature들을 “일관된 방식”으로 제공해야 함
    
- 누락 시:
    
    - backtest 실패(`MISSING_FEATURE`) 또는 전략 후보 폐기(탐색 효율 최적화)
        

---

## 7) 결측/NaN 처리 정책

### 7.1 기본 정책(권장)

- 결측이 있는 bar에서는 거래 금지(`DISALLOW_TRADE`)
    
- 이유는 OBS-500 reason_codes에 `DATA_MISSING` 등으로 남김(로그 정책에 따라)
    

### 7.2 대체 정책(옵션)

- `fill_forward`는 신중히(지표에 왜곡 가능)
    
- 정책을 선택 see: SCHEMA-330 `NAN_POLICY` + OBS-530 기록
    

---

## 8) Data Quality Checks 연동(OBS-540)

Data 시스템은 run마다 최소 DQ 체크를 수행하고 결과를 OBS-540로 남긴다.

### 8.1 최소 체크 리스트(권장)

- **TIMEZONE/CALENDAR 정합성**
    
- **DUPLICATE_TS**: 중복 timestamp
    
- **MISSING_BARS**: 비정상 결측
    
- **LOOKAHEAD_CHECK**: 미래 참조 가능성
    
- **SURVIVORSHIP_CHECK**: 유니버스 as-of 위반
    
- **CORP_ACTION_SPIKE**: 분할/배당 미처리로 인한 스파이크
    
- **PRICE_SANITY**: 음수/0 가격, 비정상 점프
    
- **EXECUTION_TIMING_CHECK**: next_bar 정책 위반 가능성
    

### 8.2 stop 정책

- CRITICAL(룩어헤드/서바이버십 등) 발생 시:
    
    - 기본: run/iteration 중단(MOD-400에서 결정)
        

---

## 9) 예외/에러 처리

- `DATA_LOAD_FAIL`: 파일/DB 로드 실패
    
- `MISSING_FEATURE`: required feature 누락
    
- `DQ_FAIL_CRITICAL`: 치명적 DQ 실패
    
- `PARTIAL_UNIVERSE_DATA`: 일부 심볼만 데이터 결함(부분 성공 허용 여부는 정책)
    

---

## 10) 테스트 요구사항

- 룩어헤드 검출 테스트(TEST-631)
    
- 유니버스 as-of 정책 테스트(TEST-632)
    
- corporate action 미처리 스파이크 탐지(TEST-633)
    
- feature key 정합성 테스트(전략이 요구한 feature를 데이터가 제공)
    

---
