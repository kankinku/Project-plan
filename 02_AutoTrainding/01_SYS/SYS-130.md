## Security, Safety, Governance

- **문서 ID**: SYS-130
    
- **제목**: Security, Safety, Governance
    
- **버전**: 1.0
    
- **목표**: 완전 자동매매를 지향하되, 키/권한/운영 안전장치/감사 추적을 통해 “실수로 계좌가 터지는 시스템”을 방지하고, 실행/변경의 책임소재를 남길 수 있게 한다.
    

---

## 1) 비밀정보 관리(Secrets Management)

### 1.1 저장 원칙

- API Key/Secret, 토큰, 계좌번호는 **코드/로그/리포트에 절대 평문 저장 금지**
    
- 개발 환경:
    
    - OS Keychain 또는 `.env` + 로컬 암호화 파일(권장)
        
- 운영 환경:
    
    - secrets manager(가능하면) + 최소권한(least privilege)
        

### 1.2 마스킹 규칙(필수)

- 로그 출력 시:
    
    - 키/토큰: 앞 4~6글자만 남기고 마스킹
        
    - 계좌번호: 끝 2~4자리만 표시
        
- 마스킹 누락 방지를 위해 **정규식 기반 sanitizer**를 공통 로거에 둔다(TEST-670)
    

---

## 2) 권한 분리(RBAC / Mode Separation)

### 2.1 모드 정의

- `backtest`: 데이터 읽기/로컬 저장만
    
- `paper`: 주문 “요청” 가능(실거래 금지), 체결은 시뮬/페이퍼
    
- `live`: 실주문/실체결/실포지션 조회
    

### 2.2 모드 전환 가드(필수)

- 기본 모드는 `backtest`
    
- `paper/live`는 아래 조건 없으면 절대 실행 불가:
    
    - 명시적 enable 플래그
        
    - 환경 분리(별도 config/credential)
        
    - Risk Guard 활성(아래 3장)
        
- 런 메타(OBS-530)에 `mode` 기록 필수
    

---

## 3) 자동매매 안전장치(Safety Guards)

### 3.1 Risk Guard (핵심)

라이브(또는 페이퍼)에서 아래 트립 조건이 발생하면 즉시:

- 신규 주문 중단
    
- 기존 주문 취소(정책)
    
- 경고 이벤트 기록(OBS-530 + 운영 로그)
    

권장 트립 조건:

- **일 손실 한도**: `daily_loss <= -X%`
    
- **최대 DD 한도**: `drawdown <= -Y%`
    
- **연속 손실/연속 거절**: N회 연속 실패 시 중단
    
- **실행 품질 악화**: 슬리피지 p95/지연 p95가 임계 초과
    
- **데이터 이상**: DQ CRITICAL(룩어헤드/서바이버십은 live에선 즉시 중단)
    
- **인프라 이상**: 시간 동기 불일치, 네트워크 장애, 브로커 오류 폭증
    

> 구현 모듈: MOD-482(라이브), 백테스트에서는 MOD-422의 risk precheck로 유사한 정책 검증.

### 3.2 주문 제한(Execution Guard)

- 종목/일 단위 주문 횟수 제한
    
- 주문 수량 제한(ADV 참여율 상한)
    
- 스프레드 상한(너무 넓으면 거래 금지)
    
- 시장 급변(변동성 폭증) 시 거래 금지(옵션)
    

---

## 4) 주문 멱등성(Idempotency) & 중복 방지

### 4.1 client_order_id 규칙(필수)

- 모든 주문은 `client_order_id`를 가져야 함
    
- 권장 구성:
    
    - `run_id + iteration_id + strategy_id + symbol + side + decision_time + intent_hash`
        
- 동일 client_order_id로 재시도 시:
    
    - “중복 주문 생성”이 아니라 “상태 조회/갱신”으로 처리
        

### 4.2 OMS 재시도 정책(권장)

- 브로커 timeout/일시 오류는 재시도 가능
    
- 재시도는 멱등성 키로 보호
    
- 재시도 횟수/백오프는 OBS-530에 기록(운영 재현성)
    

---

## 5) 감사/거버넌스(Audit & Governance)

### 5.1 변경 추적(필수)

- 아래 항목 변경은 모두 버전/이력 기록:
    
    - 전략 템플릿/원자 규칙(MOD-413)
        
    - 제약(활성/비활성/만료)(MOD-452)
        
    - scoring 정책(MOD-431 policy_version)
        
    - cost/execution/portfolio 모델 버전(MOD-423~425)
        
- run마다 code/data/version을 OBS-530로 고정
    

### 5.2 실행 감사(필수)

- 라이브 실행은 다음 로그를 “영구 보관” 권장:
    
    - 주문/체결(OBS-510)
        
    - 포지션 변동(포트폴리오 스냅샷)
        
    - Risk Guard 트립 이벤트(운영 이벤트 로그)
        

---

## 6) LLM 사용 시 가드(사용하는 경우)

- LLM 출력은 **문자열 조건식**이 아니라 **AST(SCHEMA-310)** 로만 수용
    
- 허용 연산자/피처 whitelist
    
- validator 실패 시 즉시 폐기 + 기록(왜 폐기됐는지 reason_codes)
    

---

## 7) 테스트 요구사항

- **TEST-670**: secrets 마스킹 누락 탐지(로그 스캔)
    
- **TEST-671**: live 모드에서 Risk Guard 트립 시 주문 중단(신규 0건)
    
- **TEST-672**: 동일 client_order_id 재전송 시 중복 주문 0건
    
- **TEST-673**: 권한 분리(backtest에서 live 호출 차단)
    

---
