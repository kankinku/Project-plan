## Orchestrator (상태 정의/재시도/중단/분기)

- **문서 ID**: MOD-400
    
- **제목**: Orchestrator Specification (Run State Machine & Control Loop)
    
- **버전**: 1.0
    
- **목표**: 전략 생성→백테스트→스코어링→분석→제약 갱신→지식 축적을 **무한 반복(또는 예산 소진까지)** 하되, 실패 원인을 기록하고 제약으로 학습해 **탐색 공간을 점진적으로 줄이며** 성능/신뢰도를 올리는 전체 루프를 제어한다.
    
- **범위**: Run/Iteration 상태머신, 단계별 실행 순서, 재시도/백오프, 중단 조건, 분기(탐색/검증), 아티팩트/로그 연결.
    
- **비범위**: ID/해시 정책(=MOD-401), 각 모듈 내부 구현
    

---

## 1) Orchestrator 책임(Responsibilities)

1. **루프 제어**: iteration 단위로 파이프라인 실행 순서 보장
    
2. **상태 관리**: run/iteration 상태머신과 전이를 기록(MOD-460 runs/iterations)
    
3. **재시도/복구**: 일시 장애/타임아웃에 대한 재시도 정책 수행
    
4. **중단 조건**: 성과/예산/안전/품질에 따라 run 종료 또는 pause
    
5. **분기 전략**: 탐색(exploration) ↔ 검증(verification) 모드 전환
    
6. **산출물 연결**: metrics/score/report/failure/constraints/KB 저장 파이프 연결
    
7. **관측 가능성**: 각 단계의 입력/출력/시간/에러를 런 로그로 남김
    

---

## 2) Run/Iteration 상태(State)

### 2.1 RunState

- `RUN_CREATED`
    
- `RUNNING`
    
- `PAUSED`
    
- `DONE_SUCCESS`
    
- `DONE_BUDGET_EXHAUSTED`
    
- `DONE_EARLY_STOPPED`
    
- `FAILED_FATAL`
    

### 2.2 IterationState

- `ITER_CREATED`
    
- `GENERATION`
    
- `BACKTEST_A` (탐색)
    
- `BACKTEST_B` (검증)
    
- `SCORING`
    
- `ROBUSTNESS` (옵션/조건부)
    
- `REPORTING` (조건부)
    
- `ANALYSIS` (root-cause)
    
- `CONSTRAINT_UPDATE`
    
- `KB_PERSIST`
    
- `ITER_DONE`
    
- `ITER_FAILED` (recoverable/non-recoverable 구분)
    

각 전이는 반드시 (ts, duration, status, error_code)를 기록.

---

## 3) 입력/출력(Interface)

### 3.1 입력: `RunConfig`

```json
{
  "run_id": "uuid",
  "mode": "exploration|verification|mixed",
  "budgets": {
    "max_iterations": 200,
    "max_backtests": 5000,
    "max_walltime_sec": 86400
  },
  "data": {
    "asset_class": "equity|crypto",
    "universe_version": "v1",
    "period": { "start": "2015-01-01", "end": "2025-12-31" },
    "bar_interval": "1d"
  },
  "engines": {
    "exploration_engine": "A",
    "verification_engine": "B"
  },
  "policies": {
    "early_stop": { "patience_iters": 30, "min_improve": 0.02 },
    "retry": { "max_retries": 3, "base_backoff_sec": 2 },
    "promotion": { "top_k_to_verify": 20, "score_threshold": 70 }
  },
  "base_constraint_set_id": "cs_base",
  "scenario": { "enabled": true, "scenario_id": "optional" }
}
```

### 3.2 출력: `RunSummary`

```json
{
  "run_id": "uuid",
  "status": "DONE_SUCCESS",
  "best_strategies": [{ "strategy_id":"hash", "score_total": 82 }],
  "stats": { "iterations": 120, "backtests": 4800, "failures": 900, "constraints_added": 140 }
}
```

---

## 4) 기본 실행 순서(Iteration Pipeline)

### 4.1 공통 파이프라인(권장)

1. **GENERATION** (MOD-410~413, + MOD-451 제약 주입)
    
2. **BACKTEST_A** (MOD-421, 빠른 탐색)
    
3. **SCORING** (MOD-430/431)
    
4. **게이트/선정**
    
    - score 상위 또는 pass 전략만 다음 단계로
        
5. (조건부) **BACKTEST_B** (MOD-422, 더 현실적인 검증)
    
6. (조건부) **ROBUSTNESS** (MOD-432)
    
7. (조건부) **REPORTING** (MOD-433)
    
8. **ANALYSIS** (MOD-441/442 → MOD-440 레코드)
    
9. **CONSTRAINT_UPDATE** (MOD-450 → MOD-451 반영 대상 업데이트)
    
10. **KB_PERSIST** (MOD-460/461/462 업데이트)
    
11. ITER_DONE
    

> mixed 모드에서는 “탐색 N개 → 검증 topK” 배치 형태로 묶어도 됨.

---

## 5) 분기(Exploration vs Verification)

### 5.1 Exploration(A 엔진)

- 목적: 빠르게 많은 후보를 훑음
    
- 특징:
    
    - 차트/리포트 최소화
        
    - robustness는 기본 스킵(단, 특정 조건이면 수행)
        

### 5.2 Verification(B 엔진)

- 목적: 현실성/정합성 검증
    
- 트리거(예):
    
    - score_total >= threshold
        
    - pass=true
        
    - 다양성(서로 다른 전략군)을 확보하기 위해 cluster당 1개씩
        

---

## 6) 재시도/백오프(Retry Policy)

### 6.1 재시도 대상(Recoverable)

- 네트워크/일시 오류(데이터 로딩, 파일 I/O 잠깐 실패)
    
- 엔진 타임아웃(예산 내에서)
    

### 6.2 재시도 금지(Non-recoverable)

- 스키마 위반(전략 스펙/제약 스펙 invalid)
    
- 룩어헤드 CRITICAL 탐지(정책상 run 중단 또는 해당 전략 무효)
    

### 6.3 백오프

- exponential backoff: base * 2^k (cap)
    
- 재시도 기록:
    
    - `ITER_RETRY_SCHEDULED`, `ITER_RETRY_SUCCESS/FAIL`
        

---

## 7) 중단 조건(Stopping Conditions)

### 7.1 예산 기반

- max_iterations / max_backtests / max_walltime 도달
    

### 7.2 성과 기반(Early Stop)

- 최근 `patience_iters` 동안 최고 score 개선이 `min_improve` 미만
    
- 단, 제약이 막 생성된 직후(탐색 공간이 급변)는 patience 리셋 가능
    

### 7.3 안전/신뢰 기반

- DATA CRITICAL(LOOKAHEAD) 반복 발생률이 일정 수준 초과
    
- 엔진 비결정성(NON_DETERMINISTIC) 빈발
    
- 데이터 품질(DQ) 심각 경고가 지속
    

---

## 8) 다양성/중복 제거(Diversity Control)

Orchestrator는 “점수만”으로 뽑으면 유사 전략만 남는다.

권장:

- MOD-412 Normalizer Hash로 중복 제거
    
- Retriever(MOD-462)로 유사도 클러스터링 후:
    
    - cluster당 상위 1~M개만 verification으로 승격
        
- 다양성 메트릭:
    
    - feature 다양성, 템플릿 다양성, 파라미터 분산
        

---

## 9) 로그(Observability)

- Run Log(메타): OBS-530에 요약 저장
    
- 단계별 타이밍:
    
    - stage_start/end, duration_ms
        
- 결과 카운트:
    
    - generated_candidates, tested_A, promoted_to_B, failures_created, constraints_added
        
- 에러:
    
    - error_code, stacktrace_ref(선택), retry_count
        

---

## 10) 예외/에러 처리

- `BUDGET_EXCEEDED`: DONE_BUDGET_EXHAUSTED
    
- `FATAL_SCHEMA_ERROR`: FAILED_FATAL
    
- `DATA_CRITICAL_REPEATED`: DONE_EARLY_STOPPED(신뢰 문제로 중단)
    
- `STORAGE_WRITE_FAIL`: PAUSED 또는 FAILED_FATAL(정책)
    

---

## 11) 테스트 요구사항

1. 상태 전이가 정의된 순서로만 발생하는지
    
2. 재시도 가능한 에러는 재시도하고, 불가능은 즉시 실패 처리되는지
    
3. 탐색→검증 승격(topK/cluster)이 정책대로 동작하는지
    
4. 중복 전략이 Normalizer 해시로 제거되는지
    
5. early stop이 개선 없음에서 작동하고, 개선 시 리셋되는지
    
6. 모든 단계가 KB(MOD-460/461)에 연결되어 추적 가능한지
    

---
