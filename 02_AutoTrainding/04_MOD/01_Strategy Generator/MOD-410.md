## Strategy Generator (템플릿/원자 규칙/LLM 기반)

- **문서 ID**: MOD-410
    
- **제목**: Strategy Generator Specification
    
- **버전**: 1.0
    
- **목표**: 제약(Constraints)과 베이스라인 원칙을 만족하는 **전략 후보(Strategy DSL, SCHEMA-300)** 를 대량 생성하고, 중복/과복잡/비현실 후보를 조기에 걸러 **탐색 공간을 통제**한다.
    
- **범위**: backtest/paper/live 공통(생성 자체는 동일).
    
- **비범위**: 파라미터 샘플링의 세부 분포(=MOD-411), 정규화/해시/동치 제거(=MOD-412), 템플릿 저장소 승격 규칙(=MOD-413)
    

---

## 1) Generator 책임(Responsibilities)

1. **전략 후보 생성**: SCHEMA-300 형식의 Strategy DSL 생성
    
2. **생성 모드 지원**
    
    - 템플릿 기반(template)
        
    - 원자 규칙 조합(atomic rules)
        
    - LLM 기반(AST/DSL 생성) _(옵션, 안전 가드 필수)_
        
3. **제약 적용**: SCHEMA-330 ConstraintSet을 반영하여 금지/범위/복잡도/신호 밀도 정책 준수
    
4. **품질 게이트(사전 필터)**: 스키마 검증, 복잡도 제한, 최소 실행 가능성(DQ/룩어헤드 전 단계)
    
5. **생성 로그/통계**: iteration 단위로 “어떤 이유로 버려졌는지” 집계(탐색 축소 근거)
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `GenerateRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "seed": 12345,
  "budget": {
    "n_generate": 1000,
    "max_attempts": 5000
  },
  "modes": {
    "template": { "enabled": true, "weight": 0.5 },
    "atomic":   { "enabled": true, "weight": 0.4 },
    "llm":      { "enabled": false, "weight": 0.1 }
  },
  "baseline": {
    "strategy_family_allowlist": ["osc_mean_reversion", "trend_follow"],
    "default_bar_interval": "1d",
    "default_asset_class": "equity"
  },
  "constraint_set": { "constraint_set_id": "cs_01", "constraints": [] },
  "scenario_hints": []
}
```

### 2.2 출력: `GenerateResponse`

```json
{
  "candidates": [
    {
      "strategy_spec": { "... SCHEMA-300 ..." },
      "provenance": {
        "mode": "template|atomic|llm",
        "template_id": "optional",
        "atoms": ["optional"],
        "llm_prompt_hash": "optional"
      }
    }
  ],
  "stats": {
    "attempted": 1500,
    "generated": 1000,
    "rejected": 500,
    "rejection_breakdown": {
      "SCHEMA_INVALID": 120,
      "CONSTRAINT_VIOLATION": 180,
      "COMPLEXITY_TOO_HIGH": 90,
      "FEATURE_NOT_ALLOWED": 60,
      "SIGNAL_DENSITY_EXPECTED_BAD": 50
    }
  }
}
```

---

## 3) 내부 구성(High-level Components)

- **Mode Router**: mode 가중치에 따라 생성 루트를 선택
    
- **Template Expander**: 템플릿 + 파라미터 → 전략 DSL 생성
    
- **Atomic Composer**: 원자 규칙 블록을 조합하여 AST/DSL 생성
    
- **LLM Builder (optional)**: 자연어/지식 기반으로 AST 후보 생성 → 엄격한 validator 통과 필수
    
- **Constraint Filter**: 금지/범위/복잡도/허용 feature 적용
    
- **Pre-Validator**: SCHEMA-300/310 기본 검증, NaN 정책/룩어헤드 기본값 주입(가능하면)
    
- **Provenance Tagger**: 생성 출처/근거를 metadata에 기록
    

---

## 4) 생성 모드 상세

### 4.1 Template 기반

**개념**: 검증된 전략 “골격”을 템플릿으로 두고, 파라미터만 샘플링.

- 입력: `template_id`, 파라미터 샘플(=MOD-411)
    
- 출력: SCHEMA-300 DSL
    
- 장점: 안정적, 과복잡 방지
    
- 단점: 탐색 다양성 제한 → atomic/llm로 보완
    

**템플릿 최소 필드(권장)**

- family, required_features, entry_ast_skeleton, exit_ast_skeleton, risk defaults, execution defaults
    

---

### 4.2 Atomic Rules 기반(원자 규칙 조합)

**개념**: “원자 블록(atomic)”을 조합해 조건식을 만들고 DSL로 포장.

- 예시 atomic
    
    - `OSC_OVERSOLD`: rsi <= x
        
    - `STOCH_HIGH`: stoch >= y
        
    - `TREND_STACK`: ema8>ema21>ema55
        
    - `STRENGTH_ADX`: adx>=t
        
    - `DI_BULL`: di_plus > di_minus
        
    - `REGIME_RISK_ON`: regime_state == RISK_ON
        

**조합 규칙(권장)**

- entry = AND(필터/추세/강도/오실레이터 중 2~4개)
    
- exit = OR(트레일/스탑/반전 신호 중 1~3개)
    
- max_depth / cmp_count는 SCHEMA-310 규칙 준수
    

---

### 4.3 LLM 기반(옵션)

**개념**: 입력2(AST 라이브러리)가 없거나 부족할 때, LLM이 “조건식 후보”를 제안.

**필수 안전 가드**

- 출력은 반드시 **SCHEMA-310 AST**로만 받기(문자열 조건식 금지)
    
- validator 실패 시 폐기
    
- 허용 feature/연산자 whitelist 강제
    
- 복잡도 제한 강제
    
- provenance에 prompt_hash/모델버전 기록
    

---

## 5) 제약(Constraints) 적용 규칙 (SCHEMA-330 연동)

### 5.1 적용 순서(권장)

1. **하드 금지(BAN_*)**: template/feature/operator/패턴 금지
    
2. **화이트리스트(ALLOW_*)**: 허용 feature/operator 제한
    
3. **범위 제한(LIMIT_PARAM_RANGE)**: 파라미터 샘플링 범위 축소
    
4. **복잡도 제한(MAX_COMPLEXITY)**: AST depth/cmp_count 제한
    
5. **신호 밀도(MIN/MAX_SIGNAL_DENSITY)**: 생성 단계에서는 “예상치”로만 soft 체크(실제는 backtest에서 확정)
    

### 5.2 충돌 처리

- ConstraintSet의 `priority_policy`에 따름(보통 FAILSAFE_FIRST)
    
- generator scope 제약이 서로 충돌하면 `priority` 높은 제약 우선
    

---

## 6) 상태(State) & 라이프사이클

Generator는 내부적으로 다음 상태를 갖는다(디버그/관측용).

- `IDLE`
    
- `GENERATING`
    
- `FILTERING`
    
- `VALIDATING`
    
- `DONE`
    
- `FAILED`
    

각 상태 전이는 반드시 stats에 반영(어디서 병목/폐기되는지 확인용).

---

## 7) 로깅(Observability)

Generator는 OBS-500(바 단위 로그)는 생성하지 않지만, **Generator 자체 로그**는 남겨야 한다.

### 7.1 Generator Event Log(권장: internal)

레코드 예:

```json
{
  "run_id": "run_001",
  "iteration_id": 12,
  "event": "CANDIDATE_REJECTED",
  "mode": "atomic",
  "reason": "COMPLEXITY_TOO_HIGH",
  "details": { "ast_depth": 6, "cmp_count": 12 }
}
```

### 7.2 Strategy DSL metadata 필수 기록

SCHEMA-300 `metadata`에 provenance를 박는다.

- `created_by`: generator|llm|user
    
- `generator_version`
    
- `tags`
    
- `baseline_ref`
    
- (옵션) `template_id`, `atoms`, `constraint_set_id`
    

---

## 8) 예외/에러 처리

### 8.1 표준 에러 코드

- `SCHEMA_INVALID`: SCHEMA-300/310 validator 실패
    
- `CONSTRAINT_VIOLATION`: 제약 위반
    
- `RNG_ERROR`: seed/rng 문제
    
- `LLM_OUTPUT_INVALID`: LLM 출력이 AST 규격 불만족
    
- `BUDGET_EXHAUSTED`: max_attempts 초과
    

### 8.2 실패 시 동작

- 후보 단위 실패는 **폐기 + stats 증가** (run 전체 실패 아님)
    
- 반복적으로 동일 실패가 많으면:
    
    - Orchestrator가 다음 iteration에서 **제약/샘플링 정책 조정**(MOD-400/450에서)
        

---

## 9) 테스트 요구사항

### 9.1 단위 테스트

- (T1) constraint 적용: BAN_FEATURES 적용 시 해당 feature가 포함된 DSL 생성 금지
    
- (T2) 복잡도 제한: max_depth 초과 AST 폐기
    
- (T3) determinism: 동일 seed+inputs → 동일 후보 set(정규화 전까지 가능한 범위)
    
- (T4) SCHEMA 준수: output은 항상 SCHEMA-300 valid
    

### 9.2 통합 테스트(스모크)

- (I1) 1 iteration: n_generate=50 생성 → backtester로 1개라도 정상 수행
    
- (I2) llm enabled 시: invalid AST 출력이 와도 시스템이 안전하게 폐기
    

---

## 10) 산출물 체크리스트

- 생성된 모든 candidate는:
    
    - SCHEMA-300 valid
        
    - metadata에 provenance 포함
        
    - constraints 위반 없음(적용 가능한 범위에서)
        
    - SCHEMA-310 AST 참조 무결성 유지
        

---
