## Parameter Sampler (범위, 분포, 시드, 민감도 설정)

- **문서 ID**: MOD-411
    
- **제목**: Parameter Sampler Specification
    
- **버전**: 1.0
    
- **목표**: 전략 생성 시 필요한 임계값/기간/배수(예: RSI 임계, Stoch 임계, ADX 임계, EMA 기간, ATR 배수)를 **결정적(seed 기반)으로 샘플링**하고, 과최적화 방지를 위해 **범위 제한/분포/민감도 설정**을 제공한다.
    
- **범위**: MOD-410 Generator의 template/atomic/llm 모드에서 공통으로 사용되는 파라미터 샘플링.
    
- **비범위**: 생성된 전략의 동치 제거(=MOD-412), 템플릿 라이브러리 운영(=MOD-413)
    

---

## 1) Sampler 책임(Responsibilities)

1. **샘플링 스페이스 정의**: 파라미터 이름별 허용 범위/단위/타입
    
2. **분포 정의**: uniform/log-uniform/choice/triangular 등
    
3. **결정적 생성**: `(run_seed, iteration_id, candidate_index)`로 동일 샘플 재현
    
4. **제약 반영**: SCHEMA-330 `LIMIT_PARAM_RANGE`, `ALLOW/BAN` 류 제약을 적용
    
5. **민감도 설정 지원**: robustness 테스트(±Δ perturbation)용 델타 규칙 제공
    
6. **연관 파라미터 결합 규칙**: 예) EMA는 `fast < mid < slow` 유지
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `SampleRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "seed": 12345,
  "candidate_index": 77,
  "family": "osc_mean_reversion|trend_follow",
  "requested_params": ["rsi_period", "rsi_low", "stoch_k", "stoch_high", "adx_period", "adx_min", "atr_mult"],
  "constraints": { "constraint_set_id": "cs_01", "constraints": [] },
  "policy": {
    "prefer_round_numbers": true,
    "max_tries_for_constraints": 50
  }
}
```

### 2.2 출력: `SampleResponse`

```json
{
  "values": {
    "rsi_period": 14,
    "rsi_low": 30,
    "stoch_k": 14,
    "stoch_high": 80,
    "adx_period": 14,
    "adx_min": 20,
    "atr_mult": 3.0
  },
  "sensitivity": {
    "rsi_low": { "delta": 5, "min": 15, "max": 45 },
    "stoch_high": { "delta": 5, "min": 60, "max": 95 },
    "atr_mult": { "delta": 0.5, "min": 1.5, "max": 6.0 }
  },
  "provenance": {
    "rng_seed_used": 987654321,
    "constraints_applied": ["LIMIT_PARAM_RANGE:rsi_low", "MAX_COMPLEXITY"]
  }
}
```

---

## 3) 파라미터 카탈로그(Parameter Catalog)

Sampler는 “표준 파라미터 이름”을 사용한다. (Generator가 feature명과 매핑)

### 3.1 MVP 지원 파라미터(권장 기본)

#### 오실레이터

- `rsi_period` (int)
    
- `rsi_low` (int, 5~45)
    
- `rsi_high` (int, 55~95)
    
- `stoch_k` (int, 5~30)
    
- `stoch_d` (int, 2~10)
    
- `stoch_smooth` (int, 1~10)
    
- `stoch_low` (int, 5~40)
    
- `stoch_high` (int, 60~95)
    

#### 추세/강도

- `ema_fast` (int, 3~20)
    
- `ema_mid` (int, 10~50)
    
- `ema_slow` (int, 30~200)
    
- `adx_period` (int, 7~30)
    
- `adx_min` (int, 10~40)
    

#### 리스크

- `hard_stop_pct` (float, 0.01~0.20)
    
- `atr_period` (int, 7~30)
    
- `atr_mult` (float, 1.0~8.0)
    
- `take_profit_pct` (float, 0.02~0.50) _(옵션)_
    

#### 유니버스/실행

- `min_avg_vol_60` (int)
    
- `max_spread_bps` (int)
    
- `max_adv_participation` (float)
    

---

## 4) 분포(Distribution) 정의

각 파라미터별 기본 분포를 고정한다.

### 4.1 기본 분포 표(권장)

- `rsi_period`: choice {7, 10, 14, 21}
    
- `rsi_low`: choice {20, 25, 30, 35, 40} (mean reversion)
    
- `rsi_high`: choice {60, 65, 70, 75, 80}
    
- `stoch_high`: choice {75, 80, 85, 90}
    
- `adx_min`: choice {15, 20, 25, 30}
    
- `ema_fast/mid/slow`: discrete uniform + 관계 제약
    
- `atr_mult`: uniform step 0.5 in [1.5, 6.0]
    
- `hard_stop_pct`: uniform step 0.01 in [0.03, 0.15] _(초기 권장)_
    

> “임계값 기반 전략”은 민감도에 취약하므로 **연속 uniform보다 step choice**를 권장(과최적화 완화).

---

## 5) 결정적 RNG(Determinism)

Sampler는 run-level seed에서 후보별 seed를 파생한다.

### 5.1 seed derivation

```text
rng_seed_used = hash_to_int(run_seed || iteration_id || candidate_index || "SAMPLER")
```

- hash는 SHA-256 → int 변환(32-bit 또는 64-bit)
    
- RNG 알고리즘은 OBS-530에 기록한 `pcg64` 등과 일치
    

---

## 6) 제약(Constraints) 반영 규칙

Sampler는 generator scope 제약과 일부 execution/risk 제약을 반영할 수 있다.

### 6.1 적용 대상

- `LIMIT_PARAM_RANGE`: (param min/max 갱신)
    
- `BAN_TEMPLATE`는 sampler 대상 아님(Generator 라우팅)
    
- `ALLOW_FEATURES_ONLY/BAN_FEATURES`: feature 매핑 단계에서 샘플링 자체를 스킵하거나 파라미터 생성 금지
    
- `STOP_DISTANCE_MIN_MAX`: `atr_mult`/`hard_stop_pct` 범위를 간접 제한
    

### 6.2 적용 순서(권장)

1. 기본 카탈로그 범위 설정
    
2. constraints로 범위/choice를 좁힘
    
3. 관계 제약 적용(ema_fast < ema_mid < ema_slow 등)
    
4. 최종 샘플
    
5. constraints 위반 재검증 → 위반 시 재샘플(max_tries)
    

---

## 7) 관계 제약(Relational Constraints)

샘플 값들 사이의 논리적 관계를 유지한다.

### 7.1 EMA 체계

- `ema_fast < ema_mid < ema_slow`
    
- 최소 간격 권장:
    
    - `ema_mid - ema_fast >= 5`
        
    - `ema_slow - ema_mid >= 10`
        

### 7.2 오실레이터 임계

- `rsi_low < rsi_high`
    
- `stoch_low < stoch_high`
    
- mean reversion 가족에서는:
    
    - `rsi_low <= 40`, `stoch_high >= 70` 같은 가족별 가이드 가능(정책)
        

### 7.3 스탑/트레일 일관성(권장)

- 하드스탑이 트레일보다 “재난 방지로 더 넓거나/독립”이 되도록
    
- 예: `hard_stop_pct >= atr_mult * atr_pct_median` 는 런타임 값 필요 → 여기선 범위 제한만 수행(정밀 검증은 Backtest 후)
    

---

## 8) 민감도 설정(Sensitivity Spec)

임계값/배수 파라미터는 robustness에서 ±Δ 흔들림을 평가한다.

### 8.1 기본 delta 규칙(권장)

- `rsi_low`, `rsi_high`: Δ=5
    
- `stoch_low`, `stoch_high`: Δ=5
    
- `adx_min`: Δ=5
    
- `atr_mult`: Δ=0.5
    
- `hard_stop_pct`: Δ=0.01
    
- 기간 파라미터(ema/rsi/adx/atr period): Δ=±2 또는 choice 인접값
    

### 8.2 출력 형태

`SampleResponse.sensitivity[param] = {delta, min, max}`  
(robustness 모듈이 이 규격으로 파라미터 흔들기 수행)

---

## 9) 로깅/관측(Observability)

Sampler는 후보마다 provenance를 남긴다(Generator stats로 집계).

### 9.1 필수 기록

- `rng_seed_used`
    
- `constraints_applied` 리스트
    
- 재샘플 횟수(`resample_count`)
    
- 실패 시 reason:
    
    - `CONSTRAINT_UNSATISFIABLE`
        
    - `RELATION_VIOLATION`
        

---

## 10) 예외/에러 처리

### 10.1 표준 에러

- `CONSTRAINT_UNSATISFIABLE`: max_tries 초과
    
- `UNKNOWN_PARAM`: 카탈로그에 없는 파라미터 요청
    
- `RANGE_INVALID`: min>max 등 범위 오류(정책/제약 입력 문제)
    

### 10.2 동작

- 후보 단위 실패는 **candidate 폐기** + Generator rejection stats 증가
    
- 반복적으로 unsatisfiable이면:
    
    - Orchestrator가 constraint lifecycle에서 완화/검토(=MOD-452)
        

---

## 11) 테스트 요구사항

### 11.1 단위 테스트

- 동일 (run_seed, iteration_id, candidate_index) → 동일 샘플
    
- LIMIT_PARAM_RANGE 적용 시 범위 밖 값이 나오지 않음
    
- EMA 관계 제약 항상 유지
    
- sensitivity delta가 min/max를 넘지 않음(클램프)
    

### 11.2 통합 테스트

- Generator(template/atomic)에서 sampler 출력이 SCHEMA-300 features/conditions에 정상 반영
    
- constraints 강화 시 rejection 증가가 통계로 관측됨
    

---
