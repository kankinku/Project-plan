## Rule Template Library (부트스트랩 저장/승격 규칙)

- **문서 ID**: MOD-413
    
- **제목**: Rule Template Library Specification
    
- **버전**: 1.0
    
- **목표**: 생성기(MOD-410)가 사용하는 전략 템플릿/원자 규칙을 **로컬 지식(4번)** 으로 축적하고, 성과/강건성/실행가능성 기준으로 **승격(promote)·강등(demote)·폐기(deprecate)** 하는 운영 규칙을 정의한다.
    
- **범위**: 템플릿/원자 규칙 저장소 구조, 메타데이터, 승격 로직, 버전 관리, 검색/추천 인터페이스.
    
- **비범위**: 템플릿을 실제로 생성하는 알고리즘(=MOD-410) / 샘플링(=MOD-411) / 정규화(=MOD-412)
    

---

## 1) 라이브러리 책임(Responsibilities)

1. **템플릿/원자 규칙 저장**: SCHEMA-300/310 기반 “골격”과 파라미터 슬롯 정의
    
2. **성과 기반 큐레이션**: backtest 결과(SCHEMA-340)와 robustness(MOD-432)로 템플릿의 신뢰도를 갱신
    
3. **승격/강등/폐기**: “성공 패턴”은 탐색 우선순위를 올리고, 실패 패턴은 탐색 공간에서 제외
    
4. **검색/추천**: 유사 전략/유사 실패 기반으로 재사용 가능한 템플릿을 추천(=MOD-462 연동)
    
5. **버전 관리**: 템플릿/원자 규칙의 변경 이력을 남겨 재현성을 보장
    

---

## 2) 개념 정의

- **Template**: 전략의 “골격”(entry/exit/risk/execution/universe 포함) + 파라미터 슬롯
    
- **Atomic Rule**: 조건식(AST)의 “원자 블록”(CMP/AND/OR의 소규모 조합)
    
- **Promotion**: 템플릿을 “우선 사용/기본 후보”로 승격
    
- **Deprecation**: 템플릿을 더 이상 생성에 사용하지 않음(기록은 유지)
    

---

## 3) 저장 구조(Storage Layout, 권장)

```
kb/
  templates/
    templates.jsonl
    atoms.jsonl
    promotions.jsonl
    stats/
      template_stats.parquet (optional)
  snapshots/
    template_library_vYYYYMMDD.json
```

- 정형 DB(=MOD-460)에도 인덱싱 테이블을 둔다:
    
    - `template_registry`
        
    - `atom_registry`
        
    - `template_performance_history`
        

---

## 4) Template 스키마(저장 오브젝트)

```json
{
  "template_id": "tmpl_trend_ema_adx_v3",
  "schema_version": "1.0",
  "version": 3,
  "status": "ACTIVE|DEPRECATED|EXPERIMENTAL",

  "family": "trend_follow|osc_mean_reversion",
  "description": "EMA 정배열 + ADX + DI + (옵션) RSI/Stoch 필터",

  "dsl_skeleton": {
    "strategy": { "...SCHEMA-300 skeleton with param slots..." },
    "param_slots": [
      { "name": "adx_min", "type": "int", "default": 20, "range": [10, 35], "step": 5 },
      { "name": "rsi_low", "type": "int", "default": 30, "range": [20, 40], "step": 5 },
      { "name": "atr_mult", "type": "float", "default": 3.0, "range": [1.5, 6.0], "step": 0.5 }
    ]
  },

  "requirements": {
    "required_features": ["ema_8", "ema_21", "ema_55", "adx_14", "di_plus_14", "di_minus_14"],
    "optional_features": ["rsi_14", "stoch_k_14_3_3"],
    "asset_classes": ["equity"],
    "bar_intervals": ["1d"]
  },

  "constraints_hint": {
    "max_ast_depth": 4,
    "max_cmp_count": 8
  },

  "quality": {
    "tier": "CANDIDATE|VERIFIED|CORE",
    "confidence": 0.55,
    "last_evaluated_at": "2026-02-06T00:00:00Z"
  },

  "provenance": {
    "source": "bootstrap|human|llm|import",
    "source_ref": "optional",
    "created_at": "2026-02-01T00:00:00Z"
  }
}
```

### 4.1 필수 필드

- `template_id`, `version`, `status`, `family`, `dsl_skeleton`, `requirements`, `quality.tier`
    

---

## 5) Atomic Rule 스키마(저장 오브젝트)

```json
{
  "atom_id": "atom_rsi_oversold_v1",
  "schema_version": "1.0",
  "version": 1,
  "status": "ACTIVE|DEPRECATED",

  "type": "ENTRY|EXIT|FILTER",
  "description": "RSI <= rsi_low",

  "ast_skeleton": {
    "type": "CMP",
    "left": "rsi_14",
    "op": "<=",
    "right": "{{rsi_low}}",
    "reason_code": "RSI_OVERSOLD"
  },

  "param_slots": [
    { "name": "rsi_low", "type": "int", "default": 30, "range": [20, 40], "step": 5 }
  ],

  "requirements": {
    "required_features": ["rsi_14"],
    "bar_intervals": ["1d"]
  },

  "quality": {
    "usage_count": 1200,
    "win_rate_hint": 0.0,
    "confidence": 0.40
  }
}
```

---

## 6) 템플릿 성과/강건성 기록(Performance History)

템플릿/원자규칙은 단일 run 성과로 평가하지 않고 “히스토리”로 누적한다.

```json
{
  "template_id": "tmpl_trend_ema_adx_v3",
  "as_of": "2026-02-06T00:00:00Z",
  "evaluations": [
    {
      "run_id": "run_001",
      "period": { "start": "2015-01-01", "end": "2025-12-31" },
      "metrics_ref": "strategies.metrics_json",
      "key_metrics": {
        "oos_sharpe_net": 0.45,
        "max_drawdown_net": -0.18,
        "param_sensitivity_score": 0.62,
        "costs_total": 0.06
      },
      "score_total": 0.71,
      "passed": true
    }
  ]
}
```

---

## 7) 승격/강등/폐기 정책(Promotion Policy)

### 7.1 Tier 정의

- `CANDIDATE`: 신규/탐색용(기본)
    
- `VERIFIED`: 검증 단계(BACKTEST_B)에서 기준 통과
    
- `CORE`: 반복적으로 OOS/강건성 통과(“기본 전략군”)
    

### 7.2 승격 조건(권장 기본)

**CANDIDATE → VERIFIED**

- `oos_sharpe_net >= 0.30`
    
- `max_drawdown_net >= -0.25`
    
- `oos_is_performance_ratio >= 0.40`
    
- `param_sensitivity_score >= 0.50`
    
- `costs_total <= 0.10`
    
- DQ FAIL 없음(OBS-540)
    

**VERIFIED → CORE**

- 서로 다른 기간/레짐 slice에서 3회 이상 통과(예: 워크포워드 3개 구간)
    
- 평균 `oos_sharpe_net >= 0.45`
    
- tail risk 지표(예: `tail_loss_p95`) 악화가 임계 이하
    

### 7.3 강등 조건(권장)

- 최근 N회 검증에서 연속 실패(예: 5회 중 4회 FAIL)
    
- `Execution Failure` 반복(슬리피지 p95 급증 등)
    
- `param_sensitivity_score < 0.30` (임계값 민감도 과다)
    

### 7.4 폐기(Deprecate)

- 룩어헤드/데이터 오류 패턴이 템플릿에 구조적으로 내재
    
- 현실 체결 불가능(ADV/스프레드) 조건이 필수로 들어간 템플릿
    

---

## 8) Generator와의 연동(Usage API)

Generator는 템플릿을 “가중치 기반”으로 샘플링한다.

### 8.1 템플릿 선택 점수(권장)

```text
template_sampling_weight =
  base_weight(tier) *
  clamp(confidence, 0.1..2.0) *
  (1 + recent_pass_rate_bonus) *
  (1 - deprecation_penalty)
```

- tier별 base_weight 예:
    
    - CORE=3.0, VERIFIED=2.0, CANDIDATE=1.0
        

### 8.2 추천 질의(예)

- “최근 실패 태그가 Execution Failure인 전략과 유사한 템플릿 제외”
    
- “RISK_OFF 구간 성능이 좋은 템플릿 우선”
    

---

## 9) 버전 관리(Versioning)

- 템플릿/원자규칙 변경 시:
    
    - `version` 증가
        
    - 이전 버전은 immutable 유지(재현성)
        
- `template_id`는 **stable id + version** 조합을 권장
    
    - 예: `tmpl_trend_ema_adx` + `version=3`
        

---

## 10) 로깅/관측(Observability)

- 승격/강등 이벤트는 별도 이벤트 로그로 남김:
    

```json
{
  "event": "TEMPLATE_PROMOTED",
  "template_id": "tmpl_trend_ema_adx_v3",
  "from": "VERIFIED",
  "to": "CORE",
  "reason": "3x WFA passes",
  "as_of": "2026-02-06T00:00:00Z",
  "evidence": { "avg_oos_sharpe": 0.52, "param_sensitivity_score": 0.61 }
}
```

---

## 11) 예외/에러 처리

- `TEMPLATE_INVALID_SCHEMA`: skeleton이 SCHEMA-300/310 위반 → status=DEPRECATED + 관리자 검토 큐
    
- `MISSING_REQUIRED_FEATURES`: 데이터/피처 파이프라인과 불일치 → EXPERIMENTAL로 강등
    

---

## 12) 테스트 요구사항

- 템플릿 skeleton이 항상 SCHEMA-300 valid (param slot 치환 후에도)
    
- 동일 template+sampler seed → 동일 전략 생성(결정성)
    
- 승격 조건 회귀 테스트(임계치 변경 시 영향 분석 리포트)
    

---
