## Backtester 공통 인터페이스(엔진 추상화)

- **문서 ID**: MOD-420
    
- **제목**: Backtester Common Interface Specification
    
- **버전**: 1.0
    
- **목표**: 탐색용(vectorized)과 검증용(event-driven) 등 서로 다른 백테스트 엔진을 **동일 인터페이스로 실행**하고, 결과를 **SCHEMA-340 + OBS-500/510/520** 표준으로 산출한다.
    
- **범위**: 엔진 추상화, 입력/출력 계약, 로그 생성 정책, 룩어헤드 방지 기본 규칙, 실패 처리.
    
- **비범위**: 엔진별 구현 상세(MOD-421/422), 비용/체결/포트폴리오 모델 상세(MOD-423~425)
    

---

## 1) Backtester 책임(Responsibilities)

1. **전략 실행**: SCHEMA-300 전략을 주어진 데이터/모델(비용/체결/포트폴리오)로 시뮬레이션
    
2. **표준 결과 산출**
    
    - `metrics_json` (SCHEMA-340)
        
    - `decision_logs` (OBS-500, 정책에 따라 full/partial)
        
    - `order_fill_logs` (OBS-510)
        
    - `trade_summaries` (OBS-520)
        
3. **정책 강제**
    
    - 룩어헤드 방지: 기본 `execution_timing=next_bar`
        
    - 결측/NaN 정책: `DISALLOW_TRADE` 기본(=SCHEMA-310/330)
        
4. **엔진 교체 가능**: 동일 입력 → 동일 결과(가능 범위 내), 최소한 동일 “해석 가능” 출력
    
5. **성능/스케일**: 수백~수천 전략을 batch로 처리(탐색 모드)
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `BacktestRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "engine_mode": "A|B",
  "engine": { "name": "vectorized|event_driven", "version": "x.y.z" },

  "strategy_id": "hash",
  "strategy_spec": { "...SCHEMA-300..." },

  "data_ref": {
    "data_version": "data_v2026_02_01",
    "universe_version": "u_v3",
    "period": { "start": "2015-01-01", "end": "2025-12-31" },
    "bar_interval": "1d",
    "timezone": "America/New_York",
    "calendar": "NYSE"
  },

  "models": {
    "cost_model": { "id": "cost_v1", "params": {} },
    "execution_model": { "id": "exec_v1", "params": { "execution_timing": "next_bar" } },
    "portfolio_model": { "id": "pf_v1", "params": { "initial_cash": 100000 } }
  },

  "constraints": { "constraint_set_id": "cs_01", "constraints": [] },

  "log_policy": {
    "decision_log": "none|entry_exit_only|full",
    "order_fill_log": "none|full",
    "trade_summary": "full",
    "sample_symbols": null
  },

  "calc_contract": {
    "returns_type": "simple",
    "include_fees": true,
    "include_slippage": true,
    "include_spread": true,
    "execution_timing": "next_bar",
    "risk_free_rate_annual": 0.02,
    "annualization_factor": 252
  }
}
```

### 2.2 출력: `BacktestResponse`

```json
{
  "status": "SUCCESS|FAILED|PARTIAL",
  "strategy_id": "hash",

  "metrics_json": { "...SCHEMA-340..." },

  "artifacts_ref": {
    "decision_logs_path": "optional",
    "order_fill_logs_path": "optional",
    "trade_summaries_path": "optional"
  },

  "summary": {
    "trade_count": 420,
    "return_total_net": 0.52,
    "max_drawdown_net": -0.22
  },

  "errors": []
}
```

---

## 3) 엔진 추상화(Engine Adapter)

Backtester는 내부적으로 `EngineAdapter` 인터페이스를 가진다.

### 3.1 EngineAdapter 필수 메서드(개념)

- `prepare_data(data_ref, required_features) -> DataBundle`
    
- `run(strategy_spec, data_bundle, models, log_policy) -> RawRunOutput`
    
- `to_metrics(raw_output, calc_contract) -> metrics_json(SCHEMA-340)`
    
- `to_logs(raw_output, log_policy) -> (OBS-500, OBS-510, OBS-520)`
    

> MOD-421/422는 이 인터페이스를 구현한다.

---

## 4) 데이터/피처 계약(Data & Features Contract)

### 4.1 required_features 산출

- strategy_spec의 모든 AST에서 참조하는 FeatureRef를 수집(=MOD-412 산출 가능)
    
- `required_features`가 데이터 번들에 없으면:
    
    - `status=FAILED`
        
    - error code: `MISSING_FEATURE`
        

### 4.2 결측/NaN 정책

- SCHEMA-330 `NAN_POLICY`가 있으면 우선 적용
    
- 없으면 기본 `DISALLOW_TRADE` + reason_code `DATA_MISSING`
    
- NaN이 발생하면:
    
    - 해당 바에서 `entry_allowed=false` 처리
        
    - OBS-500에 `errors` 또는 reason_code로 기록(정책에 따라)
        

---

## 5) 룩어헤드 방지 기본 규칙(필수)

### 5.1 execution_timing

- 기본: `next_bar`
    
- `same_bar` 체결은 기본 금지(옵션으로만 허용, 그리고 OBS-540에서 WARN/FAIL)
    

### 5.2 신호 시점 vs 체결 시점

- 신호 계산: bar t 종가 기준 가능
    
- 체결: bar t+1 시가(또는 모델 가격) 기준
    
- 이 규칙은 SCHEMA-340 `calc_contract.execution_timing`과 반드시 일치해야 함
    

---

## 6) 모델 주입(Models Injection)

Backtester는 모델을 “플러그인”처럼 주입받아 사용한다.

- Cost Model: MOD-423
    
- Execution Model: MOD-424
    
- Portfolio Model: MOD-425
    

모델 버전/파라미터는 **OBS-530 run metadata**에도 기록되어야 한다.

---

## 7) 로그 생성 정책(Log Policy)

전략 수가 많을 때 로그 폭발을 막기 위해 정책을 표준화한다.

### 7.1 권장 기본

- 탐색(Engine A):
    
    - decision_log: `entry_exit_only`
        
    - order_fill_log: `full` 또는 `none`(성능에 따라)
        
    - trade_summary: `full`
        
- 검증(Engine B):
    
    - decision_log: `full`
        
    - order_fill_log: `full`
        
    - trade_summary: `full`
        

### 7.2 entry_exit_only 정의

- OBS-500을 `module_name in {entry, exit, execution_gate}`만 기록
    
- 나머지는 metrics와 trade_summary에서 커버
    

---

## 8) 실패/부분 성공 처리

### 8.1 status 의미

- `SUCCESS`: 전체 기간/유니버스 정상 완료
    
- `PARTIAL`: 일부 심볼/기간만 성공(예: 특정 심볼 데이터 오류)
    
- `FAILED`: 실행 불가(데이터/스키마/엔진 크래시)
    

### 8.2 PARTIAL 처리(권장)

- 심볼별 실패 목록을 `errors[].details.symbols_failed`로 제공
    
- metrics_json에는 `data_coverage` 같은 메타(옵션)로 반영
    
- Orchestrator는 PARTIAL 전략을 shortlist에서 제외하거나 페널티 부여(Scorer에서)
    

---

## 9) 예외/에러 코드 표준

- `MISSING_FEATURE`
    
- `DATA_LOAD_FAIL`
    
- `ENGINE_CRASH`
    
- `VALIDATION_FAIL`
    
- `LOOKAHEAD_POLICY_VIOLATION`
    
- `OUT_OF_MEMORY`
    
- `TIMEOUT`
    

에러 포맷:

```json
{ "code": "MISSING_FEATURE", "message": "feature rsi_14 missing", "details": { "feature": "rsi_14" } }
```

---

## 10) 테스트 요구사항

### 10.1 단위 테스트

- 동일 입력(데이터 스냅샷/seed/모델) → 동일 metrics_json(허용 오차 정책)
    
- execution_timing=next_bar 준수(동일 바 체결이 나오면 FAIL)
    
- NaN 정책이 entry/exit 신호에 반영되는지
    

### 10.2 통합 테스트

- Engine A와 Engine B가 동일 전략에 대해 “해석 가능한 수준”으로 유사한 결과를 내는지(완전 동일은 아닐 수 있음)
    
- OBS-500/510/520 산출이 스키마 validator 통과
    

---

## 11) 다음 문서 연결

- MOD-421: Backtest Engine A(탐색: vectorized)
    
- MOD-422: Backtest Engine B(검증: event-driven)
    
- MOD-423: Cost Model
    
- MOD-424: Execution Model
    
- MOD-425: Portfolio Model
    

---
