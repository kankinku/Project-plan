## Backtest Engine A (탐색: Vectorized)

- **문서 ID**: MOD-421
    
- **제목**: Backtest Engine A (Vectorized Exploration Engine)
    
- **버전**: 1.0
    
- **목표**: 수백~수천 개 전략 후보를 빠르게 탐색하기 위해, 시계열 연산을 **벡터화(vectorized)** 하여 대량 백테스트를 수행하고, 결과를 **SCHEMA-340 + OBS-510/520(필수) + OBS-500(정책)** 로 산출한다.
    
- **범위**: 탐색 단계(BACKTEST_A) 전용 엔진 설계/제약/지원 범위.
    
- **비범위**: 검증용 event-driven 엔진(MOD-422), 비용/체결/포트폴리오 모델 상세(MOD-423~425)
    

---

## 1) 엔진 A 설계 철학(Trade-off)

- **빠름**: 대량 후보를 빠르게 “랭킹”하기 위한 엔진
    
- **근사/제한 허용**: 복잡한 주문/체결/스탑 동작은 제한하거나 근사
    
- **검증은 엔진 B에서**: 엔진 A는 shortlist 후보를 뽑는 용도(최종 신뢰는 B)
    

---

## 2) 입력/출력(Interface)

MOD-420 `BacktestRequest/Response`를 그대로 따른다.  
Engine A 전용으로 권장되는 설정:

### 2.1 권장 log_policy (탐색)

- `decision_log: entry_exit_only` _(기본)_
    
- `order_fill_log: none 또는 full(성능 여유 시)`
    
- `trade_summary: full` _(필수 권장)_
    

---

## 3) 지원 범위(Supported Strategy Subset)

### 3.1 지원하는 것(기본)

- **신호**: SCHEMA-310 AST의 `CMP/AND/OR/NOT/IN/BETWEEN`
    
- **체결 타이밍**: `execution_timing = next_bar` 고정(룩어헤드 방지)
    
- **포지션**: LONG 중심(초기), SHORT는 옵션
    
- **사이징**: equal-weight / fixed-fraction / 간단한 score-based weight
    
- **비용**: 단순 수수료 + 슬리피지/스프레드 근사(모델 주입 가능)
    

### 3.2 제한/근사하는 것(탐색 단계에서 허용)

- **고급 체결**: IOC/FOK/부분체결/호가두께 기반 체결 → 기본 미지원(또는 근사)
    
- **복잡한 스탑/트레일**: 바 안(intrabar) 체결/갭 처리 정밀 모델 → 제한
    
- **정교한 포트폴리오 최적화**: 상관/리스크 패리티 등 → 탐색에서는 단순화
    

### 3.3 “지원 불가” 처리 정책

전략이 Engine A에서 지원하지 않는 기능을 요구하면:

- 기본: `status=FAILED` + `error code=UNSUPPORTED_FEATURE`
    
- 옵션(degrade): 해당 기능을 **비활성/단순화**하고 `WARN` 태그 부여
    
    - 단, shortlist로 올릴 때는 Engine B에서 반드시 재검증
        

---

## 4) 내부 구조(High-level Components)

1. **Feature Cache Manager**
    
    - required_features를 키로 피처 배열을 캐시
        
    - 같은 피처셋을 쓰는 전략은 재사용
        
2. **AST Vector Evaluator**
    
    - AST를 numpy/pandas boolean mask로 평가
        
3. **Signal Builder**
    
    - entry/exit masks 생성
        
    - 실행 타이밍(next_bar) 시프트 적용
        
4. **Position Simulator (Vector)**
    
    - 포지션 시계열 생성(진입/청산)
        
5. **Cost/Execution Approx**
    
    - 간단한 비용/슬리피지 적용(모델 주입)
        
6. **Outputs Builder**
    
    - trades(OBS-520), orders/fills(OBS-510 근사), metrics(SCHEMA-340)
        
    - decision log(OBS-500, entry/exit 중심)
        

---

## 5) 데이터 & 피처 처리

### 5.1 데이터 번들(DataBundle)

- 최소: `open/high/low/close/volume` (OHLCV) + `features{key -> series}`
    
- 심볼 다중일 경우:
    
    - (권장) `panel` 형태: time x symbol 매트릭스
        

### 5.2 결측/NaN 정책

- SCHEMA-330 `NAN_POLICY` 우선
    
- 기본: `DISALLOW_TRADE`
    
    - 신호 mask 계산 시 NaN 포함 bar는 entry/exit를 False로 처리
        
    - 필요한 경우 OBS-500 entry에서 `DATA_MISSING` reason 기록(정책에 따라)
        

---

## 6) AST 벡터 평가 규칙

### 6.1 CMP 평가

- `left/right`를 시계열로 해석(FeatureRef/SystemVar)
    
- 연산자 비교 → boolean series 생성
    

### 6.2 AND/OR/NOT

- boolean series를 벡터 연산으로 결합
    
- `full_eval` 모드는 기본 OFF(탐색에서 성능 우선)
    
    - 이유코드 필요 시(선택된 후보만) full_eval 가능
        

---

## 7) 체결 타이밍(next_bar) 적용(룩어헤드 방지)

- 시점 t에서 신호 생성 → **체결은 t+1**
    
- 구현 규칙:
    
    - `entry_signal[t]`가 True이면 `entry_exec[t+1]`로 시프트
        
    - `exit_signal[t]`도 동일하게 t+1 적용(정책 고정)
        
- 이 규칙은 SCHEMA-340 `calc_contract.execution_timing`과 일치해야 함
    

---

## 8) 포지션 시뮬레이션(탐색용 Vector Rules)

탐색 엔진에서는 포지션 규칙을 단순화한다(일관성이 더 중요).

### 8.1 기본(1단 포지션)

- `position[t] ∈ {0, 1}` (LONG 보유 여부)
    
- entry_exec 발생 시 0→1
    
- exit_exec 발생 시 1→0
    

### 8.2 멀티 포지션(포트폴리오)

- 목표 보유 종목수 `max_positions` 내에서:
    
    - entry 후보 중 ranking/score 상위부터 채움
        
- 사이징:
    
    - 기본 equal weight: `1/N`
        
    - 제약: `MAX_POSITION_WEIGHT`, `SECTOR_CAP` 등을 단순 규칙으로 적용(정교한 최적화는 B에서)
        

---

## 9) Exit 근사 정책(Engine A에서의 지원)

Engine A는 exit를 “벡터화 가능한 형태”로 제한하는 게 안정적이다.

### 9.1 권장 지원(벡터화 가능)

- **시간 종료(Time stop)**: 보유 N bars 후 청산
    
- **신호 기반 exit**: exit AST가 True면 청산(next_bar)
    
- **간단 TP/SL(일봉 기준)**:
    
    - TP: close 기준 수익률 >= tp_pct
        
    - SL: close 기준 손실률 <= -stop_pct
        
    - _(intrabar high/low를 사용하면 근사 오류가 늘 수 있으므로 정책으로 선택)_
        

### 9.2 제한 또는 “B에서만”

- ATR trailing stop(바 내 고저/갭 포함) 정밀 구현
    
- 부분익절/분할청산을 정확히 모사
    
- 주문 타입별 체결(지정가, 스탑리밋 등)의 정밀 체결
    

> 전략이 위 기능을 필수로 요구하면 Engine A는 `UNSUPPORTED_FEATURE` 또는 `DEGRADED_EXIT_MODEL`로 표기.

---

## 10) Order/Fill 로그(OBS-510) 생성 정책(탐색용)

Engine A는 실제 브로커 체결이 아닌 **시뮬 체결**이므로, 아래처럼 단순 기록한다.

### 10.1 기본 옵션

- `order_fill_log = none` (속도 최우선)
    
- shortlist 후보만 `full`로 기록 가능(옵션)
    

### 10.2 기록 시 규칙

- entry/exit마다 1개의 주문 생성(시장가 가정)
    
- fill은 1회 체결로 기록
    
- `decision_price`는 신호 기준 가격(보통 close[t])
    
- `fill_price`는 체결 기준(보통 open[t+1] 또는 모델가)
    
- slippage/spread는 MOD-423/424의 근사 모델로 산출하여 `estimated_*`에 기록
    

---

## 11) Trade Summary(OBS-520) 생성(필수 권장)

Engine A는 trade_summary를 항상 만들 수 있어야 한다.

- entry/exit 시점, 가격, reason_codes(가능한 범위), MFE/MAE(정책에 따라 close 기반/고저 기반)
    
- 비용 분해(가능하면):
    
    - fees/spread/slippage 추정치
        

---

## 12) Metrics(SCHEMA-340) 생성

- Engine A는 최소 MVP 지표를 항상 산출:
    
    - return_total_net, cagr_net, vol, max_dd, sharpe, turnover, costs_total, trade_count, win_rate 등
        
- `calc_contract`는 BacktestRequest에서 받은 것을 그대로 기록(중요)
    

---

## 13) 상태(State) & 캐시 정책

### 13.1 엔진 상태

- `COLD`: 캐시 없음
    
- `WARM`: 동일 data_ref + 피처 캐시 존재
    
- `EVICTING`: 메모리 압박으로 캐시 축출
    

### 13.2 캐시 키

- `(data_version, universe_version, period, bar_interval, required_features_set_hash)`
    

### 13.3 캐시 축출

- LRU 기본
    
- 메모리 상한 초과 시 required_features_set 단위로 제거
    

---

## 14) 예외/에러 처리

### 14.1 표준 에러 코드

- `UNSUPPORTED_FEATURE`
    
- `MISSING_FEATURE`
    
- `DATA_LOAD_FAIL`
    
- `OUT_OF_MEMORY`
    
- `NUMERICAL_ERROR`
    
- `TIMEOUT`
    

### 14.2 동작

- 전략 단위 실패는 `BacktestResponse.status=FAILED`로 반환
    
- Orchestrator는 해당 전략을 shortlist에서 제외(또는 페널티)
    

---

## 15) 테스트 요구사항

### 15.1 정확성(Consistency) 테스트

- 동일 전략을 Engine A/B로 실행 시:
    
    - 핵심 방향성(수익/낙폭/거래수)이 큰 폭으로 어긋나지 않는지(허용오차 정책)
        
- execution_timing=next_bar가 지켜지는지(동일 바 체결 0건)
    

### 15.2 성능 테스트

- n=1000 전략, m=500 심볼, T=2500 bars에서:
    
    - 목표 처리량(예: 전략당 평균 처리시간) 기준을 설정하고 회귀 검증
        

### 15.3 결정성(Determinism)

- 동일 data snapshot + seed + config → 동일 metrics_json(허용오차 내)
    

---

## 16) 다음 문서 연결

- **MOD-422**: Backtest Engine B(검증: event-driven)
    
- **MOD-423**: Cost Model
    
- **MOD-424**: Execution Model
    
- **MOD-425**: Portfolio Model
    

