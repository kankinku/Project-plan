## Backtest Engine B (검증: Event-driven)

- **문서 ID**: MOD-422
    
- **제목**: Backtest Engine B (Event-driven Verification Engine)
    
- **버전**: 1.0
    
- **목표**: 탐색 엔진 A에서 뽑힌 shortlist 전략을 **현실에 가깝게(체결/지연/제약/스탑/부분체결)** 검증하여, 성과를 “신뢰 가능한 수준”으로 확정하고 **OBS-500/510/520 + SCHEMA-340**를 풀 스펙으로 생성한다.
    
- **범위**: 검증 단계(BACKTEST_B) 전용 엔진 설계, 이벤트 루프, 주문/체결 시뮬레이션, 포트폴리오 상태 업데이트, 로그 생성.
    
- **비범위**: 비용/체결/포트폴리오 모델 세부 수식(=MOD-423~425), 스코어링(=MOD-431)
    

---

## 1) 엔진 B 설계 철학

- **정확/현실성 우선**: 속도보다 “정밀한 재현”
    
- **관측 가능성 우선**: 결정/주문/체결/트레이드를 모두 남김(OBS 풀 기록 권장)
    
- **정책 준수 우선**: 룩어헤드 방지, 제약(Constraints) 적용, 리스크 가드 준수
    

---

## 2) 입력/출력(Interface)

MOD-420의 `BacktestRequest/Response`를 그대로 사용한다.

### 2.1 권장 log_policy (검증)

- `decision_log: full`
    
- `order_fill_log: full`
    
- `trade_summary: full`
    

---

## 3) 이벤트 루프(Event Loop)

### 3.1 시간 진행

- 바 단위(예: 1d)로 time index를 순회
    
- 각 time t에 대해 아래 순서로 처리
    

### 3.2 처리 순서(권장 표준)

1. **DATA_EVENT(t)**: 데이터/피처 준비, 결측 점검(필요 시 OBS-540 참조)
    
2. **REGIME_EVAL(t)**: 레짐 판단(OBS-500 module=regime)
    
3. **UNIVERSE/LIQ_GATE(t)**: 유동성/거래가능 필터(OBS-500 module=liquidity_gate)
    
4. **SELECTION(t)**: RS/랭킹/선정(OBS-500 module=selection)
    
5. **RISK/PF_PRECHECK(t)**: 노출/섹터/상관/손실한도 체크(OBS-500 module=portfolio)
    
6. **ENTRY/EXIT_SIGNAL(t)**: 진입/청산 조건 평가(OBS-500 module=entry/exit)
    
7. **ORDER_INTENT_BUILD(t)**: 주문 의도 생성(OBS-500 module=execution_gate)
    
8. **EXECUTION_SIM(t → t+Δ)**: 주문 전송, 지연, 체결, 부분체결(OBS-510)
    
9. **PORTFOLIO_UPDATE(t)**: 체결 반영, 현금/포지션 갱신
    
10. **TRADE_SUMMARY_UPDATE**: 트레이드 오픈/종료 관리(OBS-520)
    

> 핵심: “결정(Decision)”과 “체결(Fill)”을 분리해, 슬리피지/지연/거절을 원인으로 남길 수 있어야 한다.

---

## 4) 지원 기능 범위(Engine B는 ‘풀 기능’ 지향)

### 4.1 체결/주문

- 주문 타입: MKT/LMT/STP/STP_LMT (정책으로 허용 목록 제한 가능)
    
- TIF: DAY/GTC/IOC/FOK (IOC/FOK는 옵션)
    
- 부분체결: 지원(OBS-510 fills 다건)
    
- 취소/만료: 지원(status 변화 기록)
    

### 4.2 리스크/청산

- 하드 스탑: 지원(갭 포함 정책)
    
- ATR 트레일링 스탑: 지원(바 기반)
    
- 시간 스탑: 지원
    
- 분할익절/부분청산: 지원(legs 기록, OBS-520)
    

### 4.3 포트폴리오

- 현금/포지션/레버리지/마진(초기 단순 → 확장)
    
- 섹터 캡/포지션 캡/상관 제한(제약 기반)
    

---

## 5) 상태 모델(State Model)

### 5.1 필수 상태

- `PortfolioState`
    
    - cash, equity, gross_exposure, net_exposure
        
    - positions: {symbol -> PositionState}
        
    - risk_state: daily_loss, drawdown, etc
        
- `OrderState`
    
    - pending_orders, open_orders, filled_orders
        
- `TradeState`
    
    - open_trades, closed_trades
        

### 5.2 PositionState(권장 최소)

- qty, avg_price
    
- unrealized_pnl, realized_pnl
    
- stop_level, trail_level
    
- last_update_time
    

---

## 6) Constraints 적용 지점(핵심)

Engine B는 제약을 실제로 “집행”해야 한다.

### 6.1 적용 포인트

- `data` scope: 룩어헤드/결측 정책 강제
    
- `portfolio` scope: max positions, sector cap, leverage limit
    
- `execution` scope: spread cap, ADV participation cap, order type allowlist, latency guard
    
- `risk` scope: max daily loss, max drawdown, stop distance min/max
    

### 6.2 제약 위반 시 동작

- 주문 생성 전(execution_gate)에서 위반 발견:
    
    - `order_allowed=false`
        
    - OBS-500 reason_codes에 위반 코드 기록(예: `EXEC_SPREAD_TOO_WIDE`)
        
    - OBS-510은 생성하지 않음(주문 자체가 없으므로)
        

---

## 7) 체결 시뮬레이션(Execution Simulation)

체결 로직은 MOD-424 Execution Model을 호출한다. Engine B는 “오케스트레이션”만 담당.

### 7.1 필수 입력(ExecutionModel로 전달)

- order_intent (side/qty/type/price)
    
- current bar OHLCV (+ 가능하면 spread proxy)
    
- liquidity stats(ADV, RVOL)
    
- constraints(ADV cap, spread cap)
    
- latency/jitter params
    

### 7.2 필수 출력

- order status 변화(NEW→SENT→PARTIAL/FILLED/REJECTED)
    
- fills[] (시간/수량/가격)
    
- reject reason(있는 경우)
    

### 7.3 지연(latency)

- `decision_time`과 `sent_at`, `first_fill_at` 간 차이를 OBS-510 `latency_ms`로 기록
    
- backtest에서도 “가상 지연”을 설정해 execution failure를 유도/검증 가능
    

---

## 8) Exit 우선순위(충돌 규칙)

동일 바에서 여러 exit 조건이 동시에 True일 수 있다. 우선순위를 고정해야 재현 가능.

### 8.1 권장 우선순위

1. `RISK_GUARD`(일손실 한도 등)
    
2. `HARD_STOP_HIT`
    
3. `TRAIL_HIT`
    
4. `TP_HIT`
    
5. `REGIME_OFF_EXIT`
    
6. `SIGNAL_EXIT`(일반 조건식)
    

우선순위 결정은 OBS-500/520 reason_codes에 반드시 반영.

---

## 9) 로깅(Observability) 규칙(필수)

### 9.1 OBS-500 (Decision Log) — full

- module: regime/liquidity_gate/selection/entry/exit/portfolio/execution_gate
    
- 각 모듈에서 `features_snapshot + reason_codes` 반드시 기록
    

### 9.2 OBS-510 (Order & Fill) — full

- 주문 생성 시 Order 레코드 1개
    
- 부분체결 시 Fill 레코드 N개
    
- reject/cancel도 반드시 기록(상태 변화 포함)
    

### 9.3 OBS-520 (Trade Summary) — full

- 트레이드 종료 시점에 1개 레코드 확정
    
- 분할익절/부분청산은 legs로 기록 권장
    

---

## 10) 엔진 B 산출물 정합성(Validation)

- `pnl.net = gross - fees - spread - slippage` 일관성
    
- trade 수량 합 = fills 수량 합
    
- 포지션 state_after = (state_before + fills) 정합성
    
- 실행 타이밍 정책 준수(OBS-540 EXECUTION_TIMING_CHECK와 연결)
    

---

## 11) 예외/에러 처리

### 11.1 표준 에러 코드

- `ENGINE_CRASH`
    
- `DATA_MISSING_CRITICAL`
    
- `MODEL_ERROR_COST`
    
- `MODEL_ERROR_EXECUTION`
    
- `PORTFOLIO_STATE_CORRUPT`
    
- `TIMEOUT`
    

### 11.2 복구 정책(권장)

- 데이터 결측이 특정 심볼에 국한 → 해당 심볼만 스킵(PARTIAL) + DQ WARN
    
- 포트폴리오 상태 불일치 → CRITICAL, run 중단(재현성/신뢰성 붕괴)
    

---

## 12) 테스트 요구사항

### 12.1 단위 테스트

- 동일 시나리오에서 exit 우선순위가 항상 동일하게 적용
    
- 부분체결 시 fills 합계가 주문 수량과 일치
    
- ADV cap 위반 시 주문이 생성되지 않고 reason_codes가 남음
    
- 룩어헤드 방지: same-bar fill이 발생하지 않음(정책상)
    

### 12.2 통합 테스트

- Engine A shortlist 전략을 Engine B로 검증했을 때:
    
    - 일부는 score 하락/실패가 발생(현실 비용/체결 반영)
        
    - 실패 사유가 OBS-500/510/520로 재현 가능하게 남음
        
- Replay 테스트(OBS-483 연동): 로그 기반으로 동일 결과 재현
    

---

## 13) 다음 문서 연결

- **MOD-423** Cost Model(수수료/슬리피지/스프레드)
    
- **MOD-424** Execution Model(체결 규칙, 지연, ADV 제한)
    
- **MOD-425** Portfolio Model(포지션/현금/레버리지/마진)
    

