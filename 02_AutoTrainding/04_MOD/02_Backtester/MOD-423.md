## Cost Model (수수료/슬리피지/스프레드)

- **문서 ID**: MOD-423
    
- **제목**: Cost Model Specification (Fees / Slippage / Spread)
    
- **버전**: 1.0
    
- **목표**: 백테스트/라이브에서 거래 비용을 **분해 가능한 형태(수수료·슬리피지·스프레드)** 로 일관되게 적용하고, OBS-510/520 및 SCHEMA-340에 동일한 의미로 기록한다.
    
- **범위**: 비용 모델의 입력/출력 계약, 비용 계산 규칙, 로그 필드 매핑, 정책(보수/중립/낙관).
    
- **비범위**: 체결 자체의 규칙(=MOD-424 Execution Model), 포트폴리오 상태/마진(=MOD-425)
    

---

## 1) Cost Model 책임(Responsibilities)

1. **거래 비용 산출**: 각 fill 또는 trade에 대해 fees/spread/slippage 비용을 산출
    
2. **일관된 분해**: `fees`, `estimated_spread_cost`, `estimated_slippage_cost`를 분리
    
3. **계약 준수**: SCHEMA-340 `calc_contract.include_*`와 일치하도록 비용 포함/제외
    
4. **엔진 중립**: Engine A/B에서 동일 인터페이스로 호출 가능
    
5. **보수성 프로필**: 낙관/중립/보수 가정(테스트/운영 프로필)을 명시적으로 선택 가능
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `CostRequest`

```json
{
  "run_id": "uuid",
  "strategy_id": "hash",
  "symbol": "AAPL",
  "side": "BUY|SELL",
  "qty": 100,
  "fill_price": 101.12,
  "decision_price": 101.00,
  "bar_interval": "1d",

  "market_context": {
    "spread_bps": 3.0,
    "adv_shares": 5000000,
    "dollar_vol": 500000000,
    "volatility_bps": 120
  },

  "profile": "optimistic|neutral|conservative",
  "params": {
    "fee_model": { "type": "per_share|bps", "value": 0.0005, "min_fee": 0.0 },
    "spread_model": { "type": "half_spread", "use_spread_bps": true, "fallback_bps": 5.0 },
    "slippage_model": { "type": "bps_linear", "base_bps": 2.0, "impact_k": 0.0 }
  }
}
```

### 2.2 출력: `CostResponse`

```json
{
  "fees": 0.35,
  "estimated_spread_cost": 0.20,
  "estimated_slippage_cost": 0.12,
  "total_cost": 0.67,

  "components": {
    "fee_bps": 0.35,
    "spread_bps_effective": 3.0,
    "slippage_bps_effective": 1.2
  },

  "reason_codes": ["COST_OK"],
  "warnings": []
}
```

---

## 3) 비용 컴포넌트 정의(정확히 고정)

### 3.1 Fees (수수료)

- 브로커/거래소 수수료, 커미션, 거래세(자산군에 따라)
    
- 기본 모델(권장):
    
    - per_share: `fees = qty * fee_per_share + min_fee`
        
    - bps: `fees = notional * fee_bps / 10000`
        

### 3.2 Spread Cost (스프레드 비용)

- 시장가/유동성 소모로 발생하는 “호가 스프레드” 비용 근사
    
- 기본: half-spread 가정(권장)
    
    - `spread_cost = notional * (spread_bps / 10000) * 0.5`
        
- spread_bps가 없으면 fallback 사용
    

### 3.3 Slippage Cost (슬리피지 비용)

- decision_price 대비 불리하게 체결된 “추가 비용”
    
- OBS-510에서 정의한 슬리피지(불리하면 +)를 비용으로 변환:
    
    - `slippage_cost = qty * abs(fill_price - decision_price)` _(불리 방향 정규화된 경우)_
        
- 또는 bps 모델로 추정:
    
    - `slippage_cost = notional * slippage_bps_effective / 10000`
        

> 권장: **실제 fill이 있으면 “실제 가격 기반 슬리피지”를 우선**하고, 없으면 bps 추정 모델 사용.

---

## 4) profile(보수성) 정책

같은 파라미터라도 프로필에 따라 비용을 상향/하향 조정 가능.

### 4.1 권장 스케일링

- optimistic: slippage/spread * 0.7
    
- neutral: * 1.0
    
- conservative: * 1.3
    

(정확한 값은 운영 경험으로 조정 가능. 중요한 건 “프로필을 기록”하는 것)

---

## 5) calc_contract와의 연동(SCHEMA-340)

Backtester는 `calc_contract.include_*`에 따라 비용을 반영한다.

- `include_fees=false` → fees=0 (또는 기록은 하되 net 계산에서 제외)
    
- `include_spread=false` → spread_cost=0
    
- `include_slippage=false` → slippage_cost=0
    

**원칙**: 로그에는 계산된 비용을 남기되, metrics의 net 반영 여부는 calc_contract로 결정.

---

## 6) OBS 필드 매핑(필수)

### 6.1 OBS-510 Fill 레코드

- `fees` ← CostResponse.fees
    
- `estimated_spread_cost` ← spread_cost
    
- `estimated_slippage_cost` ← slippage_cost
    

### 6.2 OBS-520 Trade Summary

- entry/exit legs 비용 합산 또는 trade-level 합산:
    
    - `pnl.fees`, `pnl.estimated_spread_cost`, `pnl.estimated_slippage_cost`
        

### 6.3 SCHEMA-340 Metrics

- `fees_total`, `spread_total`, `slippage_total`, `costs_total`
    
- 추가로 p95 등 품질 지표는 Execution/Fill 로그에서 집계(MOD-430)
    

---

## 7) 데이터 요구사항 & fallback 정책

### 7.1 입력 데이터가 없을 때

- `spread_bps` 없음 → `fallback_bps` 사용 + warning `COST_SPREAD_FALLBACK`
    
- ADV 없음 → impact 모델 생략 + warning `COST_IMPACT_SKIPPED`
    

### 7.2 자산군별 확장(향후)

- 코인: maker/taker fee, funding, taker spread 강화
    
- 선물: 슬리피지/롤오버/증거금 비용
    

(확장은 버전업으로 관리: `cost_model_version`)

---

## 8) 예외/에러 처리

- `INVALID_NOTIONAL`: price<=0 또는 qty<=0
    
- `MISSING_DECISION_PRICE`: 실제 슬리피지 계산 불가 → 추정모델로 전환 + WARN
    
- `PARAMS_INVALID`: bps<0 등
    

에러 포맷:

```json
{ "code": "INVALID_NOTIONAL", "message": "qty must be >0", "details": { "qty": 0 } }
```

---

## 9) 테스트 요구사항

### 9.1 단위 테스트

- per_share fee 계산 정확성
    
- half-spread 계산 정확성
    
- 슬리피지(불리 방향 정규화) → 비용 변환 정확성
    
- profile scaling 적용 여부
    

### 9.2 통합 테스트

- Engine B에서 fills 생성 → CostModel 적용 → OBS-510/520 합산 → SCHEMA-340 비용 총합 정합성
    

---

## 10) 다음 문서 연결

- **MOD-424** Execution Model(체결 규칙/지연/ADV 제한)
    
- **MOD-430** Metrics Calculator(비용 집계)
    
- **OBS-510/520** 비용 필드의 근거
    

---
