## Execution Model (체결 규칙, 지연, ADV 제한)

- **문서 ID**: MOD-424
    
- **제목**: Execution Model Specification (Fill Rules / Latency / Liquidity Constraints)
    
- **버전**: 1.0
    
- **목표**: 백테스트/페이퍼/라이브에서 주문이 **언제/어떻게/얼마나 체결되는지**를 일관된 규칙으로 시뮬레이션(또는 추정)하고, 실행 실패(거절/부분체결/슬리피지/지연)를 OBS-510로 증거화한다.
    
- **범위**: 주문 의도(order intent) → 주문 상태 변화 → fills 생성, 제약(ADV/스프레드/주문타입) 집행, 지연 모델링, 실행 품질 메트릭 산출.
    
- **비범위**: 비용 계산 자체(MOD-423), 포트폴리오/리스크 업데이트(MOD-425), 전략 신호 생성(MOD-410~)
    

---

## 1) Execution Model 책임(Responsibilities)

1. **주문 검증 & 거절**: 제약 위반 시 주문 생성 자체를 막거나(REJECT) 실행 불가 사유를 남김
    
2. **지연 모델**: decision_time → sent_at → fill_time(들) 생성
    
3. **체결 규칙**: 주문 타입별(MKT/LMT/STP/…) 체결 조건/가격 결정
    
4. **부분체결/취소/만료**: 시장 유동성(ADV, RVOL, 스프레드) 기반으로 부분 체결 및 상태 전이
    
5. **관측 출력**: OBS-510(주문/체결) 및 실행 품질(슬리피지/부분체결/거절율) 집계 근거 제공
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `ExecuteRequest`

```json
{
  "run_id": "uuid",
  "strategy_id": "hash",

  "order_intent": {
    "symbol": "AAPL",
    "side": "BUY|SELL",
    "qty": 100,
    "order_type": "MKT|LMT|STP|STP_LMT",
    "time_in_force": "DAY|GTC|IOC|FOK",
    "decision_time": "2026-02-06T00:00:00Z",
    "decision_price": 101.00,
    "limit_price": null,
    "stop_price": null
  },

  "market": {
    "bar_time": "2026-02-06T00:00:00Z",
    "ohlc": { "open": 101.10, "high": 102.00, "low": 100.50, "close": 101.40 },
    "volume": 5000000,
    "spread_bps": 3.0,
    "adv_shares_60": 7000000,
    "rvol": 1.1
  },

  "constraints": {
    "order_type_allowlist": ["MKT", "LMT"],
    "max_spread_bps": 10,
    "max_adv_participation": 0.01,
    "latency_guard_ms": 5000
  },

  "latency_model": {
    "base_ms": 800,
    "jitter_ms": 600,
    "tail_ms_p99": 3000
  },

  "fill_model": {
    "execution_timing": "next_bar",
    "partial_fill": true,
    "max_fill_steps": 3,
    "price_model": "open_next|vwap|mid_plus_slip",
    "volume_participation": { "cap": 0.01 }
  }
}
```

### 2.2 출력: `ExecuteResponse`

```json
{
  "order_record": { "...OBS-510 Order..." },
  "fill_records": [{ "...OBS-510 Fill..." }],

  "execution_quality": {
    "slippage_bps": 12.0,
    "partial_fill": false,
    "latency_ms": 2100
  },

  "status": "FILLED|PARTIAL|REJECTED|CANCELLED|EXPIRED",
  "reason_codes": ["EXEC_OK"],
  "reject": null,
  "warnings": []
}
```

---

## 3) 제약 집행(Pre-Trade Validation)

Execution Model은 주문 생성 전에 아래를 검사한다.

### 3.1 Order Type Allowlist

- allowlist에 없으면 `REJECTED`
    
- reason: `EXEC_ORDER_TYPE_BLOCKED`
    

### 3.2 Spread Cap

- `spread_bps > max_spread_bps`면 `REJECTED`
    
- reason: `EXEC_SPREAD_TOO_WIDE`
    
- reject.details에 실제/허용 스프레드 기록
    

### 3.3 ADV Participation Cap

- `qty > adv_shares_60 * max_adv_participation`이면:
    
    - 기본 정책 A(보수): `REJECTED` (`EXEC_ADV_CAP`)
        
    - 옵션 정책 B(현실): qty를 cap으로 **자동 축소(reduce_size)** + WARN
        
- 정책은 constraints 또는 execution config로 고정해야 함(재현성)
    

### 3.4 Latency Guard(실시간/시뮬)

- 예측 지연이 guard를 초과하면:
    
    - `REJECTED` 또는 `reduce_size` 또는 `halt` (정책)
        

---

## 4) 지연 모델(Latency Model)

### 4.1 시간 필드 생성

- `sent_at = decision_time + sampled_latency_send`
    
- `first_fill_at = sent_at + sampled_latency_fill`
    
- `fill_time_i`는 부분체결 단계마다 증가
    

### 4.2 결정성

- latency 샘플링은 run/iteration/strategy/order_intent 기반 파생 seed로 고정(=MOD-401)
    
- 동일 입력이면 동일 latency 재현 가능
    

---

## 5) 체결 타이밍(execution_timing)

- 기본: `next_bar`
    
- 의미:
    
    - decision_time의 bar(t)에서 신호 발생
        
    - 체결은 bar(t+1) 기준 가격모델을 사용
        

> Engine B는 이 정책을 기본으로 강제하며, 동일 바 체결은 원칙적으로 금지(룩어헤드).

---

## 6) 가격 모델(Price Model)

체결가를 결정하는 정책. 모드별로 선택 가능.

### 6.1 기본 옵션

- `open_next`: next bar open을 기준으로 체결
    
- `vwap`: 다음 bar의 VWAP 근사(데이터 있으면)
    
- `mid_plus_slip`: mid(또는 open) + 슬리피지 근사
    

### 6.2 주문 타입별 규칙(핵심)

#### 6.2.1 MKT

- 기본: `fill_price = price_model(open_next 등)`
    
- 부분체결: 가능(유동성 cap에 따라)
    

#### 6.2.2 LMT

- BUY:
    
    - next bar의 `low <= limit_price`이면 체결 가능
        
    - 체결가는 보수적으로 `min(limit_price, price_model)` 또는 정책 고정
        
- SELL:
    
    - `high >= limit_price`이면 체결 가능
        
- 체결 불가 시:
    
    - TIF에 따라 `EXPIRED`(DAY) 또는 다음 bar로 carry(GTC)
        

#### 6.2.3 STP / STP_LMT (옵션)

- stop 조건 충족 시 활성화(트리거) 후 MKT 또는 LMT로 전환
    
- 갭 발생 시 보수적 체결(불리하게)
    

---

## 7) 부분체결(Partial Fill) 모델

### 7.1 참여율 기반

- 각 bar에서 최대 체결 가능 수량:
    
    - `max_fill_qty_bar = adv_shares_60 * max_adv_participation * rvol_adjust`
        
- rvol_adjust 예:
    
    - `rvol_adjust = clamp(rvol, 0.5, 2.0)`
        

### 7.2 단계별 fills 생성

- `max_fill_steps`만큼 fills를 분할 생성 가능
    
- 각 fill에 price는 약간씩 불리하게 이동(보수 모델) 가능
    

### 7.3 결과 상태

- 전량 체결: `FILLED`
    
- 일부 체결: `PARTIAL`
    
- 0 체결:
    
    - IOC/FOK면 `CANCELLED/EXPIRED`
        
    - DAY/GTC면 대기(엔진 상태에 유지)
        

---

## 8) OBS-510 생성 규칙(필수)

Execution Model은 항상 OBS-510 형식으로 산출한다.

### 8.1 Order Record 필수

- decision_time/price, created_at, status, status_timestamps, filled_qty, fill_price_avg
    
- reject 시 reject 오브젝트 포함
    

### 8.2 Fill Records

- 부분체결이면 N개 fill 레코드
    
- 각 fill에 fees/spread/slippage는 MOD-423 결과를 매핑(가능하면 fill-level)
    

---

## 9) 실행 품질(Execution Quality) 계산

- `slippage_bps`: OBS-510 규칙과 동일(불리하면 +)
    
- `latency_ms`: `first_fill_at - decision_time`
    
- `partial_fill`: filled_qty < qty 여부
    
- `reject_rate`, `partial_fill_rate`는 MOD-430에서 집계(포트폴리오/전략 단위)
    

---

## 10) reason_codes / reject 표준

### 10.1 최소 reason_codes

- `EXEC_OK`
    
- `EXEC_PARTIAL`
    
- `EXEC_REJECTED`
    
- `EXEC_SPREAD_TOO_WIDE`
    
- `EXEC_ADV_CAP`
    
- `EXEC_LATENCY_HIGH`
    
- `EXEC_ORDER_TYPE_BLOCKED`
    

### 10.2 reject 포맷(OBS-510 동일)

```json
"reject": {
  "code": "EXEC_SPREAD_TOO_WIDE",
  "message": "spread exceeds cap",
  "details": { "spread_bps": 15.2, "max_spread_bps": 10 }
}
```

---

## 11) 예외/에러 처리

- `MISSING_MARKET_DATA`: OHLC 없으면 실행 불가
    
- `INVALID_ORDER_INTENT`: qty<=0 등
    
- `MODEL_INTERNAL_ERROR`: 예외 발생
    

에러는 OBS-510 `errors[]`에도 남기고, ExecuteResponse에서도 반환.

---

## 12) 테스트 요구사항

### 12.1 단위 테스트

- spread cap 초과 → REJECTED + reason code + reject.details
    
- adv cap 초과:
    
    - 정책 A면 REJECTED, 정책 B면 qty 축소 + WARN
        
- LMT 체결 조건(저가/고가 충족) 정확성
    
- next_bar 정책 준수(same bar fill 0)
    

### 12.2 통합 테스트

- Engine B 루프에서 주문→체결→포트폴리오 업데이트가 정합
    
- OBS-510 레코드가 validator 통과
    
- 비용 모델(MOD-423)과 결합 시 net PnL 정합성 유지
    

---

## 13) 다음 문서 연결

- **MOD-425** Portfolio Model(포지션/현금/레버리지/마진)
    
- **OBS-510** Order/Fill 로그
    
- **OBS-520** Trade Summary
    
- **MOD-430** 비용/실행 품질 집계
    

---
