
## Portfolio Model (포지션/현금/레버리지/마진)

- **문서 ID**: MOD-425
    
- **제목**: Portfolio Model Specification
    
- **버전**: 1.0
    
- **목표**: 백테스트/라이브에서 포지션·현금·노출·레버리지·제약을 일관되게 관리하고, 포트폴리오 레벨 리스크/제약 위반을 **OBS-500(portfolio 모듈)** 과 SCHEMA-340 메트릭에 반영한다.
    
- **범위**: 포트폴리오 상태 정의, 주문 체결 반영, 사이징/리밸런싱 정책(기본), 제약 집행 지점, PnL/자본 계산, 로그 생성.
    
- **비범위**: 개별 주문의 체결 규칙(=MOD-424), 비용 계산(=MOD-423), 전략 신호 생성(=MOD-410~)
    

---

## 1) Portfolio Model 책임(Responsibilities)

1. **상태 관리**: cash/equity/positions/exposure/leverage/margin 상태를 관리
    
2. **체결 반영**: fills를 받아 포지션/현금/실현손익을 업데이트
    
3. **사이징/목표 포지션**: 포트폴리오 구성 정책(기본 equal-weight 등) 지원
    
4. **제약 집행**: SCHEMA-330 portfolio/risk 제약(최대 종목수, 섹터 캡, 레버리지 제한 등) 체크
    
5. **리스크 가드 입력**: Risk Guard(MOD-482 또는 Backtest B의 risk checks)에 필요한 요약 값 제공
    
6. **관측/보고**: OBS-500(portfolio)와 SCHEMA-340 포트폴리오 메트릭 산출에 필요한 원천 데이터 제공
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `PortfolioInit`

```json
{
  "initial_cash": 100000,
  "base_currency": "USD",
  "leverage_policy": { "max_gross": 1.0, "max_net": 1.0 },
  "margin_policy": { "enabled": false, "initial_margin": 0.5, "maintenance_margin": 0.3 },
  "position_policy": {
    "max_positions": 20,
    "max_position_weight": 0.10,
    "allow_short": false
  }
}
```

### 2.2 입력: `ApplyFillsRequest`

```json
{
  "time": "2026-02-06T00:00:00Z",
  "fills": [
    { "order_id": "ord_001", "symbol": "AAPL", "side": "BUY", "qty": 100, "price": 101.12, "fees": 0.35 }
  ]
}
```

### 2.3 출력: `PortfolioSnapshot`

```json
{
  "time": "2026-02-06T00:00:00Z",
  "cash": 89888.0,
  "equity": 100012.0,
  "positions": {
    "AAPL": { "qty": 100, "avg_price": 101.12, "market_price": 101.40, "unrealized_pnl": 28.0 }
  },
  "exposures": { "gross": 0.10, "net": 0.10 },
  "risk": { "daily_pnl": 12.0, "drawdown": -0.01 },
  "violations": []
}
```

---

## 3) 핵심 상태 모델(State)

### 3.1 PortfolioState (필수)

- `cash`: 현금
    
- `equity`: 현금 + 포지션 시가 평가
    
- `positions`: `{symbol -> PositionState}`
    
- `realized_pnl`, `unrealized_pnl`
    
- `exposure_gross`, `exposure_net`
    
- `margin_used`, `free_margin` _(margin enabled 시)_
    
- `history`(옵션): equity curve 원천
    

### 3.2 PositionState (필수 최소)

- `qty` (long은 양수, short는 음수)
    
- `avg_price`
    
- `market_price`
    
- `unrealized_pnl`
    
- `realized_pnl`
    
- `entry_time_last`(옵션)
    
- `stop_level`, `trail_level`(옵션: risk/exit 모듈과 연동)
    

---

## 4) 가격 평가(Mark-to-Market) 규칙

- 바 단위 평가 가격 기본:
    
    - daily: `close[t]`로 평가(표준)
        
- `equity = cash + Σ(qty * market_price)`
    
- 평가 시점/가격은 SCHEMA-340 `calc_contract`에 기록되어야 함(재현성)
    

---

## 5) 체결 반영(Fill Application)

### 5.1 BUY 체결

- `cash -= qty * fill_price + fees + (spread/slippage 비용이 cash에 반영되는 정책이면 포함)`
    
- 포지션:
    
    - 기존 qty=0이면 신규
        
    - 기존 qty>0이면 가중평균으로 avg_price 업데이트
        
    - 기존 qty<0(숏 커버)면 실현손익 처리(숏은 v1에서 optional)
        

### 5.2 SELL 체결

- `cash += qty * fill_price - fees - ...`
    
- 실현손익:
    
    - `realized_pnl += sold_qty * (fill_price - avg_price)` (LONG 기준)
        

### 5.3 비용 반영 정책(중요)

- CostModel(MOD-423)의 결과를:
    
    - (권장) cash에서 즉시 차감/가산하여 `net` 기준 equity curve 생성
        
- `gross`와 `net`을 동시에 필요하면:
    
    - gross_pnl tracking을 별도로 유지(옵션)
        
    - 최소 MVP는 “net 기준” 1개를 우선 추천
        

---

## 6) 사이징/목표 포지션(Targeting) 정책 (MVP)

Portfolio Model은 “목표 수량”을 계산할 수 있어야 한다. (구현은 Orchestrator/Engine이 호출)

### 6.1 기본 equal-weight

- 목표 보유 종목 수: `N = min(max_positions, shortlist_count)`
    
- 각 포지션 목표 비중: `w = 1/N`
    
- 목표 수량:
    
    - `target_notional = equity * w`
        
    - `target_qty = floor(target_notional / price)` (또는 round 정책)
        

### 6.2 score-weight (옵션)

- entry_score나 selection_rank 기반으로 weight 차등
    
- 단, `MAX_POSITION_WEIGHT`로 상한
    

---

## 7) 제약(Constraints) 체크/집행

### 7.1 체크 시점

- 주문 생성 전: “이 주문이 들어가면 위반인가?” 사전 체크 (execution_gate/portfolio 모듈)
    
- 체결 후: “이미 위반이 발생했는가?” 사후 체크(리스크 가드)
    

### 7.2 지원 제약(최소)

- `MAX_POSITIONS`
    
- `MAX_POSITION_WEIGHT`
    
- `SECTOR_CAP` _(섹터 데이터 가용 시)_
    
- `LEVERAGE_LIMIT` (gross/net)
    
- `MAX_CORR_TO_PORTFOLIO` _(옵션: 계산 비용 있으므로 v1은 soft)_
    

### 7.3 위반 처리 정책(권장)

- 사전 체크에서 위반이면:
    
    - 주문 금지(`order_allowed=false`)
        
    - OBS-500(portfolio/execution_gate)에 reason code 기록
        
- 사후 위반은:
    
    - 다음 바에 자동 축소(감산 주문 생성) 또는 리밸런싱
        
    - 또는 Risk Guard가 전체 거래 중단(운영 모드)
        

---

## 8) 포트폴리오 OBS-500 기록 규칙

module_name = `portfolio` 레코드에 최소 다음을 남긴다:

### 8.1 decision (예)

```json
"decision": {
  "target_positions": 10,
  "max_positions": 20,
  "exposure_gross": 0.85,
  "exposure_net": 0.85,
  "violations": ["SECTOR_CAP"]
}
```

### 8.2 features_snapshot (최소)

- `equity`, `cash`
    
- `exposure_gross`, `exposure_net`
    
- `top_sector_weight`(가능 시)
    
- `max_position_weight_current`
    
- `drawdown_current`(가능 시)
    

---

## 9) 리밸런싱/턴오버 정책(권장)

- 과도한 매매를 줄이기 위해:
    
    - 최소 리밸런싱 임계: `|current_w - target_w| >= rebalance_band`
        
    - `rebalance_band` 기본 1~2%p
        
- 이 정책은 turnover/비용과 직결 → SCHEMA-340에 기록
    

---

## 10) 예외/에러 처리

- `INSUFFICIENT_CASH`: 현금 부족(레버리지 불가 정책)
    
- `MARGIN_CALL`: 유지증거금 위반(마진 활성 시)
    
- `PRICE_INVALID`: price<=0
    
- `STATE_CORRUPT`: qty/avg_price 불일치 등
    

에러 포맷:

```json
{ "code": "INSUFFICIENT_CASH", "message": "cash < required", "details": { "cash": 100, "required": 200 } }
```

---

## 11) 테스트 요구사항

### 11.1 단위 테스트

- BUY 후 avg_price 업데이트 정확성
    
- SELL 후 realized_pnl 계산 정확성
    
- fees 반영 시 cash/equity 정합성
    
- max_positions 위반 사전 차단
    

### 11.2 통합 테스트

- Engine B에서 주문→체결→포트폴리오 업데이트→trade summary까지 일관
    
- 제약 위반이 OBS-500 reason_codes로 남고 주문이 생성되지 않음(또는 축소 정책 적용)
    

---

## 12) 다음 문서 연결

- 다음은 Scorer & Report 파트의 첫 문서: **MOD-430 Metrics Calculator**
    
- 리스크 가드(라이브): MOD-482
    
- 제약 적용: MOD-451
    

---
