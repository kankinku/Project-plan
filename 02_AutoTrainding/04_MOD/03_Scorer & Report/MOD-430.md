## Metrics Calculator (지표 정의/연율화/리샘플링)

- **문서 ID**: MOD-430
    
- **제목**: Metrics Calculator Specification
    
- **버전**: 1.0
    
- **목표**: 백테스트 결과(포트폴리오 시계열/트레이드/주문·체결 로그)로부터 **신뢰 가능한 성과 지표를 표준(SCHEMA-340)** 으로 계산하고, 연율화/리샘플링/구간분할(IS/OOS, 레짐 등)을 일관된 규칙으로 제공한다.
    
- **범위**: 지표 계산 로직/계약, 입력 데이터 요구사항, 구간 분할/연율화 규칙, 실행품질/비용 집계, 검증(정합성) 체크.
    
- **비범위**: 점수화/가중치/페널티(=MOD-431), 강건성 테스트 실행(=MOD-432), 리포트 생성(=MOD-433)
    

---

## 1) Metrics Calculator 책임(Responsibilities)

1. **표준 지표 계산**: 수익률/변동성/낙폭/리스크조정/거래통계/비용/실행품질
    
2. **연율화 규칙 고정**: bar_interval별 annualization_factor 적용
    
3. **리샘플링 지원**: daily→weekly/monthly 등(정책 고정)
    
4. **구간 분할 평가**: IS/OOS, 워크포워드, 레짐/국면 분할용 slice 메트릭 산출
    
5. **정합성 검사**: PnL·비용·체결·트레이드 수량 합 등의 내부 일관성 체크
    
6. **SCHEMA-340 출력**: 계산 결과를 metrics_json으로 표준화하여 저장/비교 가능하게 함
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `MetricsRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",

  "calc_contract": {
    "returns_type": "simple|log",
    "include_fees": true,
    "include_spread": true,
    "include_slippage": true,
    "risk_free_rate_annual": 0.02,
    "annualization_factor": 252,
    "bar_interval": "1d",
    "timezone": "America/New_York",
    "price_mark": "close"
  },

  "inputs": {
    "equity_curve": [
      { "t": "2020-01-02", "equity": 100000.0 },
      { "t": "2020-01-03", "equity": 100200.0 }
    ],
    "trades": [{ "...OBS-520..." }],
    "orders": [{ "...OBS-510 order..." }],
    "fills": [{ "...OBS-510 fill..." }],
    "decision_logs_ref": "optional-path-or-handle"
  },

  "slices": {
    "is_oos": { "is": { "start": "2015-01-01", "end": "2021-12-31" }, "oos": { "start": "2022-01-01", "end": "2025-12-31" } },
    "regime": [
      { "name": "RISK_ON", "mask_ref": "regime_state==RISK_ON" },
      { "name": "RISK_OFF", "mask_ref": "regime_state==RISK_OFF" }
    ]
  },

  "resampling": {
    "enabled": true,
    "frequencies": ["1w", "1m"],
    "method": "end_of_period"
  },

  "policy": {
    "min_equity_points": 30,
    "nan_policy": "fail|drop|fill_forward",
    "winsorize_returns": null
  }
}
```

### 2.2 출력: `metrics_json` (SCHEMA-340)

```json
{
  "schema_version": "SCHEMA-340",
  "strategy_id": "hash",
  "calc_contract": { "...echo..." },

  "overall": {
    "return_total_net": 0.52,
    "cagr_net": 0.07,
    "vol_annual_net": 0.18,
    "sharpe_net": 0.45,
    "sortino_net": 0.62,
    "max_drawdown_net": -0.22,
    "calmar_net": 0.32
  },

  "trades": {
    "count": 420,
    "win_rate": 0.46,
    "profit_factor": 1.18,
    "avg_win": 0.021,
    "avg_loss": -0.015,
    "expectancy": 0.0012,
    "avg_holding_days": 6.2
  },

  "costs": {
    "fees_total": 120.5,
    "spread_total": 80.2,
    "slippage_total": 210.3,
    "costs_total": 411.0
  },

  "execution": {
    "reject_rate": 0.02,
    "partial_fill_rate": 0.05,
    "slippage_bps_p50": 6.0,
    "slippage_bps_p95": 22.0,
    "latency_ms_p95": 4800
  },

  "slices": { "is": { "...": "..." }, "oos": { "...": "..." }, "regime": { "...": "..." } },

  "quality": {
    "data_coverage": 0.99,
    "warnings": []
  }
}
```

---

## 3) 입력 데이터 요구사항(Data Requirements)

### 3.1 필수

- `equity_curve` (time, equity)
    
- `trades` (OBS-520) 또는 `fills` + 포지션 히스토리(대체 가능하지만 v1은 trades 권장)
    
- `calc_contract` (연율화/비용 포함 여부를 결정하는 계약)
    

### 3.2 권장

- `fills` (OBS-510 Fill): 슬리피지/부분체결/지연 품질 메트릭 계산에 필요
    
- `orders` (OBS-510 Order): reject_rate 등 실행 메트릭에 필요
    
- 레짐 마스크(OBS-500 regime): regime slice 메트릭에 필요
    

---

## 4) 수익률/연율화 규칙(고정)

### 4.1 바 수익률(series)

- simple:
    
    - `r_t = equity_t / equity_{t-1} - 1`
        
- log:
    
    - `r_t = ln(equity_t / equity_{t-1})`
        

### 4.2 연율화(annualization_factor = A)

- 평균 수익률(단순 근사):
    
    - `mean_annual = mean(r) * A`
        
- 변동성:
    
    - `vol_annual = std(r) * sqrt(A)`
        
- CAGR(권장: 기간 기반):
    
    - `CAGR = (equity_end / equity_start)^(A / n_bars) - 1`
        

> annualization_factor는 bar_interval에 따라 고정(예: 1d=252, 1h=~1600 등)하며 calc_contract에 반드시 기록.

### 4.3 샤프/소티노

- Sharpe:
    
    - `(mean(r) - rf_per_bar) / std(r) * sqrt(A)`
        
- Sortino:
    
    - `(mean(r) - rf_per_bar) / std(r_downside) * sqrt(A)`
        
- `rf_per_bar = (1 + rf_annual)^(1/A) - 1`
    

---

## 5) 낙폭/리스크 지표

### 5.1 Max Drawdown

- `dd_t = equity_t / peak_to_date - 1`
    
- `max_drawdown = min(dd_t)`
    

### 5.2 Calmar

- `calmar = CAGR / abs(max_drawdown)` (max_drawdown<0일 때)
    

### 5.3 추가(옵션)

- VaR/CVaR(returns 기반)
    
- tail_loss_p95(하위 5% 평균)  
    (강건성/리스크 확장은 v1.1로 버전업 추천)
    

---

## 6) 트레이드 통계(OBS-520 기반)

필수 산출(권장 최소):

- `trade_count`
    
- `win_rate`
    
- `avg_win`, `avg_loss` (return 기준 또는 PnL 기준, policy로 고정)
    
- `profit_factor = sum(wins) / abs(sum(losses))`
    
- `expectancy = win_rate*avg_win + (1-win_rate)*avg_loss`
    
- `avg_holding_days/bars`
    
- MFE/MAE 집계(옵션):
    
    - `mfe_return_p50/p95`, `mae_return_p50/p95`
        

> v1 기본: **net 기준**(비용 포함된 net_return)을 표준으로 사용.

---

## 7) 비용/실행 품질 메트릭(OBS-510/520 기반)

### 7.1 비용(costs)

- `fees_total = sum(fill.fees)`
    
- `spread_total = sum(fill.estimated_spread_cost)`
    
- `slippage_total = sum(fill.estimated_slippage_cost)`
    
- `costs_total = fees_total + spread_total + slippage_total`
    

### 7.2 실행(execution)

- `reject_rate = rejected_orders / total_orders`
    
- `partial_fill_rate = orders_with_partial / total_orders`
    
- 슬리피지 분포:
    
    - `slippage_bps_p50/p95` (OBS-510 order 또는 fill 기반, 정책 고정)
        
- 지연 분포:
    
    - `latency_ms_p95` (OBS-510 latency_ms)
        

---

## 8) 리샘플링(Resampling)

### 8.1 목적

- 일봉에서 주/월 성과 안정성 확인
    
- 레짐/국면 분할 전에 노이즈 감소
    

### 8.2 규칙(권장)

- `method=end_of_period`
    
    - 주/월 말 equity로 바를 재구성 후 returns 산출
        
- resample 메트릭은 `slices.resampled["1w"]` 같은 네임스페이스로 저장(스키마에 맞춰 확장)
    

---

## 9) 구간 분할(Slices)

### 9.1 IS/OOS

- time 범위를 기반으로 equity_curve와 trades를 자르고, 동일한 메트릭 세트를 계산
    
- 산출:
    
    - `slices.is.*`
        
    - `slices.oos.*`
        
- OOS 유지율(OOS 유지 성능)은 Scorer(MOD-431)에서 사용하되, Metrics는 원천 값 제공:
    
    - `oos_sharpe_net`, `oos_return_total_net`, `oos_max_dd_net`
        

### 9.2 Regime slices

- regime_state 마스크(OBS-500 또는 별도 마스크)로 returns를 분할
    
- `slices.regime.RISK_ON.*` 형태로 저장
    

---

## 10) 정합성 검사(Integrity Checks)

### 10.1 최소 체크(필수 권장)

- equity_curve 길이 >= `min_equity_points`
    
- equity>0 (0 이하 발견 시 FAIL)
    
- costs_total == fees+spread+slippage (허용오차)
    
- trade_count == closed trades 수 (OBS-520)
    
- fills 합계 수량과 trades 수량의 큰 불일치 탐지(경고 또는 FAIL)
    

### 10.2 quality.warnings 표준

- `METRIC_INSUFFICIENT_POINTS`
    
- `EQUITY_NONPOSITIVE_DETECTED`
    
- `COSTS_MISSING_FALLBACK_USED`
    
- `PARTIAL_DATA_COVERAGE`
    

---

## 11) 예외/에러 처리

- `INSUFFICIENT_DATA`: equity points 부족
    
- `NAN_IN_EQUITY`: NaN 처리 정책에 따라 FAIL 또는 drop
    
- `DIV_BY_ZERO`: std=0인 경우 sharpe/sortino는 null 처리 + warning
    
- `SCHEMA_MISMATCH`: 입력이 OBS/SCHEMA 규격과 불일치
    

에러 포맷:

```json
{ "code": "INSUFFICIENT_DATA", "message": "equity points < 30", "details": { "points": 12 } }
```

---

## 12) 로깅(Observability)

- 계산 이벤트 로그(권장: internal)
    
    - slice 계산 완료, resample 완료, warning 발생
        
- metrics_json에는 최소한:
    
    - `calc_contract` echo
        
    - `quality.warnings[]`
        

---

## 13) 테스트 요구사항

### 13.1 단위 테스트

- returns_type simple/log 계산 검증
    
- annualization_factor 적용 검증
    
- max drawdown 계산 검증(known series)
    
- costs_total 분해 합산 검증
    
- reject_rate/partial_fill_rate 계산 검증(known orders)
    

### 13.2 통합 테스트

- Engine B 산출(OBS-510/520 + equity) → metrics_json 생성 → SCHEMA-340 validator 통과
    
- 동일 입력(데이터 스냅샷/계약) → 동일 metrics 결과(허용오차 내)
    

---

## 14) 다음 문서 연결

- 다음: **MOD-431 — Scorer(가중치, 페널티, OOS 유지율)**
    
- 강건성 실행: MOD-432
    
- 리포트 생성: MOD-433
    
