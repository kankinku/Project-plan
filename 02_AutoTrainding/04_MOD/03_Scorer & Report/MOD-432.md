##
Robustness Tests (워크포워드/국면분할/민감도)

- **문서 ID**: MOD-432
    
- **제목**: Robustness Tests Specification (WFA / Regime / Sensitivity)
    
- **버전**: 1.0
    
- **목표**: 단일 백테스트 성과에 속지 않도록, 전략을 **여러 관점(시간·국면·파라미터·비용/체결 스트레스)** 에서 재검증하고 “과최적화/취약성”을 조기에 드러내어 Scorer/Analyzer/Constraint로 연결한다.
    
- **범위**: 워크포워드, 레짐 분할, 파라미터 민감도, 비용/체결 스트레스, 결과 집계 스키마.
    
- **비범위**: 기본 백테스트 실행(MOD-420~422), 지표 계산(MOD-430), 점수화(MOD-431)
    

---

## 1) Robustness 책임(Responsibilities)

1. **테스트 플랜 생성**: 어떤 분할/교란(perturbation)을 적용할지 결정
    
2. **반복 실행**: 동일 전략을 여러 조건에서 재백테스트(주로 Engine B 권장)
    
3. **결과 집계**: slice별/케이스별 metrics를 구조화해 저장
    
4. **강건성 점수**: `robustness_score`/`param_sensitivity_score` 등 스코어링에 쓰일 원천 값 제공
    
5. **취약성 신호 생성**: “어디서 깨지는지” failure 후보(증거 링크) 생성
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `RobustnessRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",
  "strategy_spec": { "...SCHEMA-300..." },

  "base_backtest_config": {
    "engine": "event_driven",
    "models": { "cost_model_id": "cost_v1", "exec_model_id": "exec_v1", "pf_model_id": "pf_v1" },
    "calc_contract": { "annualization_factor": 252, "execution_timing": "next_bar" }
  },

  "tests": {
    "walk_forward": { "enabled": true, "n_folds": 4, "train_ratio": 0.6, "overlap": 0.0 },
    "regime_split": { "enabled": true, "regimes": ["RISK_ON", "RISK_OFF"] },
    "parameter_sensitivity": { "enabled": true, "params": ["rsi_low", "stoch_high", "atr_mult"], "use_sampler_deltas": true, "n_samples": 20 },
    "cost_stress": { "enabled": true, "profiles": ["neutral", "conservative"] },
    "execution_stress": { "enabled": true, "max_spread_bps": [10, 20], "max_adv_participation": [0.01, 0.005] }
  },

  "budgets": { "max_runs": 50, "timeout_sec": 7200 }
}
```

### 2.2 출력: `RobustnessResponse`

```json
{
  "strategy_id": "hash",
  "status": "SUCCESS|PARTIAL|FAILED",

  "summary": {
    "robustness_score": 0.61,
    "param_sensitivity_score": 0.58,
    "wfa_pass_rate": 0.50,
    "regime_balance_score": 0.62,
    "cost_stress_drop": 0.08,
    "execution_stress_drop": 0.12
  },

  "cases": [
    { "case_id": "WFA_1", "type": "walk_forward", "metrics_ref": "path/to/metrics.json", "passed": true },
    { "case_id": "SENS_7", "type": "parameter_sensitivity", "params": { "rsi_low": 35 }, "passed": false }
  ],

  "warnings": []
}
```

---

## 3) 테스트 종류별 정의

## 3.1 워크포워드(Walk-Forward Analysis, WFA)

### 3.1.1 목적

- 시간에 따른 성능 붕괴(레짐 변화/구조 변화)를 탐지
    

### 3.1.2 분할 규칙(권장)

- 전체 기간을 `n_folds`로 나누고 각 fold에서:
    
    - train 구간: 사용(옵션, 파라미터 튜닝은 v1에서는 “없음” 또는 고정)
        
    - test(OOS) 구간: 평가
        
- v1 권장: 튜닝 없이 “고정 파라미터로” fold별 성과만 비교(과최적화 방지)
    

### 3.1.3 산출

- fold별 `oos_sharpe_net`, `oos_max_dd_net`, `oos_return_total_net`
    
- `wfa_pass_rate = passed_folds / n_folds`
    

### 3.1.4 pass 기준(예)

- oos_sharpe_net >= 0.10
    
- oos_max_dd_net >= -0.35
    
- trades >= min_trades_fold
    

---

## 3.2 국면/레짐 분할(Regime Split)

### 3.2.1 목적

- 특정 국면에서만 먹히는 “레짐 편향” 탐지
    
- RISK_OFF에서 완전 붕괴하면 실전 위험 큼
    

### 3.2.2 구현

- regime_state 마스크(OBS-500 또는 별도 계산)로 returns/trades를 분할
    
- 각 regime별 metrics 계산(MOD-430 재사용)
    

### 3.2.3 산출

- `regime_metrics[regime]`
    
- `regime_balance_score` (예: 최악 레짐 sharpe가 전체 sharpe의 몇 %인지)
    

---

## 3.3 파라미터 민감도(Parameter Sensitivity)

### 3.3.1 목적

- 임계값 기반 전략(예: RSI<=30, Stoch>=80)이 **작은 변화에 깨지는지** 탐지(과최적화 신호)
    

### 3.3.2 샘플링

- MOD-411의 `sensitivity` 델타를 사용:
    
    - 예: rsi_low = 30 ± 5, atr_mult = 3.0 ± 0.5
        
- `n_samples`만큼 파라미터를 흔들어 케이스 생성
    
- 제약(SCHEMA-330) 범위 내에서만 perturbation
    

### 3.3.3 산출

- 각 케이스의 score_total 또는 핵심 메트릭(sharpe, dd)
    
- `param_sensitivity_score` 계산(권장 예)
    
    - `1 - normalized_std(score_total_over_cases)`
        
    - 또는 “임계 이하로 떨어지는 케이스 비율” 기반
        

---

## 3.4 비용 스트레스(Cost Stress)

### 3.4.1 목적

- 비용 가정이 조금만 보수적으로 바뀌어도 성과가 붕괴하는지 확인
    

### 3.4.2 케이스

- CostModel profile을 `neutral → conservative`로 변경
    
- spread/slippage 배수를 올림(MOD-423 profile scaling)
    

### 3.4.3 산출

- `cost_stress_drop = base_score_total - conservative_score_total` (또는 sharpe drop)
    

---

## 3.5 실행 스트레스(Execution Stress)

### 3.5.1 목적

- 유동성/ADV/스프레드 제약이 강화될 때 전략이 “실행 가능”한지 확인
    

### 3.5.2 케이스

- `max_spread_bps` 강화(예: 10→20은 완화, 반대로 10→5는 강화)
    
- `max_adv_participation` 강화(0.01→0.005)
    
- latency 증가(p95 상승)
    

### 3.5.3 산출

- `reject_rate`, `partial_fill_rate` 변화
    
- `execution_stress_drop` (score 또는 sharpe 하락)
    
- “거래 기회 소실률”: trade_count 감소율
    

---

## 4) 집계/스코어 산출(요약 수치 정의)

### 4.1 robustness_score (권장 구성)

```text
robustness_score =
  0.35 * wfa_pass_rate +
  0.25 * regime_balance_score +
  0.25 * param_sensitivity_score +
  0.10 * (1 - cost_stress_drop_norm) +
  0.05 * (1 - execution_stress_drop_norm)
```

- drop_norm은 0~1로 정규화(정책)
    

> 이 점수는 MOD-431 stability 항목의 입력으로 쓰거나, 별도 페널티로 쓸 수 있음.

---

## 5) 케이스 관리(Case Registry)

각 robustness run은 `case_id`로 추적되며, 반드시 다음을 저장한다:

- case_id, type, 변경된 파라미터/정책, metrics_ref, pass/fail, 요약 지표
    

권장 저장:

- `artifacts/runs/<run_id>/robustness/<strategy_id>/cases.jsonl`
    

---

## 6) 예외/에러 처리

- `BUDGET_EXCEEDED`: max_runs 초과 → PARTIAL 반환
    
- `TIMEOUT`: timeout_sec 초과 → PARTIAL
    
- `UNSUPPORTED_STRATEGY_FEATURE`: Engine B에서 미지원(즉시 FAIL 또는 해당 케이스 스킵)
    
- `INSUFFICIENT_TRADES`: 케이스별 거래수 부족 → WARN 또는 FAIL(정책)
    

---

## 7) 테스트 요구사항

- 동일 입력(seed/config) → 동일 케이스 집합 생성(결정성)
    
- 케이스별 변경점이 정확히 반영되는지(예: rsi_low=35가 DSL에 적용)
    
- 요약 점수(robustness_score)가 케이스 결과 변화에 단조적으로 반응하는지
    
- PARTIAL 상황에서도 cases는 유효한 subset으로 저장되는지
    

---

## 8) 다음 문서 연결

- 다음: **MOD-433 — Report Generator(티어시트/아티팩트/요약)**
    
- Analyzer 입력: robustness cases 중 fail 케이스를 evidence로 사용(MOD-442)
    

“다음”이라고 하면 MOD-433을 하나만 이어서 작성할게.