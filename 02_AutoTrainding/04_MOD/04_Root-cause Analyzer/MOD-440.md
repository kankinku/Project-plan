## Failure Taxonomy (카테고리/태그/증거 규격)

- **문서 ID**: MOD-440
    
- **제목**: Failure Taxonomy Specification (Categories / Tags / Evidence Contract)
    
- **버전**: 1.0
    
- **목표**: 전략이 실패(또는 저성과)했을 때 원인을 **일관된 분류 체계**로 라벨링하고, Analyzer/Constraint Writer/KB가 재사용할 수 있도록 **증거(evidence) 규격**까지 표준화한다.
    
- **범위**: 실패 카테고리·태그 정의, severity/신뢰도, evidence 스키마, 저장/조회 규칙.
    
- **비범위**: 실제 진단 로직(=MOD-441), 증거 수집 구현(=MOD-442)
    

---

## 1) Taxonomy 책임(Responsibilities)

1. **분류 표준 제공**: 실패를 동일한 언어로 말하게 함(모듈 간 합의)
    
2. **증거 계약 제공**: “왜 그렇게 분류했는지”를 로그/지표/구간으로 연결
    
3. **자동 제약 변환 기반**: 실패→제약(=MOD-450)으로 변환 가능한 구조 제공
    
4. **지식 축적/검색**: 유사 실패/유사 전략을 KB에서 검색 가능하게 함(=MOD-462)
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `FailureEvidenceBundle` (Analyzer가 참조하는 원천 핸들)

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",
  "metrics_ref": "path/to/metrics.json",
  "trades_ref": "path/to/obs520.jsonl",
  "orders_fills_ref": "path/to/obs510.jsonl",
  "decision_logs_ref": "optional path/to/obs500.jsonl",
  "dq_checks_ref": "path/to/obs540.jsonl",
  "run_metadata_ref": "path/to/obs530.json"
}
```

### 2.2 출력: `FailureRecord[]`

```json
[
  {
    "failure_id": "uuid",
    "run_id": "uuid",
    "iteration_id": 12,
    "strategy_id": "hash",

    "category": "SIGNAL|TIMING|RISK_MODEL|EXECUTION|PORTFOLIO|DATA|INFRA",
    "tags": ["OOS_DECAY", "REGIME_BIAS_RISK_OFF"],
    "severity": "INFO|WARN|ERROR|CRITICAL",

    "confidence": 0.0,
    "summary": "OOS 성능 유지율이 낮고 RISK_OFF 구간에서 붕괴",

    "evidence": [
      { "type": "METRIC", "ref": "metrics.overall.oos_sharpe_net", "value": 0.05, "threshold": 0.10 },
      { "type": "SLICE", "ref": "metrics.slices.regime.RISK_OFF.sharpe_net", "value": -0.10 },
      { "type": "RANGE", "ref": "equity_curve", "start": "2022-01-01", "end": "2022-10-01" }
    ],

    "suggested_actions": [
      { "action": "ADD_CONSTRAINT", "target": "generator", "payload": { "type": "LIMIT_PARAM_RANGE", "param": "rsi_low", "min": 25, "max": 35 } }
    ]
  }
]
```

---

## 3) 카테고리 정의(Category)

카테고리는 상위 7개로 고정(검색/통계 안정성).

1. `SIGNAL`
    
    - 신호 자체가 통계적으로 약함(수익률/샤프 낮음, PF<1 등)
        
2. `TIMING`
    
    - 진입/청산이 늦음, 과필터링, 신호 밀도 문제(기회 소실)
        
3. `RISK_MODEL`
    
    - 스탑/트레일/포지션 사이징이 비현실(너무 타이트/너무 루즈)
        
4. `EXECUTION`
    
    - 슬리피지/부분체결/거절/지연으로 성능 붕괴
        
5. `PORTFOLIO`
    
    - 섹터 쏠림/상관 급증/동시 손실, 집중도 문제
        
6. `DATA`
    
    - 룩어헤드/서바이버십/타임존/조정주가/결측 등 데이터 신뢰 문제
        
7. `INFRA`
    
    - 엔진 크래시/타임아웃/상태 불일치/리플레이 불가 등 시스템 문제
        

---

## 4) 태그(Tag) 표준 (확장 가능)

태그는 category 하위에서 “더 구체적 원인”을 표현한다. (문자열 enum, 버전 관리)

### 4.1 SIGNAL 태그(예)

- `LOW_SHARPE`, `LOW_RETURN`, `PF_LT_1`, `NEGATIVE_EDGE`
    
- `OOS_DECAY` (IS 대비 OOS 급락)
    
- `REGIME_BIAS_RISK_ON`, `REGIME_BIAS_RISK_OFF`
    

### 4.2 TIMING 태그(예)

- `OVER_FILTERING` (trade_count 부족, entry_reject 비중 높음)
    
- `LATE_ENTRY`, `EARLY_EXIT`
    
- `SIGNAL_TOO_RARE`, `SIGNAL_TOO_FREQUENT`
    

### 4.3 RISK_MODEL 태그(예)

- `STOP_TOO_TIGHT_ATR`, `STOP_TOO_LOOSE`
    
- `TRAIL_HARM_WINNERS`
    
- `POSITION_SIZE_TOO_AGGRESSIVE`
    

### 4.4 EXECUTION 태그(예)

- `SLIPPAGE_P95_HIGH`, `REJECT_RATE_HIGH`, `PARTIAL_FILL_HIGH`, `LATENCY_P95_HIGH`
    
- `SPREAD_CAP_BINDING`, `ADV_CAP_BINDING`
    

### 4.5 PORTFOLIO 태그(예)

- `SECTOR_CONCENTRATION`, `CORRELATION_CLUSTER`, `DRAW_DOWN_CLUSTERED`
    
- `LEVERAGE_LIMIT_BINDING`
    

### 4.6 DATA 태그(예)

- `LOOKAHEAD_DETECTED`, `SURVIVORSHIP_RISK`, `TIMEZONE_MISMATCH`
    
- `CORP_ACTION_ANOMALY`, `MISSING_DATA_HIGH`, `DUPLICATE_TS`
    

### 4.7 INFRA 태그(예)

- `ENGINE_CRASH`, `TIMEOUT`, `STATE_CORRUPT`, `NON_DETERMINISTIC`
    

---

## 5) Severity 정의(필수)

- `INFO`: 관찰되지만 영향 미미
    
- `WARN`: 성과/신뢰에 영향 가능(개선 권장)
    
- `ERROR`: 명확한 성과 저해(제약/수정 필요)
    
- `CRITICAL`: 신뢰 붕괴 또는 운영 위험(즉시 중단/무효 처리)
    

**권장 매핑**

- DATA의 `LOOKAHEAD_DETECTED`는 기본 `CRITICAL`
    
- INFRA의 `STATE_CORRUPT`는 기본 `CRITICAL`
    

---

## 6) Evidence 규격(Evidence Contract)

evidence는 “어디서 무엇을 봤는지”를 기계적으로 연결해야 한다.

### 6.1 Evidence 타입

- `METRIC`: SCHEMA-340 특정 필드/값
    
- `SLICE`: slices/robustness 케이스 결과
    
- `LOG_REF`: OBS-500/510/520 특정 레코드 쿼리(필터) 또는 샘플
    
- `RANGE`: 기간 구간(시간창)
    
- `THRESHOLD`: 정책 임계치(게이트/페널티 기준)
    
- `AGG`: 집계 통계(예: reject_rate, slippage_p95)
    

### 6.2 Evidence 필드(공통)

```json
{
  "type": "METRIC|SLICE|LOG_REF|RANGE|THRESHOLD|AGG",
  "ref": "string pointer",
  "value": 0.0,
  "threshold": 0.0,
  "start": "optional",
  "end": "optional",
  "query": "optional",
  "notes": "optional"
}
```

---

## 7) FailureRecord 상태(State)

- `OPEN`: 분석 결과 생성됨(초기)
    
- `CONFIRMED`: 증거 충분(또는 사람이 승인)
    
- `RESOLVED`: 제약/수정으로 대응 완료(후속 run에서 개선됨)
    
- `DEPRECATED`: 분류 체계 변경/오진으로 사용 중단
    

상태 전이는 KB/Constraint Lifecycle과 연결(=MOD-452).

---

## 8) 로깅(Observability)

- Analyzer는 FailureRecord 생성 시 내부 이벤트 로그를 남김(권장):
    
    - `FAILURE_CREATED`, `FAILURE_CONFIRMED`, `FAILURE_RESOLVED`
        
- 누적 통계:
    
    - category/tag 빈도
        
    - 전략군별 반복 실패 패턴(“같은 실수 반복” 탐지)
        

---

## 9) 예외/에러 처리

- `EVIDENCE_MISSING`: ref된 아티팩트가 없음 → severity 상향 금지, confidence 낮춤 + WARN
    
- `UNKNOWN_TAG`: 등록되지 않은 태그 → `taxonomy_version_mismatch` WARN
    
- `INVALID_CATEGORY`: enum 위반 → 기록 실패(validator fail)
    

---

## 10) 테스트 요구사항

1. **스키마 테스트**: FailureRecord가 validator 통과(필수 필드/enum)
    
2. **증거 참조 무결성**: metrics_ref/trades_ref가 존재할 때 ref가 유효한 경로인지
    
3. **severity 규칙**: LOOKAHEAD_DETECTED는 항상 CRITICAL로 승격되는지
    
4. **버전 호환**: taxonomy_version 변경 시 이전 기록을 읽을 수 있는지(마이그레이션 규칙)
    

---
