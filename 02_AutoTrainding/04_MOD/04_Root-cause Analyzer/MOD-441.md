## Analyzer Rules v0 (룰 기반 진단 로직)

- **문서 ID**: MOD-441
    
- **제목**: Root-cause Analyzer Rules v0 Specification
    
- **버전**: 1.0
    
- **목표**: metrics/logs/robustness 결과를 기반으로 실패 원인을 **규칙 기반으로 자동 진단**하여 MOD-440 FailureRecord를 생성한다. v0는 “간단하지만 안정적인” 규칙부터 시작해, 잘못된 확신을 피하고(=confidence) Evidence 기반으로만 결론을 내린다.
    
- **범위**: 입력/출력, 룰 구조, 룰 우선순위, confidence 산출, evidence 생성 규칙, v0 룰셋(최소).
    
- **비범위**: 증거 수집/슬라이싱 구현 상세(=MOD-442), 제약 변환(=MOD-450)
    

---

## 1) Analyzer Rules v0 책임(Responsibilities)

1. **룰 실행**: 정의된 룰셋을 metrics/logs에 적용하여 failure 후보 생성
    
2. **우선순위 처리**: CRITICAL(DQ/룩어헤드) 우선, 이후 실행/리스크/신호 순
    
3. **중복 병합**: 같은 category/tag를 여러 룰이 찍으면 evidence를 합치고 severity/ confidence를 조정
    
4. **confidence 산출**: 증거의 질/일관성에 따라 확신도(0~1) 부여
    
5. **설명 가능 출력**: FailureRecord에 summary + evidence + suggested_actions(초안)을 포함
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `AnalyzeRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",

  "metrics_json": { "...SCHEMA-340..." },
  "score": { "...MOD-431 ScoreResponse..." },

  "artifacts": {
    "trades_ref": "path/to/obs520.jsonl",
    "orders_fills_ref": "path/to/obs510.jsonl",
    "decision_logs_ref": "optional",
    "dq_checks_ref": "path/to/obs540.jsonl"
  },

  "policy": {
    "thresholds": {
      "min_trades": 30,
      "oos_retention_min": 0.7,
      "slippage_p95_bps_high": 25,
      "reject_rate_high": 0.10,
      "max_dd_bad": -0.35,
      "turnover_high": 3.0
    },
    "rule_version": "rules_v0"
  }
}
```

### 2.2 출력: `AnalyzeResponse`

```json
{
  "strategy_id": "hash",
  "failures": [{ "...MOD-440 FailureRecord..." }],
  "stats": { "rules_fired": 6, "failures_created": 3 },
  "warnings": []
}
```

---

## 3) 룰 정의 구조(Rule Schema)

### 3.1 Rule 객체(개념)

- `rule_id`: 고유 ID (예: `R0_DATA_LOOKAHEAD`)
    
- `category`, `tags[]`, `severity_base`
    
- `when(metrics/logs)`: 조건(임계치/패턴)
    
- `evidence_builder`: 어떤 evidence를 붙일지
    
- `suggested_actions_builder`: 제약/조정 초안(선택)
    
- `confidence_model`: confidence 계산 방식
    

### 3.2 룰 실행 순서(권장)

1. **DQ/데이터 CRITICAL 룰**
    
2. **인프라 CRITICAL 룰**
    
3. **실행(EXECUTION) 룰**
    
4. **리스크(RISK_MODEL/PORTFOLIO) 룰**
    
5. **신호(SIGNAL/TIMING) 룰**
    
6. **보강(robustness) 룰** (위 결과에 evidence 추가)
    

---

## 4) confidence 산출(원칙)

v0는 “증거가 강할수록 confidence↑, 근거가 약하면 confidence↓”로 단순하게 간다.

### 4.1 기본 규칙(권장)

- metrics 1개 임계 위반만 있으면: 0.4
    
- metrics 2개 이상 + 동일 방향이면: 0.6
    
- logs(OBS-510/520)에서 직접 관측되면: +0.15
    
- robustness 케이스에서도 반복되면: +0.15
    
- 데이터 부족/표본 부족이면: -0.2
    
- 상충 증거가 있으면: -0.2
    

최종 clamp(0,1)

---

## 5) Failure 병합 규칙

동일 `(category, tag)`는 1개 FailureRecord로 병합:

- severity: max(severity)
    
- confidence: 평균이 아니라 “증거 수 기반 가중” (v0는 max로 시작해도 됨)
    
- evidence: 합치되 중복 제거
    
- summary: 가장 중요한 문장 1개 + 보조 문장(최대 2개)
    

---

## 6) v0 룰셋(최소 필수)

아래는 “시작 버전”으로 충분히 강력하고, 자동 제약으로 연결하기 좋다.

---

### 6.1 DATA — 룩어헤드/데이터 품질

**R0_DATA_LOOKAHEAD**

- category: DATA
    
- tag: `LOOKAHEAD_DETECTED`
    
- severity: CRITICAL
    
- when:
    
    - dq_checks에 lookahead 관련 CRITICAL 존재
        
    - 또는 execution_timing이 same_bar로 기록됨(금지 정책)
        
- evidence:
    
    - `LOG_REF` dq_checks 해당 레코드
        
    - `THRESHOLD` (policy: execution_timing=next_bar)
        
- suggested_actions:
    
    - `ADD_CONSTRAINT: BAN_EXECUTION_TIMING_SAME_BAR`
        
- confidence: 0.9 (거의 확정)
    

**R0_DATA_MISSING_HIGH**

- category: DATA
    
- tag: `MISSING_DATA_HIGH`
    
- severity: ERROR
    
- when:
    
    - metrics.quality.data_coverage < 0.98 (예)
        
    - 또는 decision logs에서 DATA_MISSING reason 비율 > X
        
- evidence: METRIC(data_coverage), AGG(missing_rate)
    
- confidence: 0.6~0.8 (증거 수준에 따라)
    

---

### 6.2 INFRA — 엔진/상태 오류

**R0_INFRA_TIMEOUT**

- category: INFRA
    
- tag: `TIMEOUT`
    
- severity: ERROR
    
- when:
    
    - BacktestResponse.status=PARTIAL and error code TIMEOUT
        
- evidence: LOG_REF(backtest errors)
    
- suggested_actions:
    
    - `ADD_CONSTRAINT: REDUCE_STRATEGY_COMPLEXITY` 또는 `REDUCE_UNIVERSE`
        
- confidence: 0.8
    

**R0_INFRA_STATE_CORRUPT**

- category: INFRA
    
- tag: `STATE_CORRUPT`
    
- severity: CRITICAL
    
- when:
    
    - 포지션 정합성 체크 실패(Engine B validation)
        
- evidence: LOG_REF(validation fail)
    
- confidence: 0.9
    

---

### 6.3 EXECUTION — 실행 품질 붕괴

**R0_EXEC_SLIPPAGE_HIGH**

- category: EXECUTION
    
- tag: `SLIPPAGE_P95_HIGH`
    
- severity: ERROR
    
- when:
    
    - metrics.execution.slippage_bps_p95 >= policy.slippage_p95_bps_high
        
- evidence: METRIC(slippage_p95), THRESHOLD
    
- suggested_actions(예):
    
    - `ADD_CONSTRAINT: MAX_SPREAD_BPS_LOWER`
        
    - `ADD_CONSTRAINT: MAX_ADV_PARTICIPATION_LOWER`
        
    - `PREFER_ORDER_TYPE: LMT`
        
- confidence:
    
    - base 0.6 + (fills 존재하면 +0.15)
        

**R0_EXEC_REJECT_RATE_HIGH**

- category: EXECUTION
    
- tag: `REJECT_RATE_HIGH`
    
- severity: ERROR
    
- when:
    
    - reject_rate > policy.reject_rate_high
        
- evidence: METRIC(reject_rate)
    
- suggested_actions:
    
    - 유동성 필터 강화 / 실행 제약 완화(상충 가능 → suggested_actions는 “옵션”으로만)
        
- confidence: 0.6
    

**R0_EXEC_ADV_CAP_BINDING**

- category: EXECUTION
    
- tag: `ADV_CAP_BINDING`
    
- severity: WARN/ERROR
    
- when:
    
    - order_allowed=false reason 중 ADV_CAP 비율이 높음
        
    - 또는 trade_count가 A에서 충분했는데 B에서 급감 + rejects에 ADV_CAP 다수
        
- evidence: LOG_REF(OBS-500 execution_gate), METRIC(trade_count_drop)
    
- confidence: 0.5~0.7
    

---

### 6.4 RISK_MODEL — 스탑/트레일/리스크 설정 문제

**R0_RISK_STOP_TOO_TIGHT**

- category: RISK_MODEL
    
- tag: `STOP_TOO_TIGHT_ATR`
    
- severity: WARN/ERROR
    
- when(예):
    
    - trades에서 평균 MAE가 작고(자주 작은 손절),
        
    - win_rate 높지만 profit_factor 낮고,
        
    - MFE 대비 수익 실현이 작음(롱테일 훼손)
        
- evidence:
    
    - AGG(avg_loss_small_many), METRIC(profit_factor), LOG_REF(sample trades)
        
- confidence: 0.4~0.6 (v0는 보수적으로)
    

**R0_RISK_MAX_DD_BAD**

- category: RISK_MODEL
    
- tag: `DRAWDOWN_TOO_LARGE`
    
- severity: ERROR
    
- when:
    
    - overall.max_drawdown_net <= policy.max_dd_bad
        
- evidence: METRIC(max_drawdown_net), THRESHOLD
    
- suggested_actions:
    
    - `ADD_CONSTRAINT: MAX_LEVERAGE_LOWER` 또는 `POSITION_SIZE_CAP`
        
- confidence: 0.6
    

---

### 6.5 PORTFOLIO — 집중/상관 문제

**R0_PF_SECTOR_CONCENTRATION**

- category: PORTFOLIO
    
- tag: `SECTOR_CONCENTRATION`
    
- severity: WARN/ERROR
    
- when:
    
    - 섹터별 비중 top1 > sector_cap(정책)
        
    - 또는 동시 손실 클러스터가 섹터로 설명됨
        
- evidence: AGG(sector_weights), RANGE(drawdown_cluster_window)
    
- confidence: 0.5~0.7
    

---

### 6.6 SIGNAL/TIMING — 신호 약함/과필터링

**R0_SIGNAL_LOW_EDGE**

- category: SIGNAL
    
- tag: `LOW_SHARPE`
    
- severity: ERROR
    
- when:
    
    - sharpe_net < 0.2 and return_total_net <= 0
        
    - 또는 profit_factor < 1.0
        
- evidence: METRIC(sharpe_net, profit_factor)
    
- confidence: 0.6
    

**R0_TIMING_OVER_FILTERING**

- category: TIMING
    
- tag: `OVER_FILTERING`
    
- severity: WARN/ERROR
    
- when:
    
    - trade_count < min_trades AND entry_reject_ratio 높음(OBS-500 reason)
        
- evidence: METRIC(trade_count), LOG_REF(entry reject reasons)
    
- suggested_actions:
    
    - `REMOVE_OR_WEAKEN_FILTER` (제약으로는 “최대 cmp_count 감소” 같은 형태로 표현 가능)
        
- confidence: 0.5~0.7
    

**R0_SIGNAL_OOS_DECAY**

- category: SIGNAL
    
- tag: `OOS_DECAY`
    
- severity: ERROR
    
- when:
    
    - retention_sharpe < policy.oos_retention_min
        
- evidence: METRIC(is_sharpe, oos_sharpe), THRESHOLD
    
- confidence: 0.6
    

---

## 7) 출력 규칙(요약/액션)

- FailureRecord.summary는 1~2문장(짧고 단정)
    
- suggested_actions는 “확정 처방”이 아니라 **후속 MOD-450이 참고할 힌트** 수준으로만 생성(v0)
    

---

## 8) 테스트 요구사항

- 룩어헤드 DQ 레코드가 있으면 무조건 LOOKAHEAD_DETECTED가 생성되는지
    
- 슬리피지 p95 임계 초과 시 EXECUTION 태그가 생성되는지
    
- trade_count 부족 + entry reject 비율 높으면 OVER_FILTERING이 생성되는지
    
- 병합 규칙: 동일 tag가 여러 번 잡혀도 FailureRecord는 1개로 합쳐지는지
    
- confidence가 증거 추가에 따라 증가하는지(단조성)
    

---

다음은 Root-cause Analyzer 파트의 마지막 문서인 **MOD-442 — Evidence Builder(어떤 로그/구간/지표를 근거로 남기는가)**야.  
“다음”이라고 하면 MOD-442 하나만 이어서 작성할게.