## Evidence Builder (근거 수집/구간/샘플링 규격)

- **문서 ID**: MOD-442
    
- **제목**: Evidence Builder Specification (Evidence Extraction & Packaging)
    
- **버전**: 1.0
    
- **목표**: Analyzer(MOD-441)가 생성한 failure 판단을 “말”이 아니라 **증거(evidence)** 로 고정하기 위해, 어떤 메트릭/로그/구간을 어떻게 뽑아 FailureRecord(MOD-440)에 첨부할지 표준화한다.
    
- **범위**: evidence 타입별 추출 규칙, 로그 쿼리/샘플링, 기간 구간 선정, 재현 가능한 ref 생성, 데이터 최소화(요약) 정책.
    
- **비범위**: 진단 룰 자체(MOD-441), 제약 변환(MOD-450)
    

---

## 1) Evidence Builder 책임(Responsibilities)

1. **증거 추출**: METRIC/SLICE/LOG_REF/RANGE/AGG 증거를 자동 생성
    
2. **샘플링 정책**: 로그 전체를 붙이지 않고 “대표 샘플 + 집계”로 최소화
    
3. **재현성**: evidence.ref가 실제 아티팩트(파일/DB)에서 재조회 가능한 포인터여야 함
    
4. **일관된 포맷**: FailureRecord.evidence[]가 항상 동일 필드/타입을 가지도록 보장
    
5. **프라이버시/용량 관리**: 불필요한 원문/대량 로그 노출을 막음(로컬 저장소 기준)
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `BuildEvidenceRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",

  "failure_hint": {
    "category": "EXECUTION",
    "tags": ["SLIPPAGE_P95_HIGH"],
    "time_windows": null
  },

  "sources": {
    "metrics_ref": "path/metrics.json",
    "trades_ref": "path/obs520.jsonl",
    "orders_fills_ref": "path/obs510.jsonl",
    "decision_logs_ref": "optional path/obs500.jsonl",
    "dq_checks_ref": "path/obs540.jsonl"
  },

  "policy": {
    "max_log_samples": 30,
    "max_ranges": 3,
    "range_method": "worst_drawdown|worst_slippage|worst_cluster",
    "include_raw_examples": true
  }
}
```

### 2.2 출력: `BuildEvidenceResponse`

```json
{
  "evidence": [
    { "type": "METRIC", "ref": "metrics.execution.slippage_bps_p95", "value": 28.0, "threshold": 25.0 },
    { "type": "RANGE", "ref": "equity_curve", "start": "2022-04-01", "end": "2022-06-15" },
    { "type": "LOG_REF", "ref": "obs510:fills", "query": "slippage_bps>=25 order by slippage_bps desc limit 10" }
  ],
  "artifacts": {
    "evidence_pack_path": "path/evidence_pack.json",
    "sample_logs_path": "path/evidence_samples.jsonl"
  },
  "warnings": []
}
```

---

## 3) Evidence 타입별 추출 규칙

## 3.1 METRIC Evidence

- 목적: 임계 위반을 “값+임계치”로 명시
    
- 규칙:
    
    - `ref`: SCHEMA-340 json pointer(문자열)
        
    - `value`: 해당 값
        
    - `threshold`: policy 또는 룰에서 사용한 임계값(가능하면 포함)
        

예:

```json
{ "type":"METRIC", "ref":"metrics.overall.max_drawdown_net", "value":-0.41, "threshold":-0.35 }
```

---

## 3.2 SLICE Evidence

- 목적: 특정 구간(IS/OOS, 레짐, WFA fold)에서의 붕괴를 명시
    
- 규칙:
    
    - `ref`: `metrics.slices.<slice_name>.<metric>` 또는 robustness case id
        
    - `value`: slice metric
        
    - 필요 시 `start/end`를 RANGE로 같이 제공
        

예:

```json
{ "type":"SLICE", "ref":"metrics.slices.regime.RISK_OFF.sharpe_net", "value":-0.12, "threshold":0.10 }
```

---

## 3.3 AGG Evidence (집계)

- 목적: 로그에서 유도된 비율/분포(p50/p95) 등
    
- 규칙:
    
    - source 로그(ref) + 집계 정의를 `ref/query`로 표현
        
    - `value`는 결과값(수치)
        
    - `notes`에 집계 방식(예: p95, window=30d)
        

예:

```json
{ "type":"AGG", "ref":"obs510:fills:slippage_bps_p95", "value":28.0, "notes":"p95 over all fills" }
```

---

## 3.4 RANGE Evidence (기간 구간)

- 목적: “어느 기간에” 문제가 집중되었는지 명시
    
- 생성 방법(정책으로 선택):
    
    - `worst_drawdown`: 최대 낙폭이 발생한 구간
        
    - `worst_slippage`: 슬리피지가 큰 이벤트가 집중된 구간
        
    - `worst_cluster`: 연속 손실/거절이 클러스터링된 구간
        

규칙:

- 최대 `max_ranges`개만 생성(기본 3)
    
- ref는 `equity_curve` 또는 `obs510` 등 소스 지정
    

---

## 3.5 LOG_REF Evidence (대표 샘플)

- 목적: “실제 로그 예시”를 소량 첨부해 재현/디버깅 가능하게
    
- 원칙:
    
    - 전체 로그 첨부 금지, **query + 상위 N개 샘플만**
        
    - 샘플은 `sample_logs_path`에 저장하고 FailureRecord에는 포인터만
        

LOG_REF 필드:

- `ref`: `obs500|obs510|obs520|obs540:<subtype>`
    
- `query`: 필터/정렬/limit을 표현하는 문자열(엔진 내부에서 해석)
    
- (옵션) `notes`: 왜 이 샘플을 뽑았는지
    

예:

```json
{
  "type":"LOG_REF",
  "ref":"obs500:entry",
  "query":"entry_allowed=false and reason_codes contains 'DATA_MISSING' group by symbol limit 10"
}
```

---

## 4) 태그별 “기본 증거 패턴” 템플릿

Evidence Builder는 tag별로 기본적으로 붙일 증거 세트를 갖는다(룰이 미지정해도 됨).

### 4.1 LOOKAHEAD_DETECTED

- METRIC/THRESHOLD: execution_timing
    
- LOG_REF: obs540 lookahead warnings top 5
    
- severity CRITICAL이므로 raw examples 포함 권장
    

### 4.2 SLIPPAGE_P95_HIGH

- METRIC: slippage_bps_p95 + threshold
    
- LOG_REF: slippage 상위 fills 10개
    
- RANGE: 슬리피지 큰 이벤트 구간 1~2개
    

### 4.3 OVER_FILTERING

- METRIC: trade_count, entry_reject_ratio
    
- LOG_REF: entry_allowed=false reason 상위 10
    
- RANGE: 신호가 거의 없던 구간(옵션)
    

### 4.4 OOS_DECAY

- SLICE: is_sharpe, oos_sharpe, retention
    
- RANGE: OOS 구간 전체(또는 최악 구간)
    
- (옵션) robustness WFA fail fold 1~2개
    

### 4.5 SECTOR_CONCENTRATION

- AGG: top_sector_weight
    
- LOG_REF: 보유 종목 상위 섹터 리스트(스냅샷)
    
- RANGE: 동시 손실 구간 1개
    

---

## 5) 증거 패키징(Artifacts)

Evidence Builder는 failure마다 “증거팩”을 생성한다.

### 5.1 파일 규격(권장)

- `evidence_pack.json`:
    
    - evidence[] 전체 + 요약(meta)
        
- `evidence_samples.jsonl`:
    
    - query 결과 샘플 로그 레코드들(원본 일부)
        

경로:  
`artifacts/runs/<run_id>/strategies/<strategy_id>/analysis/<failure_id>/...`

---

## 6) 데이터 최소화/보안 정책

- `max_log_samples`를 넘는 원문 로그는 저장하지 않는다.
    
- 샘플 레코드는 PII가 없어야 한다(거래 시스템 내부에서 대부분 해당 없음).
    
- 필요 이상으로 긴 텍스트/원문을 저장하지 않는다(로컬 KB 용량 관리).
    

---

## 7) 에러/예외 처리

- `SOURCE_NOT_FOUND`: 아티팩트 경로 없음 → warnings에 기록, METRIC만이라도 생성
    
- `QUERY_PARSE_FAIL`: query 문법 오류 → LOG_REF 생성을 스킵 + WARN
    
- `INSUFFICIENT_DATA_FOR_RANGE`: equity_curve 너무 짧음 → RANGE 생략
    

---

## 8) 테스트 요구사항

- tag별 기본 증거 패턴이 항상 생성되는지(가능한 소스가 있을 때)
    
- max_log_samples가 정확히 지켜지는지
    
- LOG_REF query가 sample_logs_path로 재현 가능한지(포인터 유효성)
    
- RANGE 생성이 max_ranges를 넘지 않는지
    
- 누락 소스가 있어도 failure 기록 생성이 완전히 깨지지 않는지(부분 성공)
    

---
