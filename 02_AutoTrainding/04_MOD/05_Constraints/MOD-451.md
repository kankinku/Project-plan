## Constraint Applicator (Generator/Portfolio/Execution 주입)

- **문서 ID**: MOD-451
    
- **제목**: Constraint Applicator Specification (Inject & Enforce Constraints)
    
- **버전**: 1.0
    
- **목표**: ConstraintSet(SCHEMA-330)을 **각 적용 지점(Generator/Backtest/Portfolio/Execution/Scenario)** 에 일관되게 주입하고, 위반 시 **결정 로그(OBS-500)** 와 상태/결과에 반영하여 “같은 실수 반복 방지”를 시스템적으로 보장한다.
    
- **범위**: 제약의 스코프/적용 순서/집행 방식, 위반 처리, 로그/증거 남기기, 엔진별 주입 방식(A/B), 정책(soft/hard).
    
- **비범위**: 제약 생성(MOD-450), 제약 수명/회귀(MOD-452)
    

---

## 1) Constraint Applicator 책임(Responsibilities)

1. **스코프 라우팅**: 제약을 적용 대상 모듈로 분배(generator/execution/portfolio/data 등)
    
2. **집행(enforcement)**: hard 제약은 반드시 막고, soft 제약은 선호/페널티로 반영
    
3. **순서 보장**: “먼저 걸러야 하는 제약”을 우선 적용(성능/안전)
    
4. **관측(OBS)**: 제약이 작동한 순간을 reason_codes + evidence로 남김
    
5. **엔진 호환**: Backtest Engine A/B 모두에서 제약 의미가 유지되도록 “공통 매핑” 제공
    

---

## 2) 제약 스코프(Scope) 정의

ConstraintSet의 각 constraint는 다음 scope를 가진다고 가정한다.

- `GENERATOR`: 전략 생성/템플릿/원자 규칙 선택
    
- `SAMPLER`: 파라미터 범위/분포
    
- `NORMALIZER`: 복잡도 제한(선택, 보통 Generator/Normalizer 양쪽)
    
- `BACKTEST`: 백테스트 설정(기간/유니버스/바간격)
    
- `EXECUTION`: 주문/체결(스프레드/ADV/주문타입/지연)
    
- `PORTFOLIO`: 최대 종목수/비중/섹터/레버리지
    
- `DATA`: 룩어헤드 방지/결측 정책
    
- `SCENARIO`: 시나리오 반영 시 제한(soft 반영 강도)
    

---

## 3) 입력/출력(Interface)

### 3.1 입력: `ApplyConstraintsRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,
  "constraint_set": { "constraint_set_id": "cs_02", "constraints": [] },

  "context": {
    "phase": "GENERATION|BACKTEST_A|BACKTEST_B|LIVE",
    "strategy_candidate": { "optional": true, "...": "..." },
    "backtest_request": { "optional": true, "...MOD-420..." },
    "order_intent": { "optional": true, "...MOD-424..." },
    "portfolio_snapshot": { "optional": true, "...MOD-425..." }
  },

  "policy": {
    "soft_behavior": "prefer|penalize|warn_only",
    "hard_behavior": "block",
    "log_violations": true
  }
}
```

### 3.2 출력: `ApplyConstraintsResponse`

```json
{
  "status": "ALLOWED|MODIFIED|BLOCKED",
  "modified": {
    "strategy_candidate": null,
    "backtest_request": null,
    "order_intent": null
  },
  "violations": [
    {
      "constraint_id": "c_101",
      "scope": "EXECUTION",
      "hardness": "HARD",
      "code": "EXEC_SPREAD_TOO_WIDE",
      "message": "spread 15.2 > max 10"
    }
  ],
  "reason_codes": ["CONSTRAINT_BLOCKED_EXEC_SPREAD"],
  "warnings": []
}
```

---

## 4) 적용 순서(Order of Enforcement)

### 4.1 전체 순서(권장)

1. **DATA**: 룩어헤드/결측 정책 (가장 먼저)
    
2. **BACKTEST**: 유니버스/기간/바간격 (리소스 절감)
    
3. **GENERATOR/SAMPLER/NORMALIZER**: 생성 공간 축소
    
4. **PORTFOLIO**: 목표 포지션/비중/레버리지 (주문 의도 생성 전)
    
5. **EXECUTION**: 주문 생성/전송 직전 최종 게이트
    
6. **SCENARIO**: 시나리오 반영 시 soft 강도(옵션)
    

---

## 5) soft vs hard 집행 방식

### 5.1 HARD

- **반드시 차단(block)** 또는 설정 강제(modify)  
    예:
    
- execution_timing은 hard로 `next_bar` 강제
    
- order_type_allowlist에 없으면 주문 BLOCK
    

### 5.2 SOFT (3가지 모드)

- `prefer`: 생성/선택 확률을 조정(템플릿 가중치, 파라미터 분포)
    
- `penalize`: Scorer에 페널티로 전달(또는 후보 점수 하향)
    
- `warn_only`: 로그만 남기고 진행(초기 디버깅)
    

---

## 6) 모듈별 주입(Injection Points)

## 6.1 Generator/Sampler 주입

- `BAN_TEMPLATE`, `BAN_ATOM`:
    
    - MOD-410 템플릿 선택에서 제외
        
- `LIMIT_PARAM_RANGE`:
    
    - MOD-411 sampler의 param range를 교체/축소
        
- `MAX_COMPLEXITY`:
    
    - MOD-410 생성 시점에 제한
        
    - MOD-412에서도 최종 컷(이중 안전장치)
        

**위반 로그(권장)**: 후보가 버려질 때 내부 통계 + (샘플링 모드에서만) OBS-500 “generation_gate” 레코드(옵션)

---

## 6.2 Backtest 요청 주입

- `BACKTEST_UNIVERSE_LIMIT`:
    
    - universe_version 또는 심볼 목록을 제한
        
- `BAR_INTERVAL_ALLOWLIST`:
    
    - 전략이 요구하는 bar_interval이 금지면 BLOCK
        
- `PERIOD_LIMIT`:
    
    - 학습/평가 기간 정책을 강제(예: 최소 5년)
        

---

## 6.3 Portfolio 주입

- `MAX_POSITIONS`, `MAX_POSITION_WEIGHT`, `SECTOR_CAP`, `LEVERAGE_LIMIT`:
    
    - 목표 포지션 계산 전에 적용
        
- 위반 시 처리:
    
    - HARD: 주문 의도 생성 자체를 막음
        
    - SOFT: 사이징을 자동 축소(modify) + WARN
        

**OBS-500**: module=portfolio에서 violations와 적용된 수정 기록

---

## 6.4 Execution 주입

- `MAX_SPREAD_BPS`, `MAX_ADV_PARTICIPATION`, `ORDER_TYPE_ALLOWLIST`, `LATENCY_GUARD`:
    
    - MOD-424 ExecuteRequest의 constraints로 전달
        
    - 위반 시 Engine B는 주문 REJECT(또는 Applicator 단계에서 BLOCK)
        

**OBS-500**: module=execution_gate에서 `order_allowed=false` + reason  
**OBS-510**: REJECTED order 레코드(가능하면)

---

## 6.5 Data 주입

- `EXECUTION_TIMING=next_bar` 강제
    
- `NAN_POLICY=DISALLOW_TRADE` 강제
    
- 룩어헤드 금지 피처(있다면) `BAN_FEATURES`
    

**OBS-540**: 위반 탐지 시 CRITICAL  
(룩어헤드 관련은 Applicator에서 “사전 방지”, OBS-540에서 “사후 검증”)

---

## 6.6 Scenario 주입(옵션, V2)

- 시나리오가 특정 자산/레짐 가정을 요구할 때:
    
    - “soft 반영 강도”를 제한(예: scenario_weight cap)
        
- 시나리오가 검증 불가능하면:
    
    - BLOCK 또는 WARN(정책)
        

---

## 7) 위반 처리 결과(Status)

- `ALLOWED`: 제약 위반 없음
    
- `MODIFIED`: 제약으로 인해 입력이 수정됨(예: qty 축소, param range 축소)
    
- `BLOCKED`: hard 제약 위반으로 진행 불가
    

---

## 8) 로깅/증거(Observability)

### 8.1 reason_codes 표준(예)

- `CONSTRAINT_BLOCKED_*`
    
- `CONSTRAINT_MODIFIED_*`
    
- `CONSTRAINT_SOFT_PREFERRED_*`
    

### 8.2 Evidence 생성(연동)

- violation이 빈번한 제약은 MOD-442 Evidence Builder가:
    
    - “몇 번 막았는지” 집계(AGG evidence)로 사용 가능
        

---

## 9) 예외/에러 처리

- `CONSTRAINT_SCHEMA_INVALID`: constraint 자체가 SCHEMA-330 위반
    
- `UNKNOWN_SCOPE`: scope 미정 → WARN + 무시(또는 FAILSAFE 정책이면 BLOCK)
    
- `CONSTRAINT_CONFLICT`: 같은 scope에서 상충 → FAILSAFE_FIRST면 더 엄격 적용
    

---

## 10) 테스트 요구사항

- LIMIT_PARAM_RANGE가 sampler에 실제 반영되는지(샘플 값 범위 검증)
    
- ORDER_TYPE_ALLOWLIST 위반 시 order_intent가 BLOCKED 되는지
    
- max_spread_bps 위반이 execution_gate(OBS-500) + order reject(OBS-510)로 남는지
    
- SOFT 모드에서 prefer/penalize/warn_only가 기대대로 동작하는지
    
- Engine A/B 모두 동일 의미로 constraint가 적용되는지(호환성)
    

---
