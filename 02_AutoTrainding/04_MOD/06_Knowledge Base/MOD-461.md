## Document Store (비정형: 리포트/사유/시나리오)

- **문서 ID**: MOD-461
    
- **제목**: Document Store Specification (Unstructured Knowledge Store)
    
- **버전**: 1.0
    
- **목표**: 리포트(PDF/HTML), 분석 요약, 시나리오 입력, 사람의 코멘트, 근거(evidence pack) 등 **비정형/반정형 문서**를 로컬에 축적하고, Local DB(MOD-460)와 연결하여 “대화/검색/회고”에 활용 가능하게 한다.
    
- **범위**: 문서 타입, 저장 경로/메타데이터, 인덱싱(태그/링크), 버전/불변성, 접근 API, 보관 정책.
    
- **비범위**: 벡터 검색/유사도 검색의 구현(=MOD-462 Retriever), 문서 생성 자체(=MOD-433)
    

Q

## 1) Document Store 책임(Responsibilities)

1. **비정형 문서 저장**: PDF/HTML/markdown/jsonl 등 파일 기반 저장
    
2. **메타데이터 관리**: 문서의 출처(run/strategy), 타입, 태그, 요약, 해시를 기록
    
3. **불변성/재현성**: 생성 시점의 결과를 “스냅샷”으로 고정(나중에 덮어쓰기 금지)
    
4. **링킹**: Local DB 레코드(backtest_id, failure_id 등)와 상호 참조
    
5. **검색 준비**: Retriever가 문서를 빠르게 찾을 수 있도록 최소 인덱스를 제공
    

---

## 2) 저장 방식(권장)

- **파일 시스템 기반 + 메타데이터 JSON** (MVP)
    
- 확장 시:
    
    - S3/MinIO 같은 오브젝트 스토어로 교체 가능(인터페이스 유지)
        
- 원칙:
    
    - “원문은 파일”, “검색용 키/경로는 DB/메타에”
        

---

## 3) 문서 타입(Document Types)

문서 타입은 enum으로 고정하고 확장 가능하게 설계한다.

### 3.1 핵심 타입

- `REPORT_TEARSHEET_HTML`
    
- `REPORT_TEARSHEET_PDF`
    
- `REPORT_SUMMARY_JSON`
    
- `EVIDENCE_PACK_JSON`
    
- `EVIDENCE_SAMPLES_JSONL`
    
- `SCENARIO_INPUT_JSON` (NL→JSON 결과)
    
- `SCENARIO_EVAL_JSON` (타당성 평가 결과)
    
- `HUMAN_NOTE_MD` (사람 메모/해석)
    
- `SYSTEM_NOTE_MD` (시스템 생성 요약/경고)
    
- `MODEL_TRACE_JSON` (선택: 실행 추적/디버그)
    

---

## 4) 디렉토리/경로 규격(표준)

MOD-433 아티팩트 경로 규격과 호환되게 한다.

권장 루트:  
`docstore/`

권장 구조:

```
docstore/
  runs/<run_id>/
    strategies/<strategy_id>/
      reports/<backtest_id>/
        tearsheet.html
        tearsheet.pdf
        summary.json
      analysis/<failure_id>/
        evidence_pack.json
        evidence_samples.jsonl
      scenarios/<scenario_id>/
        scenario_input.json
        scenario_eval.json
      notes/
        human_<ts>.md
        system_<ts>.md
  global/
    templates/
    playbooks/
```

---

## 5) 문서 메타데이터(Document Metadata)

각 문서는 반드시 메타데이터를 가진다(파일+sidecar 또는 DB 테이블).

### 5.1 `document_meta.json` (권장)

```json
{
  "doc_id": "uuid",
  "doc_type": "REPORT_TEARSHEET_PDF",
  "created_at": "2026-02-06T08:00:00Z",

  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",
  "backtest_id": "bt_001",
  "failure_id": null,
  "scenario_id": null,

  "title": "Strategy bt_001 Tearsheet",
  "tags": ["verification", "rsi", "stoch", "trend"],
  "summary": "OOS 유지율은 낮으나 실행 품질은 양호",

  "hash": { "sha256": "..." },
  "size_bytes": 123456,
  "format": "pdf",
  "schema_versions": ["SCHEMA-340"],
  "policy_versions": ["score_v1", "rules_v0"]
}
```

### 5.2 메타데이터 저장 위치

- 옵션 A(간단): 문서 파일 옆에 `*.meta.json`로 저장
    
- 옵션 B(정형): MOD-460에 `documents` 테이블 추가 + 파일 경로 참조  
    MVP는 A, 확장은 B 추천.
    

---

## 6) 불변성/버전 정책

- 원칙: 같은 `(run_id, iteration_id, backtest_id)`에 대해 문서는 **새로 생성**(덮어쓰기 금지)
    
- 업데이트가 필요하면:
    
    - 새 doc_id 생성 + `supersedes_doc_id` 필드로 연결(옵션)
        
- 해시(sha256)로 내용 동일성 검증 가능
    

---

## 7) 인덱싱(검색 준비)

Retriever(MOD-462) 전 단계로 “라이트 인덱스”를 둔다.

### 7.1 필수 인덱스 키

- run_id, strategy_id, backtest_id, failure_id, scenario_id
    
- doc_type, created_at
    
- tags
    

### 7.2 태그 생성 규칙(권장)

- strategy_spec에서 파생:
    
    - `uses_rsi`, `uses_stoch`, `uses_adx`, `uses_ema_stack` 등
        
- failures에서 파생:
    
    - `oos_decay`, `slippage_high`, `sector_concentration` 등
        
- score/policy에서 파생:
    
    - `passed`, `verification`, `exploration`
        

---

## 8) 접근 API(개념)

- `docstore.put(doc_type, bytes/path, meta) -> doc_id, path`
    
- `docstore.get(doc_id) -> path/meta`
    
- `docstore.list(filters={run_id, strategy_id, doc_type, tags}) -> docs[]`
    
- `docstore.link(doc_id, backtest_id/failure_id)` (옵션)
    

---

## 9) 보관/청소(Retention)

- 원문 리포트/증거는 용량이 커지므로 정책 필요:
    
    - exploration 단계: 상위 K개 전략만 PDF 유지, 나머지는 summary.json만 유지(옵션)
        
    - evidence_samples는 max N lines 유지
        
- 삭제는 “물리 삭제”보다:
    
    - meta에서 `archived=true`로 표시하고 이동(권장)
        
    - 실제 삭제는 별도 오프라인 작업
        

---

## 10) 예외/에러 처리

- `WRITE_FAIL`: 디스크 쓰기 실패 → 즉시 실패 반환(중요)
    
- `META_MISSING`: 메타 누락 → 경고 + 최소 메타 자동 생성
    
- `HASH_MISMATCH`: 저장 후 검증 실패 → 재시도 또는 실패
    
- `PATH_CONFLICT`: 같은 경로 충돌 → suffix 부여(버전)
    

---

## 11) 테스트 요구사항

- doc_id 생성이 유일하고 재현 가능한 경로에 저장되는지
    
- meta에 run/strategy/backtest 링크가 누락되지 않는지
    
- 덮어쓰기 방지(동일 키로 저장 시 새 파일 생성)
    
- tags로 문서 필터링이 되는지
    
- sha256 해시가 저장 내용과 일치하는지
    

---
