# MOD-462 — Retriever (유사 실패/유사 전략 검색)

- **문서 ID**: MOD-462
    
- **제목**: Retriever Specification (Similar Strategy / Similar Failure Retrieval)
    
- **버전**: 1.0
    
- **목표**: Local DB(MOD-460) + Document Store(MOD-461)에 축적된 지식을 기반으로, 현재 전략/실패/시나리오와 **유사한 과거 사례**를 빠르게 찾아서 Analyzer/Constraint/Scenario 반영에 재사용한다.
    
- **범위**: 검색 인덱스 구조, 쿼리 타입, 랭킹/필터링, API, 캐시/상태, 로그/평가.
    
- **비범위**: 문서 생성(MOD-433), 실패 진단 룰(MOD-441), 제약 생성(MOD-450)
    

---

## 1) Retriever 책임(Responsibilities)

1. **유사 전략 검색**: 구조(AST/피처/연산자/파라미터) 유사도를 기반으로 과거 전략을 찾음
    
2. **유사 실패 검색**: category/tags/evidence 패턴이 비슷한 failure 사례를 찾음
    
3. **문서 검색**: 리포트/요약/노트(비정형)에서 관련 근거/해석을 찾음
    
4. **하이브리드 랭킹**: 정형 필터 + 키워드(BM25) + 임베딩(semantic) + 규칙 점수를 결합
    
5. **재현성/추적성**: 어떤 근거로 무엇을 추천했는지 trace를 남김(후속 분석/디버깅)
    

---

## 2) 검색 대상(Indexed Objects)

Retriever는 최소 3종류의 “인덱싱 단위”를 가진다.

### 2.1 StrategyIndexItem

- key: `strategy_id`
    
- payload(요약):
    
    - feature_set, operators, ast_shape(깊이/비교수), param_ranges
        
    - tags(uses_rsi/uses_stoch/uses_adx…)
        
    - (선택) spec_summary_text(짧은 설명)
        

### 2.2 FailureIndexItem

- key: `failure_id`
    
- payload:
    
    - category, tags, severity, confidence
        
    - evidence 요약(핵심 metric refs / thresholds)
        
    - linked strategy_id/backtest_id
        

### 2.3 DocumentIndexItem

- key: `doc_id`
    
- payload:
    
    - doc_type, tags, summary, title
        
    - fulltext(가능하면: html/markdown/json summary)
        
    - linked run/strategy/backtest/failure/scenario ids
        

---

## 3) 인덱스 구성(Indexing Architecture)

### 3.1 정형 필터 인덱스(필수)

- DB 인덱스(또는 별도 역색인):
    
    - by tag, category, date, engine_mode, asset/universe, bar_interval
        
- 목적: 후보군을 먼저 줄여 속도/정확도 확보
    

### 3.2 키워드 인덱스(BM25/TF-IDF) (권장)

- DocumentIndexItem의 title/summary/fulltext 대상으로 구축
    
- “정확한 키워드(예: SLIPPAGE_P95_HIGH)”에 강함
    

### 3.3 임베딩(semantic) 인덱스(권장)

- Strategy/Failure/Document 각각에 대해 embedding 벡터 저장
    
- 목적: 표현이 달라도 의미가 비슷한 사례 검색
    

> 임베딩 공급자는 플러그형(로컬 모델/외부 API). 중요한 건 **embedding_model_version**을 메타로 고정하는 것(재현성).

### 3.4 구조 유사도 인덱스(전략 전용, 권장)

- AST 기반 “구조 시그니처”를 저장:
    
    - 예: `ast_depth`, `cmp_count`, `op_multiset_hash`, `feature_multiset_hash`
        
- 빠른 후보 생성:
    
    - 동일/유사 해시 버킷에서 먼저 후보를 뽑고, 세부 스코어링
        

---

## 4) 쿼리 타입(Query Types)

### 4.1 `similar_strategies`

**입력(예)**:

- strategy_id 또는 strategy_spec(AST)
    
- 옵션 필터: bar_interval, asset_class, universe_version, 기간, engine_mode(B/A)
    

**출력(예)**:

- topK 전략과:
    
    - similarity_score
        
    - 핵심 메트릭/스코어 요약
        
    - “유사한 이유”(공통 feature/operator/템플릿)
        

### 4.2 `similar_failures`

**입력**:

- failure_record(또는 category/tags/evidence 힌트)
    
- 필터: severity, confidence_min, 최근 기간, engine_mode
    

**출력**:

- topK failure 사례 + linked constraints/provenance(있으면)
    
- “해결된 방식(어떤 제약이 효과적이었나)” 요약 가능
    

### 4.3 `search_docs`

**입력**:

- text query(예: “oos decay rsi stoch”, “adv cap binding 해결”)
    
- 필터: doc_type, tags, run_id/strategy_id scope
    

**출력**:

- topK 문서 meta + snippet/요약 + 경로
    

---

## 5) 입력/출력(Interface)

### 5.1 입력: `RetrieveRequest`

```json
{
  "query_type": "similar_strategies|similar_failures|search_docs",
  "query": {
    "strategy_id": "optional",
    "strategy_spec": "optional",
    "failure": "optional",
    "text": "optional"
  },
  "filters": {
    "asset_class": "optional",
    "bar_interval": "optional",
    "engine_mode": "A|B|optional",
    "tags_any": ["optional"],
    "tags_all": ["optional"],
    "category": "optional",
    "date_from": "optional",
    "date_to": "optional"
  },
  "k": 20,
  "policy": {
    "ranking": "hybrid",
    "min_confidence": 0.0,
    "explain": true
  }
}
```

### 5.2 출력: `RetrieveResponse`

```json
{
  "results": [
    {
      "id": "strategy_id|failure_id|doc_id",
      "type": "STRATEGY|FAILURE|DOC",
      "score": 0.82,
      "highlights": ["shared: RSI, STOCH", "same operator set: AND/CMP"],
      "refs": { "backtest_id": "bt_001", "paths": ["..."] }
    }
  ],
  "trace": {
    "candidate_counts": { "filtered": 1200, "bm25": 200, "ann": 100 },
    "rank_factors": ["filter", "bm25", "embedding", "structure"]
  },
  "warnings": []
}
```

---

## 6) 랭킹(Hybrid Ranking) 규칙

### 6.1 Candidate Generation(후보 생성) — 순서

1. **필터로 축소**: tags/category/기간/엔진/자산군
    
2. **구조/해시 후보**(전략): 같은 feature/operator 버킷
    
3. **BM25 후보**(문서/실패): 키워드 상위 N
    
4. **ANN 후보**(임베딩): topN nearest neighbors
    

### 6.2 Scoring(가중 합, v1 예시)

- Strategy:
    
    - `S = 0.45*structure + 0.35*embedding + 0.20*tags_overlap`
        
- Failure:
    
    - `S = 0.40*tag_overlap + 0.30*embedding + 0.30*evidence_pattern_match`
        
- Docs:
    
    - `S = 0.50*bm25 + 0.50*embedding` (필터는 별도)
        

> 실제 가중치는 policy_version으로 고정(“retriever_v1”)하고 변경 시 버전 업.

### 6.3 Explain(설명)

`explain=true`일 때 결과마다:

- 공통 태그/피처
    
- 유사한 failure tag
    
- 매칭된 metric ref(예: slippage_p95, reject_rate)
    
- 상위 1~3개 근거만 제공(과도한 노이즈 방지)
    

---

## 7) 상태(State) & 캐시

### 7.1 상태

- `INDEX_BUILDING`
    
- `READY`
    
- `STALE` (새 문서/전략 추가로 재색인 필요)
    
- `ERROR`
    

### 7.2 캐시(권장)

- 최근 쿼리 결과 캐시(LRU, TTL)
    
- 전략/실패 embedding 캐시(계산 비용 절감)
    

---

## 8) 인덱싱 파이프라인(Index Build/Update)

### 8.1 트리거

- 새 전략 저장(MOD-460 strategies upsert)
    
- 새 failure 생성(MOD-440 failures insert)
    
- 새 문서 저장(MOD-461 put)
    

### 8.2 처리 방식

- MVP: 배치 리빌드(간단)
    
- 확장: 증분 업데이트(append + 주기적 컴팩션)
    

### 8.3 버전/재현성

- 인덱스 메타:
    
    - `index_version`, `embedding_model_version`, `tokenizer/version`, `bm25_version`
        
- 검색 결과 trace에 버전 기록(중요)
    

---

## 9) 로그(Observability)

Retriever는 “왜 이 결과가 나왔는지”를 디버깅 가능하게 남긴다.

- `RETRIEVE_REQUEST` (query_type, filters, k)
    
- `RETRIEVE_CANDIDATES` (단계별 후보 수)
    
- `RETRIEVE_RESULT_TOPK` (topK id + score + 주요 근거)
    
- `INDEX_UPDATE` (추가/삭제 문서 수, 시간)
    

---

## 10) 예외/에러 처리

- `INDEX_NOT_READY`: READY 아니면 degrade(필터/DB 검색만) + WARN
    
- `EMBEDDING_UNAVAILABLE`: 임베딩 실패 시 BM25/구조 유사도로 대체 + WARN
    
- `DOC_PARSE_FAIL`: 문서 텍스트 추출 실패 → meta만 인덱싱
    
- `SCHEMA_VERSION_MISMATCH`: strategy_spec/metrics 버전 불일치 → 해당 타입 스코어링 비활성 + WARN
    

---

## 11) 테스트 요구사항

1. **정확성(회귀)**: 동일 쿼리에서 topK 결과가 큰 폭으로 흔들리지 않는지(버전 고정)
    
2. **필터 우선**: tags_all을 주면 반드시 포함 조건을 만족하는지
    
3. **전략 유사도**: 동일 feature/operator인 전략이 상위에 오는지
    
4. **실패 유사도**: 동일 tag(OOS_DECAY 등) 사례가 상위에 오는지
    
5. **대체 경로**: 임베딩 비활성 상태에서도 결과가 반환되는지
    
6. **성능**: 후보 10만 개 수준에서 k=20을 제한 시간 내 반환(목표는 환경에 따라 정책화)
    

---

다음은 Scenario Intake(V2)로 넘어가서 **MOD-470 — Scenario Parser(NL→JSON)** 를 작성하는 흐름이 자연스러워. “다음”이라고 하면 MOD-470부터 이어갈게.