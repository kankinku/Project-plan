## Scenario → Strategy Integration (soft 반영/스트레스 테스트)

- **문서 ID**: MOD-472
    
- **제목**: Scenario Integration Specification (Soft Injection & Stress Testing)
    
- **버전**: 1.0
    
- **목표**: 품질 평가(MOD-471)를 통과한 시나리오를 “전략 생성/평가” 루프에 **과도한 확신 없이** 반영한다. 핵심은 (1) 생성 공간을 ‘완전히 고정’하지 않고 **soft bias**로 유도 (2) 시나리오가 틀렸을 때도 견디는지 **스트레스 테스트**로 검증하는 것이다.
    
- **범위**: integration mode(soft/stress_only/block), generator bias, constraint/parameter hint 주입, stress test 플랜, 결과 저장.
    
- **비범위**: NL→JSON(MOD-470), 시나리오 품질 점수(MOD-471)
    

---

## 1) Integration 책임(Responsibilities)

1. **모드 결정**: scenario_quality 결과 기반으로 `soft|stress_only|block` 선택
    
2. **Generator 유도**: 템플릿/피처/파라미터에 “선호”를 부여(soft constraints)
    
3. **스트레스 플랜 생성**: 시나리오와 반대/불리 조건에서 robustness 케이스 자동 추가
    
4. **결과 라벨링**: “시나리오 친화/비친화에서 성능 유지”를 지표화하여 KB에 저장
    
5. **안전장치**: 시나리오가 탐색을 망치지 않도록 cap/만료/충돌 규칙 적용
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `ScenarioIntegrateRequest`

```json
{
  "run_id": "uuid",
  "iteration_id": 12,

  "scenario_id": "uuid",
  "parsed_scenario": { "...SCHEMA-SCENARIO-470..." },
  "quality": { "...MOD-471..." },

  "base_constraints": { "...SCHEMA-330..." },
  "generator_context": {
    "asset_class": "equity|crypto|mixed",
    "universe_version": "v1",
    "bar_interval": "1d"
  },

  "policy": {
    "default_mode": "stress_only",
    "max_bias_strength": 0.6,
    "bias_expiry_iterations": 10,
    "require_stress_tests": ["regime_split", "cost_stress"],
    "conflict_policy": "FAILSAFE_FIRST"
  }
}
```

### 2.2 출력: `ScenarioIntegrateResponse`

```json
{
  "scenario_id": "uuid",
  "mode": "soft|stress_only|block",

  "bias": {
    "strength": 0.4,
    "expires_after_iterations": 10,
    "generator_preferences": {
      "prefer_features": ["RSI", "STOCH"],
      "prefer_templates": ["mean_reversion_v1"],
      "param_hints": [{ "name": "rsi_low", "target": 30, "range": [25, 35] }]
    }
  },

  "constraints_delta": {
    "added_soft_constraints": [{ "...SCHEMA-330..." }],
    "notes": ["soft only, do not block generation"]
  },

  "stress_plan": {
    "enabled": true,
    "cases": [
      { "id": "SC_STRESS_1", "type": "regime_split", "variant": "opposite_regime" },
      { "id": "SC_STRESS_2", "type": "execution_stress", "variant": "worse_slippage" }
    ]
  },

  "warnings": []
}
```

---

## 3) 모드 결정(Mode Selection)

quality.integration_policy_hint을 우선한다.

- `block`:
    
    - gate fail 또는 overall 매우 낮음
        
    - 결과: 전략 생성/선정에 반영하지 않고 “추가 입력 필요” 플래그만 저장
        
- `stress_only`:
    
    - 모호/검증 약함(하지만 참고할 가치는 있음)
        
    - 결과: 생성 bias는 주지 않고, robustness에 “시나리오 관련 스트레스 케이스”만 추가
        
- `soft`:
    
    - overall/verify 점수 충분
        
    - 결과: **soft bias + stress tests** 둘 다 적용
        

---

## 4) Soft Bias 설계(핵심 원칙)

### 4.1 Bias는 “제약”이 아니라 “선호”

- HARD 금지: 시나리오가 특정 전략을 강제로 고정하면 과최적화/확증편향 위험
    
- 구현:
    
    - Generator의 템플릿 선택 확률 가중치 조정
        
    - Sampler의 분포 중심을 이동(범위를 줄이진 않거나 약하게만)
        
    - Scorer에 “scenario_alignment bonus”를 아주 작게 추가(선택)
        

### 4.2 bias_strength cap

- `strength <= max_bias_strength` (기본 0.6)
    
- verifiability가 낮으면 strength를 자동 감쇄:
    
    - `strength = min(cap, overall/100 * verify/100)`
        

### 4.3 만료(Expiry)

- bias는 `bias_expiry_iterations` 이후 자동 약화/해제(=MOD-452와 유사)
    
- 잘못된 시나리오가 장기간 탐색을 망치는 것을 방지
    

---

## 5) 시나리오 → Preference 매핑 규칙(v0)

시나리오의 `expected_moves.direction`과 `category`에 따라 기본 매핑을 만든다.

### 5.1 direction = up/down (가격 방향)

- 추세/모멘텀 계열 템플릿 선호(예: breakout/trend_follow)
    
- 리스크: 늦은 진입/실행 민감도 → execution_stress 케이스 필수
    

### 5.2 direction = range (박스/횡보)

- mean reversion 템플릿 선호
    
- RSI/Stoch 임계 기반 전략 선호(사용자 요구와도 일치)
    
- 스트레스: 레짐 변화(추세 구간)에서 붕괴하는지 확인
    

### 5.3 direction = vol_up / vol_down (변동성)

- vol_up:
    
    - 포지션 사이징 보수(soft): max_position_weight 낮추는 힌트
        
    - stop distance(ATR) 확장 힌트
        
- vol_down:
    
    - 과도한 스탑/트레일은 불리할 수 있어 완화 힌트(soft)
        

### 5.4 macro/policy/earnings

- 특정 이벤트 조건이 있으면:
    
    - 이벤트 전후 기간에 대한 “구간 스트레스” 생성(예: event window)
        
- 단, 이벤트 데이터가 없으면 stress_only로 다운그레이드
    

---

## 6) Constraints Delta 생성(soft-only)

Scenario Integration은 기본적으로 **SOFT 제약만 추가**한다.  
(Constraint Writer(MOD-450)의 “실패 기반 제약”과 성격이 다름)

예) range/mean-reversion 가설:

- `PREFER_FEATURES: [RSI, STOCH]`
    
- `PARAM_HINT: rsi_low in [25,35], stoch_high in [75,90]`
    
- `PREFER_EXIT_STYLE: mean_reversion_exit` (있다면)
    

이 제약들은 MOD-451에서 `prefer`로만 처리되며 block하지 않는다.

---

## 7) Stress Plan 생성(필수)

시나리오를 반영하는 순간, 반드시 “틀릴 때”를 검증해야 한다.

### 7.1 필수 케이스(기본)

- `regime_split` (반대 레짐 포함)
    
- `cost_stress` (보수 비용 프로파일)
    
- `execution_stress` (스프레드/ADV cap 강화)
    

### 7.2 시나리오 반대 조건 케이스

- 시나리오가 “상승”이면:
    
    - 하락/고변동 구간에서의 성능 유지 확인
        
- 시나리오가 “횡보”이면:
    
    - 추세 구간(WFA fold 중 추세 강한 구간)에서 붕괴 확인
        

### 7.3 산출 지표(저장)

- scenario-friendly slice 성과
    
- scenario-adverse slice 성과
    
- `scenario_robustness_gap = friendly_score - adverse_score`
    
    - gap이 크면 “시나리오 의존성” 경고
        

---

## 8) 저장/링킹(KB)

- Document Store(MOD-461):
    
    - `SCENARIO_EVAL_JSON`
        
    - `SCENARIO_INTEGRATION_JSON` (추가 문서 타입 권장)
        
- Local DB(MOD-460 확장):
    
    - `scenario_integrations`:
        
        - scenario_id, run_id, iteration_id, mode, bias_strength, constraints_delta_ref, stress_plan_ref
            

---

## 9) 충돌 처리(Conflict)

- 기존 안전 제약(DATA/EXECUTION/PORTFOLIO HARD)과 충돌하면:
    
    - scenario bias를 약화하거나 관련 선호를 제거
        
- conflict_policy=FAILSAFE_FIRST:
    
    - 안전/실행 현실성 제약이 항상 우선
        
- warnings에 `SCENARIO_BIAS_REDUCED_DUE_TO_CONFLICT` 기록
    

---

## 10) 예외/에러 처리

- `SCENARIO_BLOCKED_BY_GATE`: mode=block
    
- `DATA_NOT_AVAILABLE_FOR_OBSERVABLE`: actionability 감점 → stress_only로 강등
    
- `PREFERENCE_MAPPING_UNKNOWN`: unknown category/direction → generic stress only
    

---

## 11) 테스트 요구사항

- quality 점수에 따라 mode가 정확히 결정되는지
    
- bias_strength cap과 감쇄 규칙이 적용되는지
    
- 추가된 constraints가 모두 SOFT로 생성되는지(절대 block 금지)
    
- stress_plan에 필수 케이스가 항상 포함되는지
    
- conflict 발생 시 bias가 줄고 warning이 기록되는지
    
- scenario_robustness_gap이 계산/저장 가능한 형태로 출력되는지
    

---
