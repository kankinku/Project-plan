## Broker Adapter (주문/체결/상태)

- **문서 ID**: MOD-480
    
- **제목**: Broker Adapter Specification (Orders / Fills / Account State)
    
- **버전**: 1.0
    
- **목표**: 브로커(거래소/증권사)별 API 차이를 숨기고, OMS(MOD-481)가 **동일한 인터페이스**로 주문/취소/조회/체결 스트림/계좌상태를 다룰 수 있게 한다. 또한 실행/체결을 **OBS-510** 규격으로 남겨 Replay(MOD-483) 가능하게 만든다.
    
- **범위**: 공통 인터페이스, 주문 라이프사이클, 체결/상태 스트림 수집, 에러/재시도/레이트리밋, 시간동기/시퀀스, 인증/키관리(인터페이스 수준).
    
- **비범위**: 주문 재시도/아이들포턴시 정책의 총괄(=MOD-481), 리스크 중단(=MOD-482)
    

---

## 1) Adapter 책임(Responsibilities)

1. **주문 API 추상화**: place/replace/cancel/query 공통화
    
2. **이벤트 수집**: fills, order status, positions, balances 스트림(또는 폴링) 수집
    
3. **정규화/매핑**: 브로커 코드(상태/거절사유) → 표준 enum으로 변환
    
4. **신뢰성**: rate limit, 재시도 가능/불가능 구분, 멱등키(외부 clientOrderId) 전달
    
5. **관측 가능성**: 모든 요청/응답/지연/거절을 OBS-510에 남길 수 있게 raw + normalized 제공
    
6. **시간/순서 보장**: event sequence/clock skew 기록, 중복 이벤트 제거 지원
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `BrokerConfig`

```json
{
  "broker_id": "alpaca|ibkr|binance|upbit|paper",
  "mode": "live|paper|sim",
  "credentials_ref": "secrets://broker/main",
  "base_currency": "USD",
  "endpoints": { "rest": "https://...", "ws": "wss://..." },
  "rate_limit": { "max_rps": 5, "burst": 10 },
  "clock": { "use_server_time": true, "max_skew_ms": 2000 }
}
```

### 2.2 입력: `PlaceOrderRequest`

```json
{
  "client_order_id": "run:...:iter:...:oid:000123",
  "symbol": "AAPL",
  "side": "BUY|SELL",
  "type": "MKT|LMT|STOP|STOP_LMT",
  "qty": 100,
  "limit_price": 101.2,
  "stop_price": null,
  "time_in_force": "DAY|GTC|IOC|FOK",
  "reduce_only": false,
  "metadata": {
    "strategy_id": "hash",
    "reason_codes": ["ENTRY_SIGNAL"],
    "ts_intent": "2026-02-06T08:00:00Z"
  }
}
```

### 2.3 출력: `PlaceOrderResponse`

```json
{
  "accepted": true,
  "broker_order_id": "abc123",
  "status": "NEW|REJECTED",
  "reject_reason": null,
  "received_at": "2026-02-06T08:00:00Z",
  "raw": { "broker_payload": "..." }
}
```

### 2.4 스트림 출력: `BrokerEvent`

```json
{
  "event_type": "ORDER_UPDATE|FILL|ACCOUNT_UPDATE|HEARTBEAT",
  "broker_order_id": "abc123",
  "client_order_id": "run:...:oid:000123",
  "symbol": "AAPL",
  "status": "PARTIALLY_FILLED|FILLED|CANCELED|REJECTED",
  "fill": { "qty": 50, "price": 101.18, "fees": 0.12, "ts": "..." },
  "sequence": 991238,
  "ts_exchange": "optional",
  "ts_received": "2026-02-06T08:00:01Z",
  "raw": { "..." }
}
```

---

## 3) 상태(State)

### 3.1 AdapterState

- `connected`: REST/WS 연결 상태
    
- `last_heartbeat_ts`
    
- `last_sequence` (WS 시퀀스)
    
- `clock_skew_ms` (서버시간 대비)
    
- `rate_limit_state` (남은 토큰/리셋 시각)
    
- `subscriptions` (orders/fills/account)
    

### 3.2 OrderMappingState

- `client_order_id ↔ broker_order_id` 매핑 캐시
    
- 최근 N건 매핑 영속화(재시작 복구용, 최소한 docstore/json 또는 DB)
    

---

## 4) 주문 라이프사이클(표준 상태)

브로커별 상태를 아래 표준 enum으로 매핑:

- `NEW` (주문 접수됨)
    
- `REJECTED`
    
- `PARTIALLY_FILLED`
    
- `FILLED`
    
- `CANCELED`
    
- `EXPIRED`
    
- `REPLACED` (지원 시)
    
- `UNKNOWN` (매핑 불가)
    

**필수 규칙**

- `client_order_id`는 OMS가 부여하며 **멱등성 키**로 사용
    
- 동일 `client_order_id`로 place 시:
    
    - 브로커가 멱등 지원: 동일 결과 반환
        
    - 미지원: Adapter가 **query 후** 이미 존재하면 “이미 제출됨”으로 처리(OMS에 알려줌)
        

---

## 5) 기능(Functions)

### 5.1 Connection

- `connect()` / `disconnect()`
    
- `subscribe(streams: ["orders","fills","account"])`
    
- `health_check()` → (connected, latency, skew, rate_limit)
    

### 5.2 Orders

- `place_order(req) -> resp`
    
- `cancel_order(broker_order_id | client_order_id) -> cancel_resp`
    
- `replace_order(...)` (브로커 지원 시, 미지원이면 cancel+place로 에뮬레이션 가능하지만 OMS 정책이 필요)
    
- `get_order(broker_order_id | client_order_id) -> order_state`
    
- `list_open_orders(symbol?)`
    

### 5.3 Account/Positions

- `get_balances()`
    
- `get_positions()`
    
- `get_market_clock()` (거래시간/휴장)
    

---

## 6) 로깅(Observability) — OBS-510 연동

Adapter는 “브로커 I/O”를 OBS-510에 기록할 수 있도록 **표준 로그 이벤트**를 만든다.

### 6.1 Order Request Log (필수)

- time_intent(OMS 생성 시각), time_sent(브로커 호출), time_ack(응답)
    
- client_order_id, broker_order_id, symbol, side, type, qty, prices
    
- status(accepted/rejected), reject_reason, broker_code
    
- latency_ms = ack - sent
    

### 6.2 Fill Log (필수)

- fill_ts(가능하면 exchange), received_ts
    
- price, qty, fees
    
- slippage 계산은 MOD-423/424 영역이지만, **필요 원천 데이터**(decision_price/intent_ts)는 metadata로 전달 가능
    

### 6.3 Health/Telemetry (권장)

- heartbeat 지연, reconnect 횟수
    
- clock_skew_ms
    
- rate_limit hits, backoff 횟수
    

---

## 7) 예외/에러 처리

### 7.1 에러 분류(중요)

- `AUTH_ERROR` (키 만료/권한)
    
- `RATE_LIMIT` (429 등)
    
- `NETWORK_ERROR` (타임아웃, DNS)
    
- `BROKER_REJECT` (주문 거절: 마진부족/시장폐장/가격제한)
    
- `SYMBOL_INVALID`
    
- `DUPLICATE_CLIENT_ORDER_ID`
    
- `STATE_DESYNC` (시퀀스 누락/WS 끊김으로 상태 불일치)
    

### 7.2 재시도 정책(Adapter 레벨)

- Adapter는 “재시도 가능 신호”를 OMS에 제공하되,
    
    - **주문 place 자체를 무조건 재시도하지 않는다** (중복 주문 위험)
        
- 권장:
    
    - REST 호출 타임아웃 발생 시: `get_order(client_order_id)`로 확인 후 재시도 여부 결정
        
    - cancel은 멱등성이 비교적 안전하나, 역시 query 후 처리 권장
        

---

## 8) 시간/순서/중복 처리

- WS 이벤트는 `sequence` 기반으로 정렬/누락 감지
    
- 누락 감지 시:
    
    - `STATE_DESYNC` 발생 → REST로 open orders/positions 재동기화 후 재구독
        
- clock skew:
    
    - `use_server_time=true`면 서버 시간으로 skew 추정
        
    - skew가 `max_skew_ms` 초과 시 WARN(OMS/Risk Guard에 전달)
        

---

## 9) 보안(인터페이스 수준)

- credentials는 코드/로그에 직접 포함 금지
    
- `credentials_ref`로만 전달(실제 비밀 저장은 별도 secrets 레이어)
    
- raw payload 저장 시 민감 필드 제거/마스킹 정책
    

---

## 10) 테스트 요구사항

### 10.1 단위 테스트

- 브로커 상태 → 표준 상태 매핑
    
- reject code 매핑(시장폐장/마진부족 등)
    
- 시퀀스/중복 이벤트 처리(동일 fill 중복 방지)
    

### 10.2 통합 테스트 (Paper/Sim)

- place→partial fill→fill 이벤트 흐름이 OBS-510에 정확히 기록
    
- 네트워크 타임아웃 상황에서 query로 중복 주문 방지 확인
    
- WS 끊김 → 재연결 → REST 재동기화 성공
    

---
