## OMS (Order Management System: 주문관리/재시도/idempotency)

- **문서 ID**: MOD-481
    
- **제목**: OMS Specification (Order Lifecycle, Idempotency, Reconciliation)
    
- **버전**: 1.0
    
- **목표**: 전략 신호(의도)를 “실제 주문/체결”로 안전하게 변환한다. 핵심은 **멱등성(idempotency)**, **상태 정합성(reconciliation)**, **재시도 안전성**, **관측 가능성(OBS-510)** 을 보장하면서 Broker Adapter(MOD-480)를 통해 주문을 관리하는 것이다.
    
- **범위**: 주문 상태머신, 멱등키/클라이언트 주문 ID 정책, 재시도/백오프, 취소/교체, 부분체결, 재동기화, 이벤트 처리, 로그/저장.
    
- **비범위**: 위험 한도/거래중단(=MOD-482), 브로커별 API 차이(=MOD-480)
    

---

## 1) OMS 책임(Responsibilities)

1. **Order Intent → Order**: “주문 의도”를 표준 주문으로 생성/전송
    
2. **Idempotency**: 동일 의도는 중복 주문 없이 동일 결과로 수렴
    
3. **상태머신 관리**: NEW→FILLED 등 주문 라이프사이클을 일관되게 유지
    
4. **이벤트 처리**: Adapter 이벤트(체결/상태변경)를 받아 내부 상태 업데이트
    
5. **재동기화(Reconcile)**: 네트워크/WS 끊김 등으로 상태가 어긋나면 브로커와 재동기화
    
6. **관측/감사**: 모든 주문/체결/오류/재시도를 OBS-510(및 내부 audit)에 남김
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `OrderIntent` (전략/포트폴리오에서 OMS로)

```json
{
  "intent_id": "uuid",
  "run_id": "uuid",
  "strategy_id": "hash",

  "symbol": "AAPL",
  "side": "BUY|SELL",
  "qty": 100,
  "order_type_preference": "MKT|LMT|AUTO",
  "limit_price_hint": 101.2,

  "time_in_force": "DAY|GTC",
  "reduce_only": false,

  "reason_codes": ["ENTRY_SIGNAL", "RSI_LOW", "STOCH_HIGH"],
  "constraints_snapshot_ref": "path/to/constraint_set.json",
  "created_at": "2026-02-06T08:00:00Z"
}
```

### 2.2 출력: `OrderAck`

```json
{
  "intent_id": "uuid",
  "client_order_id": "run:...:intent:...:attempt:0",
  "broker_order_id": "abc123",
  "status": "SUBMITTED|REJECTED",
  "reject_reason": null
}
```

### 2.3 이벤트 처리 입력: `BrokerEvent` (MOD-480)

- ORDER_UPDATE / FILL / ACCOUNT_UPDATE
    

---

## 3) 상태(State)

### 3.1 OrderState (내부)

- `intent_id`
    
- `client_order_id` (멱등키)
    
- `broker_order_id`
    
- `status`:
    
    - `CREATED` (OMS 내부 생성)
        
    - `SUBMITTED` (브로커로 전송 완료)
        
    - `ACKED` (브로커 NEW 확인)
        
    - `PARTIALLY_FILLED`
        
    - `FILLED`
        
    - `CANCEL_REQUESTED`
        
    - `CANCELED`
        
    - `REJECTED`
        
    - `EXPIRED`
        
    - `ERROR` (불명확 상태, 재동기화 필요)
        
- 수량:
    
    - `qty_requested`, `qty_filled`, `qty_remaining`
        
- 가격:
    
    - `avg_fill_price`, last_fill_price
        
- 타임스탬프:
    
    - created_at, sent_at, ack_at, last_update_at
        
- 재시도:
    
    - attempt_count, last_error_code, backoff_until
        

### 3.2 OMSState

- `open_orders_by_symbol`
    
- `intent_dedup_cache` (최근 intent_id → client_order_id)
    
- `reconcile_cursor` (마지막 동기화 시각/시퀀스)
    
- `circuit_breaker` (OMS 레벨: 에러 폭주 시 일시 정지)
    

---

## 4) Idempotency 설계(핵심)

### 4.1 멱등키 생성 규칙

**client_order_id**는 다음을 포함해 “동일 의도는 동일 키”가 되게 한다.

- run_id, strategy_id, intent_id, (optional) intent_hash
    
- attempt 번호는 “동일 client_order_id 재전송”이 위험한 브로커일 경우만 사용
    

권장 v1:

- 기본은 `client_order_id = hash(intent_id + run_id + strategy_id)`
    
- **재전송 시에도 동일 client_order_id 유지** (브로커가 멱등 지원하면 최선)
    
- 멱등 미지원 브로커:
    
    - `place` 타임아웃 시 “query 후 결정”으로 중복 방지 (attempt 증가로 새 주문을 만들지 않음)
        

### 4.2 Dedup 룰

- 동일 `intent_id`가 다시 들어오면:
    
    - 이미 SUBMITTED/ACKED/FILLED 상태면 “기존 주문 상태” 반환
        
    - REJECTED라면, 원인이 “재시도 불가”면 즉시 실패 반환
        
    - 일시 오류(RATE_LIMIT/NETWORK)였다면 reconcile 후 재처리
        

---

## 5) 주문 흐름(Behavior)

### 5.1 Submit Flow

1. `validate_intent()` (기본 유효성: qty>0, symbol valid)
    
2. `apply_execution_constraints()` (MOD-451 스냅샷 기준)
    
3. `build_place_order_request()` (MOD-480 형식으로 변환)
    
4. `adapter.place_order()`
    
5. 응답을 OBS-510에 기록 + 내부 상태 업데이트
    

### 5.2 Event Handling Flow

- adapter 이벤트 수신 시:
    
    1. `match_order(event)` (broker_order_id 또는 client_order_id)
        
    2. `transition_state()`
        
    3. fill이면 `qty_filled`, `avg_fill_price` 갱신
        
    4. OBS-510 fill 로그 기록
        
    5. 포트폴리오/리스크 모듈에 체결 이벤트 발행(내부 bus)
        

---

## 6) 재시도/백오프(Retry & Backoff)

### 6.1 재시도 가능한 에러

- `RATE_LIMIT`
    
- `NETWORK_ERROR`
    
- `TEMP_UNAVAILABLE` (브로커 장애)
    

### 6.2 재시도 불가(즉시 실패)

- `AUTH_ERROR`
    
- `BROKER_REJECT` 중:
    
    - `INSUFFICIENT_FUNDS`
        
    - `MARKET_CLOSED` (정책에 따라 지연 주문으로 바꿀 수도 있지만 v1은 reject)
        
    - `SYMBOL_INVALID`
        

### 6.3 안전한 재시도 원칙

- **place_order는 무조건 재시도 금지**
    
    - 대신: timeout → `get_order(client_order_id)`로 존재 여부 확인 → 존재하면 상태 업데이트, 없으면 “단 한 번만” 재전송(정책)
        
- cancel은 비교적 안전하나:
    
    - cancel timeout → `get_order()`로 취소 여부 확인 후 재요청
        

### 6.4 백오프

- 지수 백오프 + 지터:
    
    - 1s, 2s, 4s, 8s… (max 30s)
        
- backoff 중에는 동일 intent 처리 보류
    

---

## 7) Reconciliation (상태 정합성)

WS 끊김/누락/서버 오류 시 OMS는 다음을 수행:

### 7.1 트리거

- Adapter `STATE_DESYNC`
    
- heartbeat 끊김
    
- 내부 상태가 `ERROR`로 전이
    
- 일정 주기(예: 30~60초) 폴링
    

### 7.2 절차

1. `adapter.list_open_orders()`
    
2. `adapter.get_positions()`
    
3. 내부 open_orders와 비교(diff)
    
4. 누락 주문/체결을 찾아 상태 보정
    
5. 보정 이벤트를 OBS-510에 `RECONCILE_*` reason으로 기록
    

---

## 8) 취소/교체(Cancel/Replace)

- `cancel_intent(intent_id)`:
    
    - 상태가 FILLED면 no-op
        
    - PARTIAL이면 잔량 취소
        
- replace:
    
    - 브로커 지원 시 `replace_order`
        
    - 미지원 시 “cancel+new”는 멱등성을 깨므로 v1에서는 제한(정책으로 허용 가능)
        

---

## 9) 관측(OBS-510) & Audit

OMS는 다음 이벤트를 반드시 기록:

- `ORDER_INTENT_RECEIVED`
    
- `ORDER_SENT`
    
- `ORDER_ACKED` / `ORDER_REJECTED`
    
- `FILL_RECEIVED` (부분/완료)
    
- `CANCEL_REQUESTED` / `CANCELED`
    
- `RECONCILE_STARTED` / `RECONCILE_APPLIED`
    
- `RETRY_SCHEDULED` (code, backoff)
    

각 레코드에:

- run_id, strategy_id, intent_id, client_order_id, broker_order_id
    
- latency, error_code, reason_codes
    

---

## 10) 예외/에러 처리

- `INTENT_INVALID`
    
- `CONSTRAINT_BLOCKED` (MOD-451 결과)
    
- `BROKER_UNREACHABLE`
    
- `ORDER_NOT_FOUND` (reconcile 필요)
    
- `DUPLICATE_EVENT` (중복 fill/order_update)
    

---

## 11) 테스트 요구사항

1. 동일 intent 2회 입력 시 중복 주문 없이 동일 client_order_id로 수렴
    
2. place timeout 상황에서 query 후 중복 방지되는지
    
3. partial fill → cancel 잔량 처리 정합성
    
4. WS 끊김 후 reconcile로 상태가 복구되는지
    
5. 모든 상태 전이가 올바른 OBS-510 레코드를 남기는지
    
6. RATE_LIMIT 발생 시 backoff가 걸리고 과도한 재시도가 없는지
    

---
