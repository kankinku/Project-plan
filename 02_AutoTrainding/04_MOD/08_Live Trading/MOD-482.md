## Risk Guard (거래중단/손실한도/이상징후 탐지)

- **문서 ID**: MOD-482
    
- **제목**: Risk Guard Specification (Circuit Breakers & Anomaly Detection)
    
- **버전**: 1.0
    
- **목표**: 라이브/페이퍼 환경에서 계좌를 보호하기 위해, (1) 손실·노출·레버리지 한도 (2) 실행 품질 붕괴(슬리피지/거절/지연) (3) 시스템 이상(데이터 끊김/시간 불일치) 을 감지하면 **자동 중단/완화**를 수행한다. 또한 중단 사유를 **증거와 함께** 남겨 Replay/Analyzer로 연결한다.
    
- **범위**: 가드 룰(한도/감지), 상태머신(정상/경고/중단), 조치(action), 이벤트/로그, 재개(resume) 정책.
    
- **비범위**: 주문 관리 자체(=MOD-481), 브로커 API(=MOD-480)
    

---

## 1) Risk Guard 책임(Responsibilities)

1. **실시간 리스크 체크**: PnL/낙폭/노출/레버리지/집중도 한도 감시
    
2. **실행 품질 감시**: 슬리피지/거절율/부분체결/지연의 이상 탐지
    
3. **데이터/시스템 감시**: 피드 끊김, 시간 역행, 시퀀스 누락, 상태 불일치
    
4. **조치 수행**: 주문 차단, 포지션 축소, 전체 청산(정책), 거래 중단
    
5. **재개 제어**: 일정 조건 충족 시 자동/수동 재개
    
6. **관측/증거**: OBS-500/510 + Risk 이벤트 로그(별도)로 근거 고정
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `RiskGuardConfig`

```json
{
  "mode": "live|paper",
  "limits": {
    "daily_loss_pct": -0.02,
    "max_drawdown_pct": -0.10,
    "max_gross_exposure_pct": 1.0,
    "max_leverage": 1.0,
    "max_position_weight_pct": 0.10,
    "max_sector_weight_pct": 0.30
  },
  "execution_limits": {
    "slippage_bps_p95": 25,
    "reject_rate_rolling": 0.10,
    "latency_ms_p95": 1500,
    "partial_fill_rate": 0.30
  },
  "data_limits": {
    "max_data_staleness_sec": 10,
    "max_clock_skew_ms": 2000
  },
  "actions": {
    "on_warn": ["throttle_orders", "reduce_size"],
    "on_halt": ["block_new_orders", "cancel_open_orders"],
    "on_critical": ["flatten_positions"]
  },
  "resume": {
    "mode": "manual|auto",
    "cooldown_sec": 600,
    "require_health_ok": true
  }
}
```

### 2.2 입력: `RiskContext` (주기/이벤트 기반)

```json
{
  "ts": "2026-02-06T08:00:00Z",
  "account": {
    "equity": 100000,
    "cash": 50000,
    "gross_exposure": 60000,
    "leverage": 0.6,
    "daily_pnl_pct": -0.015,
    "drawdown_pct": -0.06
  },
  "portfolio": {
    "positions": [{"symbol":"AAPL","weight_pct":0.08}],
    "sector_weights": {"TECH": 0.22}
  },
  "execution": {
    "slippage_bps_p95_5m": 18,
    "reject_rate_5m": 0.04,
    "latency_ms_p95_5m": 900,
    "partial_fill_rate_5m": 0.10
  },
  "system": {
    "data_staleness_sec": 2,
    "clock_skew_ms": 600,
    "adapter_connected": true,
    "sequence_ok": true
  }
}
```

### 2.3 출력: `RiskDecision`

```json
{
  "state": "OK|WARN|HALT|CRITICAL",
  "actions": ["block_new_orders"],
  "reasons": ["DAILY_LOSS_LIMIT_CLOSE"],
  "evidence": [
    { "type":"METRIC", "ref":"account.daily_pnl_pct", "value":-0.021, "threshold":-0.02 }
  ],
  "cooldown_until": "2026-02-06T08:10:00Z"
}
```

---

## 3) 상태(State Machine)

- `OK`: 정상
    
- `WARN`: 경고(완화 조치 가능)
    
- `HALT`: 신규 주문 차단 + 오픈 주문 취소
    
- `CRITICAL`: 포지션 청산(정책) + 완전 중단
    

전이 규칙(권장):

- OK → WARN: 한도 근접(예: 80%) 또는 경미 이상
    
- WARN → HALT: 한도 초과 또는 실행 품질 급락
    
- HALT → CRITICAL: 지속 초과/데이터 붕괴/정합성 오류
    
- HALT/CRITICAL → OK: cooldown + health ok + (manual 승인 또는 auto)
    

---

## 4) 룰 카테고리 & reason_codes

### 4.1 손실/낙폭

- `DAILY_LOSS_LIMIT_BREACH`
    
- `MAX_DRAWDOWN_LIMIT_BREACH`
    

### 4.2 노출/집중도/레버리지

- `GROSS_EXPOSURE_LIMIT_BREACH`
    
- `LEVERAGE_LIMIT_BREACH`
    
- `POSITION_WEIGHT_LIMIT_BREACH`
    
- `SECTOR_WEIGHT_LIMIT_BREACH`
    

### 4.3 실행 품질

- `SLIPPAGE_P95_LIMIT_BREACH`
    
- `REJECT_RATE_LIMIT_BREACH`
    
- `LATENCY_P95_LIMIT_BREACH`
    
- `PARTIAL_FILL_RATE_LIMIT_BREACH`
    

### 4.4 데이터/시스템

- `DATA_STALE`
    
- `CLOCK_SKEW_HIGH`
    
- `ADAPTER_DISCONNECTED`
    
- `SEQUENCE_DESYNC`
    

---

## 5) 룰 평가 방식(Evaluation)

- 주기 평가: 1s~10s(환경에 맞게)
    
- 롤링 윈도우: 5m/15m(실행 품질)
    
- 히스테리시스:
    
    - 한번 HALT면 cooldown 동안 재평가해도 바로 OK 복귀 금지(채터링 방지)
        

---

## 6) 조치(Actions)

### 6.1 throttle_orders

- OMS에 “최대 주문 빈도”를 낮추는 신호
    
- 예: 1초에 1건 → 10초에 1건
    

### 6.2 reduce_size

- 포지션 사이징 계수 곱(예: size_multiplier = 0.5)
    
- 이 조치는 “반드시 로그로” 남김(왜 줄였는지)
    

### 6.3 block_new_orders

- OMS의 submit을 차단(단, reduce_only/exit는 허용 가능)
    
- `allow_exit_orders=true` 옵션 권장
    

### 6.4 cancel_open_orders

- 모든 미체결 주문 취소 요청
    

### 6.5 flatten_positions (CRITICAL)

- 정책에 따라:
    
    - 시장가 청산 or 적극적 지정가+타임아웃 후 시장가
        
- 실행 위험이 커서 **사용자/정책 선택**으로 둔다.
    
- flatten은 반드시 “증거팩” 생성(후속 분석용)
    

---

## 7) 로그/증거(Observability)

### 7.1 Risk Event Log (권장 OBS 확장 또는 별도)

- `RISK_STATE_CHANGED`
    
- `RISK_ACTION_APPLIED`
    
- `RISK_RESUME_ALLOWED/DENIED`
    

필수 필드:

- ts, run_id, state_from/to
    
- reasons[], evidence[]
    
- actions[], cooldown_until
    

### 7.2 OBS 연동

- 신규 주문 차단은 OBS-500에:
    
    - `order_allowed=false`, `reason_codes=["RISK_GUARD_HALT"]`
        
- 취소/청산은 OBS-510에 주문/체결로 남음
    

---

## 8) 재개(Resume) 정책

- `manual`: 사람이 승인해야 OK
    
- `auto`: cooldown 종료 후 health ok면 자동 OK
    
- require_health_ok=true면:
    
    - adapter_connected=true
        
    - data_staleness_sec < limit
        
    - clock_skew_ms < limit
        
    - sequence_ok=true
        

---

## 9) 예외/에러 처리

- `RISK_CONFIG_INVALID`: 한도 값 부정(예: daily_loss_pct>0) → FAILSAFE로 HALT
    
- `METRIC_MISSING`: 필요한 입력 누락 → WARN + 보수적으로 차단 가능(정책)
    
- `ACTION_FAIL`: cancel/flatten 실패 → CRITICAL 유지 + 재시도/알림
    

---

## 10) 테스트 요구사항

1. daily_loss 초과 시 HALT 또는 CRITICAL로 전이되는지
    
2. slippage p95 급등 시 block_new_orders가 실행되는지
    
3. data_stale/adapter_disconnect 시 즉시 HALT 되는지
    
4. cooldown 동안 OK로 복귀하지 않는지(히스테리시스)
    
5. allow_exit_orders=true일 때 청산 주문은 통과하는지
    
6. 모든 전이가 로그/증거를 남기는지
    

---

다음은 Live Trading의 마지막 문서인 **MOD-483 — Replay Engine(실시간 로그 기반 리플레이)** 야.  
“다음”이라고 하면 MOD-483을 작성할게.