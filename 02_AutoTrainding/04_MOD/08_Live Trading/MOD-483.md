## Replay Engine (실시간 로그 기반 리플레이)

- **문서 ID**: MOD-483
    
- **제목**: Replay Engine Specification (Deterministic Playback from Live Logs)
    
- **버전**: 1.0
    
- **목표**: 라이브/페이퍼 트레이딩에서 발생한 의사결정(OBS-500)과 주문/체결(OBS-510), 트레이드 요약(OBS-520), 런 메타(OBS-530), DQ(OBS-540)를 이용해 **그 시점의 시스템을 재현**하고 “왜 그렇게 행동했는지/어디서 깨졌는지”를 분석 가능하게 만든다.
    
- **범위**: 리플레이 입력/출력, 재현성 계약(버전/시드/데이터 스냅샷), 시간축 동기화, 이벤트 재생, 검증(정합성 체크), 결과 아티팩트 생성.
    
- **비범위**: 실패 진단 룰(MOD-441), 제약 생성(MOD-450) — 리플레이는 “근거 제공” 역할
    

---

## 1) Replay Engine 책임(Responsibilities)

1. **로그 기반 재생**: 실제 발생한 이벤트(결정/주문/체결)를 시간순으로 재생
    
2. **결정 재현**: 같은 입력이면 같은 결정을 내렸는지 비교(재현성 검증)
    
3. **상태 복원**: 포트폴리오/주문 상태를 로그로부터 복원하고 정합성 검증
    
4. **드리프트 탐지**: “원래 결정 vs 리플레이 결정” 차이가 나면 drift로 기록
    
5. **리플레이 아티팩트 생성**: 특정 구간/이벤트를 쉽게 분석할 수 있는 패키지 생성
    

---

## 2) 입력/출력(Interface)

### 2.1 입력: `ReplayRequest`

```json
{
  "run_id": "uuid",
  "strategy_id": "hash",

  "time_range": { "start": "2026-02-06T08:00:00Z", "end": "2026-02-06T12:00:00Z" },

  "sources": {
    "obs500_decisions": "path/obs500.jsonl",
    "obs510_orders_fills": "path/obs510.jsonl",
    "obs520_trades": "path/obs520.jsonl",
    "obs530_run_metadata": "path/obs530.json",
    "obs540_dq": "path/obs540.jsonl"
  },

  "replay_mode": {
    "clock": "event_time|received_time",
    "execution": "use_logged_fills|simulate_execution",
    "data": "use_logged_marketdata|reload_snapshot"
  },

  "policy": {
    "strict_determinism": true,
    "tolerance": {
      "price_diff_bps": 1,
      "latency_ms": 500
    }
  }
}
```

### 2.2 출력: `ReplayResponse`

```json
{
  "status": "SUCCESS|PARTIAL|FAILED",
  "run_id": "uuid",
  "strategy_id": "hash",

  "summary": {
    "events_replayed": 12890,
    "drift_events": 3,
    "state_mismatches": 1,
    "first_mismatch_ts": "2026-02-06T09:21:00Z"
  },

  "artifacts": {
    "replay_bundle_dir": "path/replay/",
    "drift_report_path": "path/replay/drift_report.json",
    "state_check_path": "path/replay/state_check.json"
  },

  "warnings": []
}
```

---

## 3) 재현성 계약(Reproducibility Contract)

리플레이가 의미 있으려면 “같은 조건”이 필요하다.

필수:

- `strategy_spec` 해시(MOD-412)
    
- `engine_version`, `model_versions`(OBS-530)
    
- `constraint_set_id` 및 constraints 스냅샷(OBS-530 또는 docstore)
    
- `calc_contract`(SCHEMA-340 기준)
    
- (옵션) market data snapshot id / vendor version
    

리플레이는 시작 시 계약을 검증하고, 누락 시:

- strict=true면 FAILED
    
- 아니면 PARTIAL + warnings
    

---

## 4) 시간축/이벤트 정렬

### 4.1 두 가지 시계

- `event_time`: 실제 발생 시간(거래소/브로커 이벤트 ts)
    
- `received_time`: 시스템이 수신한 시간(지연/재전송 포함)
    

기본 권장:

- 실행/체결 분석은 `received_time`
    
- 전략 의사결정 재현은 `event_time` + “다음 바 실행 규칙” 적용
    

### 4.2 정렬/중복 제거

- obs510 이벤트는 `client_order_id + fill_id(있다면)`로 dedup
    
- 시퀀스/누락 감지:
    
    - 누락 시 구간을 “불완전”으로 표시하고 PARTIAL 처리 가능
        

---

## 5) 재생 모드(Replay Modes)

### 5.1 execution = use_logged_fills (기본)

- 체결은 로그를 “사실”로 사용
    
- 목적: “전략이 이런 주문을 냈고, 체결이 이렇게 났다”를 그대로 재생
    

### 5.2 execution = simulate_execution

- MOD-424 Execution Model로 체결을 재시뮬레이션
    
- 목적: 실행 모델 타당성 검증(로그 체결과의 차이를 측정)
    

### 5.3 data 모드

- use_logged_marketdata:
    
    - 당시 사용한 마켓 데이터가 로그로 남아있을 때(선택 사항)
        
- reload_snapshot:
    
    - 특정 데이터 스냅샷을 다시 로드(추천: snapshot id 고정)
        

---

## 6) 상태 복원(State Reconstruction)

### 6.1 Order Book(내부 주문 상태)

- obs510의 order_update/fill로 주문 상태 머신 복원
    
- OMS 상태와의 불일치 탐지 가능
    

### 6.2 Portfolio State

- fill 이벤트로 포지션/현금 업데이트
    
- 비용/수수료는 로그에 있으면 그대로, 없으면 모델로 추정
    

### 6.3 Decision Consistency

- obs500 “entry_allowed/exit_signal/reason_codes”를 재계산(가능한 경우)
    
- 재계산이 어려우면:
    
    - “비교 불가”로 표시하고 drift 판단 제외
        

---

## 7) Drift 탐지(중요)

drift = 로그의 결정/주문/체결과 리플레이 결과가 “허용 오차”를 넘어 다름.

### 7.1 Drift 유형

- `DECISION_DRIFT`: entry_allowed/exit_signal 차이
    
- `ORDER_DRIFT`: 주문 타입/가격/수량 차이
    
- `FILL_DRIFT`: 평균체결가/체결량/체결시각 차이(시뮬 모드에서)
    
- `STATE_DRIFT`: 포지션/현금 정합성 차이
    

### 7.2 Drift evidence

각 drift 이벤트는 MOD-442 스타일로 evidence pack을 만들 수 있다:

- 해당 시점 obs500/510 레코드 샘플
    
- 관련 metric(슬리피지, 지연)
    
- 구간(range) 표시
    

---

## 8) 정합성 체크(State Checks)

리플레이 종료 시(그리고 주기적으로) 체크:

- 포지션 수량이 음수/불가능 값인지
    
- 현금/마진이 정책 위반인지
    
- open orders가 “고아 상태”인지(주문은 있는데 이벤트가 없음)
    
- fill 합계가 trade 요약(OBS-520)과 맞는지(허용 오차 내)
    

결과는 `state_check.json`에 저장.

---

## 9) 리플레이 아티팩트(Artifacts)

권장 출력:

- `drift_report.json`: drift 목록 + 요약 + top 문제 구간
    
- `state_check.json`: 정합성 체크 결과
    
- `event_timeline.jsonl`: 정렬된 이벤트 타임라인(분석 편의)
    
- `replay_summary.md`: 사람이 읽기 쉬운 요약
    

저장 경로:  
`artifacts/runs/<run_id>/strategies/<strategy_id>/replay/<start>_<end>/...`

---

## 10) 예외/에러 처리

- `SOURCE_MISSING`: 필수 로그 없음 → FAILED 또는 PARTIAL
    
- `TIME_RANGE_EMPTY`: 구간 내 이벤트 없음 → SUCCESS(빈 리플레이) + WARN
    
- `NON_DETERMINISTIC`: 동일 입력인데 결정이 달라짐(시드/버전 문제) → drift 기록 + strict면 FAILED
    
- `PARSE_ERROR`: jsonl 손상 → 해당 라인 스킵 + PARTIAL
    

---

## 11) 테스트 요구사항

1. use_logged_fills 모드에서 포지션/현금이 obs520 요약과 일치
    
2. simulate_execution 모드에서 fill_drift가 계산되고 보고서로 남음
    
3. clock=received_time vs event_time에 따라 타임라인이 달라지는지
    
4. 누락/중복 이벤트를 dedup/표시하고 PARTIAL로 처리하는지
    
5. strict_determinism=true일 때 재현성 계약 누락 시 FAILED 되는지
    

---
