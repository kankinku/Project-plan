## Decision Log Specification (Bar-level Observability)

- **문서 ID**: OBS-500
    
- **제목**: Decision Log Specification (바 단위 의사결정 로그)
    
- **버전**: 1.0
    
- **목표**: “왜 샀는지/왜 안 샀는지/왜 팔았는지”를 **증거(수치+이유코드)** 로 남겨서 실패 원인 분석/재현/개선을 가능하게 한다.
    
- **범위**: backtest/paper/live 공통. 모든 모듈(regime/liquidity/selection/entry/exit/portfolio/execution_gate) 출력의 표준 로그 포맷.
    
- **비범위**: 주문/체결 로그(OBS-510), 트레이드 요약(OBS-520).
    

---

## 1) 로그 단위(Grain) & 생성 타이밍

### 1.1 로그 단위

- **기본 단위**: `(run_id, strategy_id, timestamp, symbol, module_name)` 1행
    
- 즉, 한 바(timestamp)에서 한 종목(symbol) 기준으로 각 모듈이 1개의 로그 레코드를 남긴다.
    

### 1.2 생성 타이밍

- 바가 확정되는 시점(예: 일봉 종가) 또는 이벤트 드리븐 엔진에서는 “평가 시점”
    
- `execution_gate`는 주문 생성 직전(주문 제약 검증 시점)에 기록
    

---

## 2) 핵심 설계 원칙

1. **Explainability**: `reason_codes` + `features_snapshot`은 필수(비어도 존재).
    
2. **Reproducibility**: run/iteration/strategy/data/version/seed 등 메타는 항상 연결 가능해야 함.
    
3. **Compact but sufficient**: 모든 feature 전체를 남기지 않고, “결정 근거”만 남긴다.
    
4. **Module-agnostic**: 공통 필드 + 모듈별 확장 필드.
    

---

## 3) 레코드 스키마(Decision Log Record)

```json
{
  "schema_version": "1.0",

  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",
  "timestamp": "2026-02-06T00:00:00Z",
  "bar_interval": "1d",

  "symbol": "AAPL",
  "module_name": "entry",

  "ok": true,
  "severity": "INFO|WARN|ERROR",

  "decision": {},
  "reason_codes": [],
  "features_snapshot": {},
  "score": {},
  "state_before": {},
  "state_after": {},

  "errors": []
}
```

### 3.1 필수 필드

- `schema_version`
    
- `run_id`, `iteration_id`, `strategy_id`
    
- `timestamp`, `bar_interval`
    
- `symbol`, `module_name`
    
- `ok`
    
- `reason_codes` (배열, 빈 배열 가능)
    
- `features_snapshot` (오브젝트, 빈 오브젝트 가능)
    

### 3.2 권장 필드

- `decision` (모듈별 핵심 결정 결과)
    
- `score` (점수/분해)
    
- `state_before/state_after` (상태 변화가 있을 때만 최소로)
    
- `severity`, `errors`
    

---

## 4) module_name 표준(enum)

- `regime`
    
- `liquidity_gate`
    
- `selection`
    
- `entry`
    
- `exit`
    
- `portfolio`
    
- `execution_gate`
    
- `data_quality` _(선택: 바 단위 DQ 이벤트 로깅용)_
    

---

## 5) 공통 필드 상세

## 5.1 ok / severity

- `ok=true`: 정상 계산/결정
    
- `ok=false`: 모듈 계산 실패 또는 정책상 거래 금지 레벨 오류(예: 타입 불일치)
    
- `severity`
    
    - `INFO`: 정상 또는 단순 불통과
        
    - `WARN`: 성능/품질 경고(예: spread 높음)
        
    - `ERROR`: 실행 불가 수준(예: 데이터 결측이 빈번)
        
    - `CRITICAL`: 런 중단 고려(예: 룩어헤드 탐지)
        

## 5.2 reason_codes

- **필수**: 항상 배열로 존재
    
- 표준: `SCHEMA-330` Reason code 네이밍 규칙 준수
    
- “통과”와 “실패” 둘 다 남길 수 있으나, 기본 정책은:
    
    - **거래를 막은 실패 이유**는 반드시 포함
        
    - 통과 이유는 선택(분석 시 유용하면 포함)
        

## 5.3 features_snapshot

- 결정에 사용된 “핵심 근거 수치”만 기록
    
- 키는 `SCHEMA-300 features` 키 또는 `SCHEMA-310 system var`만 허용
    
- 값은 number/string/bool (중첩 최소화 권장)
    

---

## 6) decision(모듈별 결정 결과 표준)

### 6.1 regime

```json
"decision": {
  "regime_state": "RISK_ON",
  "regime_score": 72
}
```

### 6.2 liquidity_gate

```json
"decision": {
  "is_tradable": true,
  "liquidity_score": 83
}
```

### 6.3 selection

```json
"decision": {
  "selected": true,
  "selection_rank": 12,
  "rs_percentile": 93.1
}
```

### 6.4 entry

```json
"decision": {
  "entry_allowed": true,
  "entry_action": "ENTER|HOLD",
  "entry_signal_id": "AST_ENTRY_1"
}
```

### 6.5 exit

```json
"decision": {
  "exit_allowed": false,
  "exit_signal": "NONE|STOP|TRAIL|TP|REGIME_OFF|TIME_STOP",
  "exit_signal_id": "AST_EXIT_1"
}
```

### 6.6 portfolio

```json
"decision": {
  "target_positions": 10,
  "max_positions": 20,
  "exposure_gross": 0.85,
  "exposure_net": 0.85,
  "violations": []
}
```

### 6.7 execution_gate

```json
"decision": {
  "order_allowed": true,
  "reject_reason": null,
  "order_intent": {
    "side": "BUY",
    "qty": 100,
    "order_type": "MKT",
    "decision_price": 101.0
  }
}
```

---

## 7) score(점수 및 분해: 선택이지만 권장)

Entry/Selection 같은 “점수 기반” 모듈에서 사용.

```json
"score": {
  "value": 78,
  "breakdown": {
    "filter": 20,
    "adx": 14,
    "di": 10,
    "ema_stack": 18,
    "oscillator": 16
  }
}
```

---

## 8) state_before/state_after(상태 스냅샷 최소 규칙)

- 상태는 **변화가 있을 때만** 기록 (로그 폭발 방지)
    
- position 관련 최소 표준 키:
    

```json
"state_before": { "position_qty": 0, "position_avg_price": null, "cash": 100000 },
"state_after":  { "position_qty": 100, "position_avg_price": 101.12, "cash": 89888 }
```

- 포트폴리오 상태는 요약만 기록:
    
    - `exposure_gross`, `exposure_net`, `sector_weights_top3`, `corr_max`
        

---

## 9) errors 포맷(표준)

```json
"errors": [
  { "code": "DATA_MISSING", "message": "rsi_14 is NaN at t", "details": { "feature": "rsi_14" } }
]
```

- `ok=false`면 errors는 1개 이상 존재해야 함
    

---

## 10) 필수 feature_snapshot 추천 목록(모듈별 최소)

> “나중에 원인분해가 가능한 최소 세트”만 적는다.

### 10.1 regime

- `bench_close`, `bench_ma`, `bench_ma_slope`, `vix`(가능 시), `breadth`(가능 시)
    

### 10.2 liquidity_gate

- `avg_vol_60`, `dollar_vol_week`, `spread_bps`, `rvol`, `halted`, `delist_risk`
    

### 10.3 selection

- `rs_percentile`, `sector`, `corr_to_portfolio`, `sector_weight_if_added`
    

### 10.4 entry

- ADX/DI/EMA/RSI/Stoch 중 실제 사용한 것
    
- 변동성/리스크 참고: `atr_pct_14`, `adr_pct_20`, `gap_pct`(가능 시)
    

### 10.5 exit

- `close`, `stop_level`, `trail_level`, `atr_pct_14`, `mfe`, `mae`(가능하면 trade summary로)
    

### 10.6 execution_gate

- `spread_bps`, `adv`, `latency_ms_est`, `max_adv_participation`
    

---

## 11) 샘플 레코드(Entry 모듈 예시)

```json
{
  "schema_version": "1.0",
  "run_id": "run_001",
  "iteration_id": 12,
  "strategy_id": "strat_abc",
  "timestamp": "2026-02-06T00:00:00Z",
  "bar_interval": "1d",
  "symbol": "AAPL",
  "module_name": "entry",
  "ok": true,
  "severity": "INFO",
  "decision": { "entry_allowed": true, "entry_action": "ENTER", "entry_signal_id": "AST_ENTRY_1" },
  "reason_codes": ["FILTER_OK", "ADX_OK", "DI_BULL", "RSI_OVERSOLD", "STOCH_HIGH"],
  "features_snapshot": { "adx_14": 24.1, "di_plus_14": 28.2, "di_minus_14": 16.5, "rsi_14": 29.0, "stoch_k_14_3_3": 83.0 },
  "score": { "value": 78, "breakdown": { "filter": 20, "adx": 14, "di": 10, "oscillator": 34 } },
  "state_before": { "position_qty": 0, "position_avg_price": null },
  "state_after": { "position_qty": 100, "position_avg_price": 101.12 },
  "errors": []
}
```

---

## 12) 저장/성능 정책(권장)

- backtest 탐색 단계에서는:
    
    - `features_snapshot`를 “사용된 feature만” 남기기
        
    - `state_*`는 변화가 있을 때만
        
    - 필요 시 샘플링(예: entry/exit만 full 기록, 나머지 요약)
        
- 검증 단계(2단 백테스트)에서는:
    
    - 전 모듈 full 기록 권장(신뢰도 확보)
        

---

## 13) Validator 요구사항(필수 체크)

1. 필수 필드 누락 시 FAIL
    
2. `module_name` enum 외 값 FAIL
    
3. `reason_codes`는 반드시 배열
    
4. `features_snapshot` 키는 features 또는 허용된 system var만
    
5. `ok=false`이면 `errors.length>=1`
    
6. `timestamp`는 run의 period 범위 내 (가능하면)
    

---

## 14) 다음 문서 연결

- 주문/체결 상세: **OBS-510**
    
- 트레이드 단위 요약: **OBS-520**
    
- DB 저장: `decision_logs` 테이블 스키마(설계 문서)
    

---

다음은 요청대로 **OBS-510**을 작성할게.