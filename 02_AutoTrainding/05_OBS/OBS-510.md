# OBS-510 — Order & Fill Log Specification (주문/체결 로그)

- **문서 ID**: OBS-510
    
- **제목**: Order & Fill Log Specification
    
- **버전**: 1.0
    
- **목표**: 자동매매의 “현실성”을 결정하는 **주문·체결 품질(슬리피지/부분체결/거절/지연)** 을 증거로 남겨, Execution Failure를 재현·분해 가능하게 한다.
    
- **범위**: backtest/paper/live 공통. (백테스트는 “시뮬레이션 체결”도 동일 포맷으로 기록)
    
- **비범위**: 트레이드 단위 결과 요약(OBS-520).
    

---

## 1) 로그 단위(Grain) & 관계

- **Order Log**: 주문 1건당 1레코드
    
- **Fill Log**: 주문 1건에 대해 체결이 N번 발생 가능(부분체결) → **1:N 관계**
    
- 키 관계:
    
    - `order_id`는 Order의 PK
        
    - Fill 레코드는 `order_id`로 연결
        

---

## 2) 핵심 설계 원칙

1. **Decision ↔ Fill 연결**: `decision_price`/`decision_time`을 반드시 저장해 슬리피지를 계산 가능하게 한다.
    
2. **거절/취소도 1급 로그**: “체결이 안 된 이유”가 Execution Failure의 핵심이므로 status/reject_code를 남긴다.
    
3. **비용 분해**: 수수료/추정 스프레드/추정 슬리피지 비용을 분리 저장한다.
    
4. **Idempotent**: 재시도 시 동일 주문 의도는 중복 생성되지 않도록 `client_order_id`를 권장한다.
    

---

## 3) Order Log 스키마 (Order Record)

```json
{
  "schema_version": "1.0",

  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",
  "timestamp_created": "2026-02-06T00:00:01Z",

  "order_id": "brk-or-uuid",
  "client_order_id": "optional-idempotency-key",

  "symbol": "AAPL",
  "side": "BUY|SELL",
  "qty": 100,
  "order_type": "MKT|LMT|STP|STP_LMT",
  "time_in_force": "DAY|GTC|IOC|FOK",

  "decision_time": "2026-02-06T00:00:00Z",
  "decision_price": 101.00,

  "limit_price": null,
  "stop_price": null,

  "constraints": {
    "max_adv_participation": 0.01,
    "max_spread_bps": 10,
    "max_latency_ms": 5000,
    "min_liquidity_score": 60
  },

  "status": "NEW|SENT|PARTIAL|FILLED|CANCELLED|REJECTED|EXPIRED",
  "status_timestamps": {
    "sent_at": "2026-02-06T00:00:01Z",
    "first_fill_at": "2026-02-06T00:00:03Z",
    "done_at": "2026-02-06T00:00:03Z"
  },

  "fill_price_avg": 101.12,
  "filled_qty": 100,

  "slippage": 0.12,
  "slippage_bps": 11.88,

  "latency_ms": 3000,

  "reason_codes": ["EXEC_OK"],
  "reject": null,
  "errors": []
}
```

### 3.1 필수 필드

- `schema_version`
    
- `run_id`, `iteration_id`, `strategy_id`
    
- `timestamp_created`
    
- `order_id`
    
- `symbol`, `side`, `qty`, `order_type`
    
- `decision_time`, `decision_price`
    
- `status`
    
- `reason_codes` (배열, 빈 배열 가능)
    

### 3.2 권장 필드

- `client_order_id`
    
- `constraints`
    
- `status_timestamps`
    
- `fill_price_avg`, `filled_qty`, `latency_ms`
    
- `reject` (거절 시 필수)
    

---

## 4) Fill Log 스키마 (Fill Record)

```json
{
  "schema_version": "1.0",
  "order_id": "brk-or-uuid",

  "fill_id": "auto-increment-or-uuid",
  "fill_time": "2026-02-06T00:00:03Z",

  "qty": 100,
  "price": 101.12,

  "venue": "NYSE|NASDAQ|SIM",
  "liquidity_flag": "maker|taker|unknown",

  "fees": 0.35,
  "estimated_spread_cost": 0.20,
  "estimated_slippage_cost": 0.12
}
```

### 4.1 필수 필드

- `schema_version`, `order_id`, `fill_time`, `qty`, `price`
    

### 4.2 비용 필드 규칙

- backtest에서는 `estimated_*` 기반으로 채움
    
- live에서는 가능한 한 실제 수수료/체결 정보를 사용하되, 스프레드/슬리피지는 추정치 가능
    

---

## 5) 슬리피지 정의(정확히 고정)

### 5.1 정의(부호 포함)

- **가격 슬리피지(absolute)**  
    `slippage = fill_price_avg - decision_price` (BUY 기준)  
    `slippage = decision_price - fill_price_avg` (SELL 기준) _(권장: “항상 불리하면 +”로 저장)_
    

> 즉, **항상 ‘불리한 방향’이면 양수(+)** 가 되도록 통일하는 것을 권장한다.

### 5.2 bps 슬리피지

- `slippage_bps = (slippage / decision_price) * 10,000`
    

### 5.3 decision_price 기준

- decision_price는 “의사결정 시점” 기준 가격
    
    - 예: 종가 신호라면 close[t]
        
    - 체결은 next_bar 정책이면 open[t+1] 또는 모델 체결가
        

---

## 6) status & reject 표준

### 6.1 status enum

- `NEW`: 생성됨(아직 미전송)
    
- `SENT`: 전송됨
    
- `PARTIAL`: 일부 체결
    
- `FILLED`: 전량 체결 완료
    
- `CANCELLED`: 취소됨(사용자/시스템)
    
- `REJECTED`: 거절됨(브로커/규칙)
    
- `EXPIRED`: 만료됨(TIF 등)
    

### 6.2 reject 오브젝트(거절 시 필수)

```json
"reject": {
  "code": "EXEC_SPREAD_TOO_WIDE|EXEC_ADV_CAP|BROKER_REJECT|RISK_GUARD",
  "message": "human-readable short",
  "details": { "spread_bps": 15.2, "max_spread_bps": 10 }
}
```

---

## 7) reason_codes 표준(Execution 관련 최소 세트)

- `EXEC_OK`
    
- `EXEC_PARTIAL`
    
- `EXEC_REJECTED`
    
- `EXEC_SPREAD_TOO_WIDE`
    
- `EXEC_ADV_CAP`
    
- `EXEC_LATENCY_HIGH`
    
- `EXEC_ORDER_TYPE_BLOCKED`
    
- `EXEC_LIQ_SCORE_LOW`
    

> reason code는 SCHEMA-330 규칙대로 관리(사전은 DOC-003).

---

## 8) 주문 의도(order intent)와의 연결(OBS-500 ↔ OBS-510)

- OBS-500 `execution_gate`의 `decision.order_intent`가 **Order Log의 입력 근거**
    
- 최소 연결 키:
    
    - `run_id, strategy_id, symbol, decision_time`
        
    - 권장: `client_order_id`에 `run_id+strategy_id+symbol+timestamp+side` 해시 사용
        

---

## 9) 샘플 시나리오(부분체결 + 최종 완료)

### 9.1 Order

```json
{
  "schema_version":"1.0",
  "run_id":"run_001",
  "iteration_id":12,
  "strategy_id":"strat_abc",
  "timestamp_created":"2026-02-06T00:00:01Z",
  "order_id":"ord_001",
  "client_order_id":"cli_001",
  "symbol":"AAPL",
  "side":"BUY",
  "qty":1000,
  "order_type":"LMT",
  "time_in_force":"DAY",
  "decision_time":"2026-02-06T00:00:00Z",
  "decision_price":101.00,
  "limit_price":101.05,
  "constraints":{"max_adv_participation":0.01,"max_spread_bps":10},
  "status":"PARTIAL",
  "status_timestamps":{"sent_at":"2026-02-06T00:00:01Z","first_fill_at":"2026-02-06T00:00:03Z"},
  "fill_price_avg":101.03,
  "filled_qty":400,
  "slippage":0.03,
  "slippage_bps":2.97,
  "latency_ms":2000,
  "reason_codes":["EXEC_PARTIAL"],
  "reject":null,
  "errors":[]
}
```

### 9.2 Fills

```json
[
  {"schema_version":"1.0","order_id":"ord_001","fill_id":"f1","fill_time":"2026-02-06T00:00:03Z","qty":200,"price":101.02,"venue":"SIM","liquidity_flag":"taker","fees":0.20,"estimated_spread_cost":0.10,"estimated_slippage_cost":0.04},
  {"schema_version":"1.0","order_id":"ord_001","fill_id":"f2","fill_time":"2026-02-06T00:00:05Z","qty":200,"price":101.04,"venue":"SIM","liquidity_flag":"taker","fees":0.20,"estimated_spread_cost":0.10,"estimated_slippage_cost":0.08}
]
```

---

## 10) Validator 요구사항(필수 체크)

1. 필수 필드 누락 시 FAIL
    
2. `qty > 0`, `decision_price > 0`
    
3. `FILLED`면 `filled_qty == qty` (허용오차 정책 가능)
    
4. `PARTIAL`이면 `0 < filled_qty < qty`
    
5. `REJECTED`면 `reject` 오브젝트 필수
    
6. `slippage_bps`는 decision_price가 있을 때만 계산(없으면 null)
    
7. `status_timestamps.sent_at <= first_fill_at <= done_at` (존재하는 값끼리)
    

---

## 11) 다음 문서 연결

- 트레이드 단위 요약: **OBS-520**
    
- Execution 모델/체결 정책: **MOD-424 Execution Model**, **MOD-423 Cost Model**
    
- 실패 분석: `Execution Failure` 카테고리에서 이 로그를 evidence로 사용 (MOD-440/442)
    

---

