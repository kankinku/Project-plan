# OBS-520 — Trade Summary Specification (트레이드 단위 요약)

- **문서 ID**: OBS-520
    
- **제목**: Trade Summary Specification
    
- **버전**: 1.0
    
- **목표**: 개별 트레이드의 진입/청산 이유, MFE/MAE, 비용 분해, 레짐 영향 등을 표준화해 **Exit/Risk/Execution 실패 원인을 트레이드 단위로 증거화**한다.
    
- **범위**: backtest/paper/live 공통. (백테스트는 시뮬레이션 체결 기반으로 생성)
    
- **비범위**: 포트폴리오 전체 지표(=SCHEMA-340), 바 단위 의사결정(=OBS-500), 주문/체결 상세(=OBS-510).
    

---

## 1) 단위(Grain) & 식별자

- 트레이드 1개당 1레코드
    
- **하나의 포지션 라운드트립**(entry → exit)을 기본 트레이드로 정의
    
    - 분할익절/부분청산이 있으면:
        
        - **권장**: 하나의 trade_id 아래 `legs[]`로 기록(부분청산 내역)
            
        - 최소 구현(MVP): 평균 exit_price와 exit_qty로 집계 + legs 생략 가능
            

---

## 2) Trade Record 스키마(표준)

```json
{
  "schema_version": "1.0",

  "run_id": "uuid",
  "iteration_id": 12,
  "strategy_id": "hash",
  "trade_id": "uuid",

  "symbol": "AAPL",
  "direction": "LONG|SHORT",

  "entry": {
    "time": "2026-02-06T00:00:00Z",
    "qty": 100,
    "price": 101.12,
    "order_ids": ["ord_001"],
    "reason_codes": ["FILTER_OK", "ADX_OK", "DI_BULL", "RSI_OVERSOLD", "STOCH_HIGH"],
    "signal_ref": "AST_ENTRY_1",
    "features_snapshot": { "adx_14": 24.1, "rsi_14": 29.0, "stoch_k_14_3_3": 83.0 },
    "regime_state": "RISK_ON",
    "regime_score": 72
  },

  "exit": {
    "time": "2026-02-20T00:00:00Z",
    "qty": 100,
    "price": 109.50,
    "order_ids": ["ord_099"],
    "reason_codes": ["TP_HIT"],
    "signal_ref": "AST_EXIT_1",
    "features_snapshot": { "close": 109.50, "trail_level": 107.30 },
    "regime_state": "NEUTRAL",
    "regime_score": 55
  },

  "pnl": {
    "gross": 838.0,
    "fees": 3.4,
    "estimated_spread_cost": 2.1,
    "estimated_slippage_cost": 8.5,
    "net": 824.0,
    "net_return": 0.0815
  },

  "risk": {
    "hard_stop_level_at_entry": 95.05,
    "trail_type": "atr",
    "trail_mult": 3.0,
    "trail_level_last": 107.30,
    "take_profit_levels": [{ "pct": 0.10, "sell_frac": 0.5 }]
  },

  "excursions": {
    "mfe_price": 112.00,
    "mae_price": 98.50,
    "mfe_return": 0.107,
    "mae_return": -0.026,
    "mfe_time": "2026-02-18T00:00:00Z",
    "mae_time": "2026-02-08T00:00:00Z"
  },

  "holding": {
    "bars_held": 10,
    "days_held": 14
  },

  "quality": {
    "slippage_bps_entry": 8.0,
    "slippage_bps_exit": 10.0,
    "partial_fill": false,
    "latency_ms_entry": 3000,
    "latency_ms_exit": 2500
  },

  "legs": [],
  "tags": ["winner", "trend_capture"],
  "notes": null
}
```

---

## 3) 필수/권장 필드

### 3.1 필수

- `schema_version`
    
- `run_id`, `iteration_id`, `strategy_id`, `trade_id`
    
- `symbol`, `direction`
    
- `entry.time`, `entry.qty`, `entry.price`, `entry.reason_codes`
    
- `exit.time`, `exit.qty`, `exit.price`, `exit.reason_codes` _(오픈 포지션이면 exit는 null 허용 정책 가능)_
    
- `pnl.gross`, `pnl.net` _(비용 모델 포함 여부는 SCHEMA-340 calc_contract로 해석)_
    
- `holding.bars_held`
    

### 3.2 권장

- `order_ids` (OBS-510과 연결)
    
- `signal_ref` (AST ref)
    
- `features_snapshot` (진입/청산 근거 지표)
    
- `risk` (스탑/트레일/익절 레벨)
    
- `excursions` (MFE/MAE)
    
- `quality` (슬리피지/부분체결/지연)
    

---

## 4) PnL/Return 정의(고정)

### 4.1 gross / net

- `gross`: 비용(수수료/스프레드/슬리피지) 제외 PnL
    
- `net`: 비용 포함 PnL
    
    - `net = gross - fees - estimated_spread_cost - estimated_slippage_cost`
        

### 4.2 net_return

- 기본: `net_return = net / (entry_price * entry_qty)`
    
- 레버리지/마진이 있으면 `capital_at_risk` 기반 확장 가능(추후 버전업)
    

---

## 5) MFE/MAE(Excursions) 정의

### 5.1 정의

- LONG 기준:
    
    - `mfe_price`: 보유기간 중 최고가(또는 체결 가능한 가정 가격)
        
    - `mae_price`: 보유기간 중 최저가
        
- `mfe_return = (mfe_price - entry_price) / entry_price`
    
- `mae_return = (mae_price - entry_price) / entry_price`
    
- SHORT은 부호 반대(정의는 “유리/불리 방향”으로 통일 가능)
    

> 권장: LONG/SHORT 모두 **유리하면 +, 불리하면 -**로 정규화해서 저장

---

## 6) risk 레벨 기록 규칙

- `hard_stop_level_at_entry`: 진입 시점 기준 하드스탑 가격
    
- `trail_level_last`: 청산 직전 마지막 트레일 레벨
    
- `take_profit_levels`: 활성화된 익절 레벨(있으면)
    

> Exit Failure 분석에서 “스탑이 너무 타이트/루즈”를 증거로 쓰므로, 최소 1개는 남기는 걸 권장.

---

## 7) legs (부분청산/분할익절) — 선택

부분청산을 구조적으로 남기고 싶으면 `legs[]` 사용.

```json
"legs": [
  {
    "type": "ENTRY|EXIT",
    "time": "2026-02-10T00:00:00Z",
    "qty": 50,
    "price": 106.0,
    "order_id": "ord_010",
    "reason_codes": ["TP_HIT"],
    "fees": 0.2,
    "estimated_spread_cost": 0.1,
    "estimated_slippage_cost": 0.4
  }
]
```

---

## 8) Exit reason_codes 표준(필수 권장)

- `HARD_STOP_HIT`
    
- `TRAIL_HIT`
    
- `TP_HIT`
    
- `REGIME_OFF_EXIT`
    
- `TIME_STOP_EXIT`
    
- `MANUAL_EXIT` _(운영 개입 시)_
    

---

## 9) 샘플 레코드(Stop Loss 트레이드 예시)

```json
{
  "schema_version": "1.0",
  "run_id": "run_001",
  "iteration_id": 12,
  "strategy_id": "strat_abc",
  "trade_id": "t_002",
  "symbol": "AAPL",
  "direction": "LONG",
  "entry": {
    "time": "2026-02-06T00:00:00Z",
    "qty": 100,
    "price": 101.12,
    "order_ids": ["ord_001"],
    "reason_codes": ["FILTER_OK","ADX_OK","DI_BULL"],
    "signal_ref": "AST_ENTRY_1",
    "features_snapshot": {"adx_14":24.1,"di_plus_14":28.2,"di_minus_14":16.5},
    "regime_state": "RISK_ON",
    "regime_score": 72
  },
  "exit": {
    "time": "2026-02-08T00:00:00Z",
    "qty": 100,
    "price": 95.10,
    "order_ids": ["ord_020"],
    "reason_codes": ["HARD_STOP_HIT"],
    "signal_ref": null,
    "features_snapshot": {"close":95.10,"hard_stop_level":95.05,"atr_pct_14":0.02},
    "regime_state": "RISK_OFF",
    "regime_score": 20
  },
  "pnl": {"gross": -602.0, "fees": 3.0, "estimated_spread_cost": 1.8, "estimated_slippage_cost": 6.0, "net": -612.8, "net_return": -0.0606},
  "risk": {"hard_stop_level_at_entry": 95.05, "trail_type": "atr", "trail_mult": 3.0, "trail_level_last": null, "take_profit_levels": []},
  "excursions": {"mfe_price": 102.0, "mae_price": 94.8, "mfe_return": 0.0087, "mae_return": -0.0625, "mfe_time": "2026-02-06T00:00:00Z", "mae_time": "2026-02-08T00:00:00Z"},
  "holding": {"bars_held": 2, "days_held": 2},
  "quality": {"slippage_bps_entry": 8.0, "slippage_bps_exit": 15.0, "partial_fill": false, "latency_ms_entry": 3000, "latency_ms_exit": 4000},
  "legs": [],
  "tags": ["stopout"],
  "notes": null
}
```

---

## 10) Validator 요구사항(필수 체크)

1. entry/exit의 time은 `entry.time <= exit.time`
    
2. `entry.qty > 0`, `entry.price > 0`
    
3. `exit.qty`는 `entry.qty`와 일관(부분청산이면 legs로 설명)
    
4. `pnl.net = pnl.gross - fees - spread - slippage` (허용오차 정책)
    
5. `holding.bars_held`는 time 차이와 bar_interval로부터 계산 가능해야 함(불일치 시 경고)
    
6. `reason_codes`는 빈 배열 금지 권장(최소 1개)
    

---

## 11) 다음 문서 연결

- 포트폴리오 메트릭(승률/손익비/expectancy 등) 계산: **MOD-430**
    
- 실패 분석(Evidence): `trades.*` + reason_codes + excursions로 원인 분해 (**MOD-440/442**)
    
- 주문/체결 상세 연결: `order_ids`로 OBS-510 참조
    

---

